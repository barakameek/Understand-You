<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Alchemy Lab</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Stylesheet -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:,"> <!-- Prevent favicon error -->
</head>
<body>
    <div class="app-container study-theme">

        <!-- === Saving Indicator === -->
        <div id="saveIndicator" class="save-indicator hidden"><i class="fas fa-save"></i> Saving...</div>

        <!-- === Welcome Screen === -->
        <div id="welcomeScreen" class="screen current">
             <h1>Welcome to the Persona Alchemy Lab!</h1>
             <p>Discover Concept Cards that resonate with your essence and curate your unique Persona Tapestry.</p>
             <button id="startGuidedButton" class="button">Begin Experimentation</button>
             <button id="loadButton" class="button secondary-button hidden">Load Previous Session</button> <!-- Added Load Button -->
        </div>

        <!-- === Questionnaire Screen === -->
        <div id="questionnaireScreen" class="screen hidden">
             <header>
                 <div id="elementProgressHeader"></div>
                 <p id="progressText"></p>
                 <div id="dynamicScoreFeedback">
                    Current <span id="feedbackElement">Element</span> Score: <span id="feedbackScore">5.0</span> (<span class="score-label">Moderate</span>)
                    <div class="score-bar-container">
                        <div id="feedbackScoreBar" style="width: 50%;"></div>
                    </div>
                 </div>
             </header>
             <main id="questionContent"></main>
             <footer>
                 <button id="prevElementButton" class="button back-button hidden">Previous</button>
                 <button id="nextElementButton" class="button next-button">Next / View Persona</button>
             </footer>
        </div>

        <!-- === Navigation Bar === -->
        <nav id="mainNavBar" class="main-nav hidden">
             <button class="nav-button active" data-target="personaScreen">Persona Tapestry</button> <!-- Default active -->
             <button class="nav-button" data-target="studyScreen">The Study</button>
             <button class="nav-button" data-target="grimoireScreen">Grimoire (<span id="grimoireCount">0</span>)</button>
             <!-- Settings Button to access Reset -->
             <button id="settingsButton" class="nav-button settings-button" title="Settings"><i class="fas fa-cog"></i></button>
        </nav>

        <!-- === My Persona Screen ("Persona Tapestry") === -->
        <div id="personaScreen" class="screen hidden persona-screen">
             <div class="persona-header">
                 <h1>My Persona Tapestry</h1>
                 <div class="view-toggle-buttons">
                     <button id="showDetailedViewBtn" class="button small-button view-toggle-btn active">Detailed View</button>
                     <button id="showSummaryViewBtn" class="button small-button view-toggle-btn">Summary View</button>
                 </div>
             </div>

             <!-- Detailed View -->
             <div id="personaDetailedView" class="persona-view current">
                 <div class="persona-overview">
                     <div class="persona-elements-detailed">
                         <h2>Core Foundation</h2>
                         <p>Your fundamental attributes. Expand each to understand your score.</p>
                         <div id="personaElementDetails"></div>
                         <hr>
                         <h2>Resources</h2>
                         <p>Gain Insight <i class="fas fa-brain insight-icon"></i> through discovery and reflection. Spend it in The Study.</p>
                         <p>Current Insight: <strong id="userInsightDisplayPersona">0.0</strong> <i class="fas fa-brain insight-icon"></i></p>
                         <hr>
                         <h2>Element Attunement</h2>
                         <p>Grows passively through interaction and reflection.</p>
                         <div id="elementAttunementDisplay"></div>
                     </div>
                     <div class="persona-constellation">
                          <h2>Persona Tapestry - Focus</h2>
                          <p>Curate concepts to shape your active Persona.</p>
                          <div class="tapestry-area" id="tapestryArea">
                               <h4 id="focusedConceptsHeader">Focused Concepts (0 / 5)</h4>
                               <div id="focusedConceptsDisplay" class="focus-concepts-grid"></div>
                          </div>
                          <div id="focusElementalResonance" class="focus-resonance-section">
                               <h3>Focus Resonance</h3>
                               <p>Average elemental scores of your focused concepts.</p>
                               <div id="focusResonanceBars"></div>
                          </div>
                          <div class="tapestry-narrative-section">
                              <h3>Tapestry Narrative</h3>
                              <p id="tapestryNarrative">Mark concepts as "Focus" to generate narrative...</p>
                          </div>
                          <div class="grimoire-insights">
                              <h3>Grimoire Themes</h3>
                              <p>Themes emerging from your focused concepts.</p>
                              <ul id="personaThemesList"></ul>
                          </div>
                          <div class="milestones-section">
                              <h3>Milestones Achieved</h3>
                              <ul id="milestonesDisplay"><li>None yet</li></ul>
                          </div>
                     </div>
                 </div>
             </div>

             <!-- Summary View -->
             <div id="personaSummaryView" class="persona-view hidden">
                  <h2>Persona Summary</h2>
                  <div id="summaryContent">
                      <p>Generating summary...</p>
                      <!-- Content will be injected by JS -->
                  </div>
             </div>
             <!-- Moved Reset button to Settings Popup -->
        </div>


        <!-- === Main Study Screen === -->
        <div id="studyScreen" class="screen hidden study-screen">
             <div class="study-layout-container">
                 <!-- Left Column: Resources & Element Library -->
                 <div class="study-column-left">
                     <div class="study-resources">
                          <h2>Resources & Actions</h2>
                          <p>Current Insight: <strong id="userInsightDisplayStudy">0.0</strong> <i class="fas fa-brain insight-icon"></i></p>
                          <hr>
                          <p>Focus your Insight <i class="fas fa-brain insight-icon"></i> to deepen understanding:</p>
                          <button id="freeResearchButton" class="button free-research-button hidden">Perform Daily Meditation</button>
                          <div id="researchButtonContainer" class="research-buttons"></div>
                          <!-- Add Guided Reflection Button -->
                          <button id="seekGuidanceButton" class="button guidance-button">Seek Guided Reflection (Cost: 3 <i class="fas fa-brain insight-icon"></i>)</button>
                          <hr>
                          <div class="rituals-section">
                              <h3>Daily Rituals</h3>
                              <ul id="dailyRitualsDisplay"><li>Loading...</li></ul>
                          </div>
                     </div>
                     <div id="elementLibrary" class="element-library">
                         <h2>Element Library</h2>
                         <p>Unlock deeper knowledge about each core element.</p>
                         <div id="elementLibraryButtons" class="library-buttons"></div>
                         <div id="elementLibraryContent" class="library-content">
                             <p>Select an Element above to view its deep dive content.</p>
                         </div>
                     </div>
                 </div>
                 <!-- Right Column: Research Bench -->
                 <div class="study-column-right research-bench">
                     <h2>Research Notes</h2>
                     <div id="researchStatus">Select an Element or perform Meditation...</div>
                     <div id="researchOutput" class="research-output-area card-grid">
                        <p><i>Research results will appear here.</i></p>
                     </div>
                 </div>
             </div>
        </div>

         <!-- === Grimoire Screen === -->
         <div id="grimoireScreen" class="screen hidden grimoire-screen">
              <h1>The Grand Grimoire</h1>
              <div id="grimoireControls">
                  <label for="grimoireTypeFilter">Type:</label>
                  <select id="grimoireTypeFilter"><option value="All">All Types</option></select>
                  <label for="grimoireElementFilter">Element:</label>
                  <select id="grimoireElementFilter"><option value="All">All Elements</option></select>
                   <label for="grimoireRarityFilter">Rarity:</label>
                  <select id="grimoireRarityFilter">
                      <option value="All">All Rarities</option>
                      <option value="common">Common</option>
                      <option value="uncommon">Uncommon</option>
                      <option value="rare">Rare</option>
                  </select>
                  <label for="grimoireSortOrder">Sort:</label>
                  <select id="grimoireSortOrder">
                      <option value="discovered">Date Added</option>
                      <option value="name">Name</option>
                      <option value="type">Type</option>
                      <option value="rarity">Rarity</option>
                  </select>
              </div>
              <div id="grimoireContent" class="card-grid"></div>
         </div>


        <!-- === Concept Detail Pop-up === -->
        <div id="conceptDetailPopup" class="popup hidden card-popup">
              <button id="closePopupButton" class="close-button">×</button>
              <div class="popup-header">
                  <span id="popupCardTypeIcon" class="card-type-icon"></span>
                  <h3 id="popupConceptName">Concept Name</h3>
                  <p id="popupConceptType">Card Type</p>
              </div>
              <div class="popup-content">
                  <div id="popupVisualContainer" class="popup-visual">
                      <i id="popupCardVisual" class="card-visual-placeholder fa-solid fa-image"></i>
                  </div>
                  <div class="popup-details">
                      <p id="popupDetailedDescription" class="detailed-description">Detailed description...</p>
                       <hr class="popup-hr">
                      <div class="resonance-summary" id="popupResonanceSummary">Resonance info...</div>
                      <div class="recipe-view">
                          <h4>Resonance Analysis</h4>
                          <div id="popupComparisonHighlights">Highlights...</div>
                          <details class="element-details">
                              <summary>View Full Recipe Comparison</summary>
                              <div class="profile-comparison">
                                  <div class="profile-column"><h5>Concept</h5><div id="popupConceptProfile"></div></div>
                                  <div class="profile-column"><h5>You</h5><div id="popupUserComparisonProfile"></div></div>
                              </div>
                          </details>
                      </div>
                       <hr class="popup-hr">
                      <div id="popupRelatedConcepts" class="related-concepts"><h4>Synergies / Related:</h4><ul id="relatedConceptsList"></ul></div>
                      <!-- ADD "My Notes" section -->
                       <div id="myNotesSection" class="my-notes-section hidden">
                            <hr class="popup-hr">
                           <h4>My Notes</h4>
                           <textarea id="myNotesTextarea" rows="3" placeholder="Add your personal reflections here..."></textarea>
                           <button id="saveMyNoteButton" class="button small-button">Save Note</button>
                           <span id="noteSaveStatus" class="note-status"></span>
                       </div>
                      <div id="popupEvolutionSection" class="evolution-section hidden">
                          <hr class="popup-hr">
                          <h4>Deepen Understanding</h4>
                          <button id="evolveArtButton" class="button small-button evolve-button" disabled>Unlock Enhanced Art (Cost: <span id="evolveCost">?</span>)</button>
                          <p id="evolveEligibility" class="evolve-eligibility-text"></p>
                      </div>
                  </div>
              </div>
              <div class="popup-actions">
                  <button id="addToGrimoireButton" class="button small-button add-grimoire-button">Add to Grimoire</button>
                  <button id="markAsFocusButton" class="button small-button focus-button hidden">Mark as Focus</button>
              </div>
        </div>

         <!-- Research Results Modal IS REMOVED (content goes to Study page) -->

         <!-- === Reflection Prompt Modal === -->
         <div id="reflectionModal" class="popup hidden reflection-modal">
             <button id="closeReflectionModalButton" class="close-button">×</button>
             <h3 id="reflectionModalTitle">Moment for Reflection</h3> <!-- Title can change for Guided -->
             <p>Regarding <strong id="reflectionElement">Element/Concept</strong>:</p>
             <p id="reflectionPromptText" class="prompt-text">Prompt text...</p>
             <div class="reflection-confirm">
                 <input type="checkbox" id="reflectionCheckbox">
                 <label for="reflectionCheckbox">I have taken a moment to reflect on this.</label>
                 <br>
                 <input type="checkbox" id="scoreNudgeCheckbox" class="hidden">
                 <label for="scoreNudgeCheckbox" id="scoreNudgeLabel" class="hidden score-nudge-label">Allow this reflection to potentially nudge your core understanding?</label>
             </div>
             <button id="confirmReflectionButton" class="button small-button" disabled>Confirm Reflection (+<span id="reflectionRewardAmount">?</span>)</button>
         </div>

         <!-- === Settings Popup === -->
         <div id="settingsPopup" class="popup hidden settings-popup">
             <button id="closeSettingsPopupButton" class="close-button">×</button>
             <h3>Settings</h3>
             <div class="settings-content">
                  <p>Manage your session data.</p>
                  <button id="forceSaveButton" class="button small-button">Force Save</button>
                  <button id="resetAppButton" class="button small-button back-button">Reset All Progress</button>
                  <p class="reset-warning"><strong>Warning:</strong> Resetting will erase all scores, discovered concepts, insight, and progress permanently.</p>
             </div>
         </div>

          <!-- === Milestone Alert === -->
         <div id="milestoneAlert" class="milestone-alert hidden">
             <span id="milestoneAlertText">Milestone Reached!</span>
             <button id="closeMilestoneAlertButton">×</button>
         </div>

         <!-- === Temporary Message / Toast Notification === -->
         <div id="toastNotification" class="toast hidden">
             <span id="toastMessage">Message text here</span>
         </div>

         <!-- Overlay for Popups -->
         <div id="popupOverlay" class="overlay hidden"></div>

    </div> <!-- End app-container -->

    <!-- SCRIPTS AT THE END -->
    <script src="data.js"></script>
    <script src="script.js"></script>
</body>
</html>
