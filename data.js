console.log("data.js starting..."); // Log for debugging load order

const elementDetails = {
    "Attraction": {
        name: "Attraction Focus",
        coreQuestion: "Who or What sparks your sexual interest and arousal?",
        coreConcept: "This element defines the primary target, nature, or necessary conditions for your sexual attraction. It goes beyond simple gender orientation to include the importance of presentation, specific dynamics, concepts, objects, situations, or the level of emotional connection required.",
        elaboration: "It encompasses traditional orientations (hetero-, homo-, bi-, pan-) but also acknowledges the Asexuality spectrum (lack of attraction) and Demisexuality (attraction requiring an emotional bond). It includes attractions focused on specific aesthetics, personality types, intellectual connection (Sapiosexuality), power dynamics, or even inanimate objects, materials, or scenarios (often termed fetishes or paraphilias, explored here non-judgmentally).",
        scoreInterpretations: {
            "Very Low": "Suggests very little or no specific sexual attraction (aligns strongly with the Asexuality spectrum). Arousal might be absent, rare, or triggered by non-specific stimuli.",
            "Low": "Indicates less emphasis on specific external targets; attraction might be infrequent, require strong emotional bonds first (Demisexual leaning), or be primarily responsive rather than spontaneous.",
            "Moderate": "Represents a common balance. Attraction might be geared towards familiar cues like gender or presentation, potentially broad (Pansexual leaning without intense focus), or require some connection without it being strictly Demisexual.",
            "High": "Suggests a strong focus or pull towards particular targets. This could be specific gender(s)/presentations, specific dynamics (like intelligence or power), or the beginning of significant focus on specific objects, materials, or situations (fetishistic interests).",
            "Very High": "Indicates a very strong, potentially primary, focus on specific triggers. This could be an intense orientation towards a narrow group, or a central role for specific objects, materials, scenarios, or conceptual dynamics in generating arousal (strong fetishistic or paraphilic focus)."
        },
        examples: "Asexuality, Demisexuality, Heterosexuality, Homosexuality, Bisexuality, Pansexuality, Sapiosexuality, Fetishes (e.g., latex, feet, uniforms), attraction to specific body types, attraction based on D/s roles.",
        personaConnection: "Defines the fundamental 'object' or condition of your sexual desire."
    },
    "Interaction": {
        name: "Interaction Style",
        coreQuestion: "How do you prefer to engage and exchange energy during sexual encounters?",
        coreConcept: "This element describes your preferred behavioral dynamics, roles, and energy flow when interacting sexually with others (or even in solo fantasy).",
        elaboration: "It covers the spectrum from leading to following, the desire for collaboration versus power differentials, and specific energetic expressions like nurturing, service, playfulness, or performance. It's strongly linked to identities like Dominant, Submissive, Switch, Top, Bottom, Caregiver, etc.",
        scoreInterpretations: {
            "Very Low": "Strong preference for yielding control, following explicit direction, serving, or being cared for/guided (Strongly Submissive leaning). Comfort in passivity or receiving.",
            "Low": "General comfort or preference for letting others take the lead, supportive roles, receiving attention/sensation more than directing it (Submissive or Bottom leaning).",
            "Moderate": "Prefers collaborative, egalitarian dynamics with mutual give-and-take. May enjoy switching roles (Switch identity) or find balance in playful, reciprocal exchanges.",
            "High": "Enjoys taking initiative, guiding the encounter, providing sensation/care, or being the center of attention (Dominant, Top, or Caregiver leaning).",
            "Very High": "Strong preference or need to be in control, direct the scenario explicitly, command, or embody a significantly Dominant role. May involve performance or intense focus on the other's response."
        },
        examples: "Dominance/submission (D/s), Master/slave (M/s), Top/Bottom/Versatile roles, Primal play (instinctive interaction), Service dynamics, Exhibitionism/Voyeurism (performance/observation roles), Teacher/student roles, Caregiver/Little dynamics (DDlg, MDlb).",
        personaConnection: "Defines your preferred social and power 'dance' within sexuality."
    },
    "Sensory": {
        name: "Sensory Emphasis",
        coreQuestion: "What physical Feelings are most important or sought after?",
        coreConcept: "This element relates to the significance, type, and intensity of physical sensations in your sexual arousal and fulfillment.",
        elaboration: "It encompasses the full range of senses – touch (light, firm, impact), temperature (hot, cold), texture (smooth, rough), pressure (binding, squeezing), vibration, internal sensations, as well as visual, auditory, and olfactory input. It also includes the spectrum from pure pleasure to the integration of pain or intense sensation (Sadomasochism).",
        scoreInterpretations: {
            "Very Low": "Physical sensation is largely secondary or even unimportant compared to emotional connection, psychological needs, or cognitive engagement. Strong aversion to intense stimuli likely.",
            "Low": "Prefers subtle, gentle, affectionate, or 'vanilla' physical sensations. Comfort, warmth, and light touch may be prioritized. Intense sensations are generally avoided.",
            "Moderate": "Enjoys a broad range of pleasurable physical sensations common in conventional sex. May be open to exploring mild intensity (e.g., light spanking, different textures) but it's not a primary driver.",
            "High": "Actively seeks out distinct, strong, or specific types of physical input as a key part of arousal. This could include impact play, temperature, specific textures (latex, rope), light restriction, or intense pleasure focus.",
            "Very High": "Strongly driven by, or requires, intense, specific, or even extreme physical sensations. This includes significant pain/pleasure play (heavy impact, needles, wax), intense restriction/bondage, sensory overload/deprivation, edge play, or a powerful focus on specific sensory triggers (e.g., specific materials against skin)."
        },
        examples: "Gentle massage, passionate kissing, cuddling, BDSM impact play (flogging, caning), wax play, ice play, rope bondage, Shibari, sensory deprivation hoods, electrostimulation, specific material fetishes (focus on the feel).",
        personaConnection: "Defines how your body interfaces with sexuality and what physical input it craves or avoids."
    },
    "Psychological": {
        name: "Psychological Driver",
        coreQuestion: "Why do you engage with sexuality? What underlying needs does it fulfill?",
        coreConcept: "This element explores the core emotional, psychological, or existential motivations, needs, and states that sexuality helps you access, express, or satisfy.",
        elaboration: "This is about the deeper meaning or purpose behind the act. It includes needs for connection (intimacy, trust, vulnerability, belonging), power dynamics (control, dominance, surrender, objectification), self-expression (creativity, validation, exploration), state change (escape, transcendence, catharsis, stress relief), and comfort (security, care).",
        scoreInterpretations: {
            "Very Low": "Sexuality primarily serves physical functions or simple pleasure/recreation. Deep psychological needs are largely met elsewhere or aren't strongly linked to sex.",
            "Low": "Emotional or psychological aspects are present but secondary. Focus might be on fun, physical release, or light connection without significant depth or weight.",
            "Moderate": "A balanced approach where sexuality often fulfills needs like connection, stress relief, fun, and validation in fairly equal measure, integrated with physical pleasure.",
            "High": "Sexuality is a significant and important channel for fulfilling specific, core psychological needs. These needs (e.g., Intimacy, Power, Validation, Catharsis) are consciously or unconsciously sought through sexual expression.",
            "Very High": "Fulfilling one or more profound psychological needs is the primary driver and purpose of sexual engagement. The experience might feel incomplete or unsatisfying if these deep needs (e.g., total surrender, absolute control, deep vulnerability/trust, transcendental escape) are not met."
        },
        examples: "Using sex primarily for stress relief (Low/Moderate), seeking deep emotional intimacy through partnered sex (High), using BDSM for catharsis or power exchange (High/Very High), seeking validation through performance (High), using intense experiences for transcendence (Very High).",
        personaConnection: "Defines the emotional and motivational core of your sexual expression – its deeper purpose for you."
    },
    "Cognitive": {
        name: "Cognitive Engagement",
        coreQuestion: "How important is the Mind – fantasy, intellect, scenarios – in your arousal?",
        coreConcept: "This element measures the degree and style of mental involvement preferred or required during sexual experiences. It contrasts focus on immediate physical/emotional presence with reliance on imagination, narrative, psychological complexity, or intellectual stimulation.",
        elaboration: "Includes everything from being fully 'in the moment' to elaborate fantasy worlds, scripted role-plays, psychological games, intellectual banter, or focusing on the conceptual meaning of dynamics.",
        scoreInterpretations: {
            "Very Low": "Strong preference for being completely present and embodied. Finds elaborate fantasy, role-play, or complex psychological analysis distracting or uninteresting. Focus is purely on the physical and immediate emotional connection.",
            "Low": "Primarily enjoys the immediate experience. Mental constructs are minimal; perhaps light scenarios or appreciating a partner's mindset, but not reliant on internal narratives.",
            "Moderate": "Appreciates a degree of mental engagement. May enjoy occasional role-play, dirty talk that builds a picture, understanding the psychological dynamic, or using fantasy to enhance arousal, but can also enjoy purely present experiences.",
            "High": "Arousal is significantly enhanced or often triggered by mental elements. This includes enjoying detailed fantasies, specific role-playing scenarios, understanding and playing with psychological power dynamics, or engaging in witty/intellectual sexual banter.",
            "Very High": "Deeply reliant on the mind for arousal and fulfillment. This involves intricate, potentially pre-scripted scenarios, complex world-building in fantasy, intense psychological manipulation or analysis (mind games), or finding the conceptual/intellectual aspect paramount. The mental narrative is the core experience."
        },
        examples: "Mindful sensual touch (Low), enjoying descriptions during dirty talk (Moderate), elaborate D/s protocol scenes (High/Very High), historical or fantasy LARP-style sex (High/Very High), writing/reading erotica focused on complex plots (High/Very High), deep psychological edge play (Very High).",
        personaConnection: "Defines how much and in what way your thoughts, imagination, and intellect participate in your sexuality."
    },
    "Relational": {
        name: "Relational Context",
        coreQuestion: "In what Structure or with whom do you ideally express your sexuality?",
        coreConcept: "This element describes your preferred social structure and context for sexual relationships and expression.",
        elaboration: "It considers the number of partners involved, the desired level of commitment and emotional intimacy, the importance of familiarity versus anonymity, and the preference for dyadic versus group interactions. It covers the spectrum from solitary practice through various forms of monogamy and consensual non-monogamy (CNM).",
        scoreInterpretations: {
            "Very Low": "Strong preference for solitary sexual expression or a deeply bonded, strictly exclusive lifelong partnership (Traditional Monogamy). Discomfort with or disinterest in multiple partners or casual encounters.",
            "Low": "Generally prefers and seeks monogamous, committed relationships as the ideal context for sexual expression. Casual sex is less appealing or infrequent.",
            "Moderate": "Comfortable with committed dyads but potentially open to some flexibility (e.g., swinging in specific contexts, dating casually before commitment) or values deep connection without strict long-term exclusivity. Might be exploring CNM or identify as Solo Poly.",
            "High": "Prefers or actively practices structures involving multiple partners or explicit openness, such as Open Relationships or common forms of Polyamory (hierarchical or not). Values communication around multiple connections.",
            "Very High": "Strong preference for highly fluid, non-traditional structures. May identify with Relationship Anarchy, practice non-hierarchical Polyamory with many partners, enjoy group dynamics, or be comfortable with varying levels of commitment and anonymity across different connections. Rejects rigid rules or default exclusivity."
        },
        examples: "Masturbation (Solitary), Serial Monogamy, Lifelong Monogamy, Friends With Benefits (Casual), Open Relationships, Swinging, Triads/Quads, Hierarchical Polyamory, Egalitarian Polyamory, Solo Polyamory, Relationship Anarchy, Group Sex, Anonymous Encounters.",
        personaConnection: "Defines the preferred social constellation or lack thereof for your sexual life."
    }
};

const concepts = [
    // --- Original Common Concepts --- (~20)
    { id: 1, name: "Vanilla Sex", cardType: "Practice/Kink", visualHandle: "common_vanilla", primaryElement: "S", elementScores: { A: 5, I: 5, S: 3, P: 4, C: 3, R: 4 }, briefDescription: "Conventional sexual activity.", detailedDescription: "Refers to sexual expression generally considered within conventional norms, often focused on penile-vaginal intercourse or mutual masturbation without specific power dynamics, intense sensations, or elaborate scenarios.", relatedIds: [2, 3, 33], rarity: 'common', canUnlockArt: false },
    { id: 2, name: "Sensual Touch", cardType: "Practice/Kink", visualHandle: "common_sensual", primaryElement: "S", elementScores: { A: 4, I: 4, S: 4, P: 5, C: 2, R: 4 }, briefDescription: "Gentle, affectionate touch.", detailedDescription: "Focus on gentle, affectionate, and pleasurable touch, emphasizing connection, warmth, and non-goal-oriented physical intimacy. Can include massage, caressing, holding.", relatedIds: [1, 15, 31, 3], rarity: 'common', canUnlockArt: true, visualHandleUnlocked: "common_sensual_art" },
    { id: 3, name: "Passionate Kissing", cardType: "Practice/Kink", visualHandle: "common_kissing", primaryElement: "S", elementScores: { A: 6, I: 5, S: 5, P: 6, C: 3, R: 5 }, briefDescription: "Intense, emotional kissing.", detailedDescription: "Intense and emotionally charged kissing as a primary form of connection and arousal. Can range from deep and lingering to urgent and demanding.", relatedIds: [1, 2, 15], rarity: 'common', canUnlockArt: false },
    { id: 22, name: "Monogamy", cardType: "Relationship Style", visualHandle: "common_mono", primaryElement: "R", elementScores: { A: 5, I: 5, S: 5, P: 6, C: 5, R: 2 }, briefDescription: "One partner at a time.", detailedDescription: "The practice or preference for having only one sexual and/or romantic partner at a time, often within a committed, exclusive framework.", relatedIds: [23, 15, 29], rarity: 'common', canUnlockArt: true, visualHandleUnlocked: "common_mono_art" },
    { id: 23, name: "Serial Monogamy", cardType: "Relationship Style", visualHandle: "common_serialmono", primaryElement: "R", elementScores: { A: 5, I: 5, S: 5, P: 5, C: 5, R: 3 }, briefDescription: "Sequence of exclusive relationships.", detailedDescription: "The pattern of engaging in sequential monogamous relationships over time, moving from one exclusive partnership to the next.", relatedIds: [22, 24], rarity: 'common', canUnlockArt: false },
    { id: 24, name: "Casual Sex / Hookups", cardType: "Relationship Style", visualHandle: "common_casual", primaryElement: "R", elementScores: { A: 6, I: 4, S: 6, P: 3, C: 3, R: 5 }, briefDescription: "Sex without commitment.", detailedDescription: "Sexual encounters that occur outside of a committed romantic relationship, typically without expectations of long-term connection or deep emotional intimacy.", relatedIds: [23, 26, 35, 56, 65], rarity: 'common', canUnlockArt: false },
    { id: 31, name: "Cuddling / Affection", cardType: "Practice/Kink", visualHandle: "common_cuddle", primaryElement: "P", elementScores: { A: 3, I: 3, S: 3, P: 6, C: 2, R: 4 }, briefDescription: "Non-sexual physical closeness.", detailedDescription: "Sharing physical closeness through hugging, holding, or lying together without explicit sexual intent, focusing on comfort, security, and platonic or romantic affection.", relatedIds: [2, 15, 48, 69, 80], rarity: 'common', canUnlockArt: false },
    { id: 32, name: "Dirty Talk", cardType: "Practice/Kink", visualHandle: "common_dirtytalk", primaryElement: "C", elementScores: { A: 5, I: 6, S: 3, P: 5, C: 7, R: 5 }, briefDescription: "Explicit language during sex.", detailedDescription: "Verbally expressing desires, fantasies, commands, or descriptions of acts during sexual activity to increase arousal and connection. Can be suggestive or highly explicit.", relatedIds: [13, 11, 4, 5, 46, 49, 66, 74], rarity: 'common', canUnlockArt: false },
    { id: 33, name: "Mutual Masturbation", cardType: "Practice/Kink", visualHandle: "common_mutualmast", primaryElement: "I", elementScores: { A: 5, I: 5, S: 6, P: 4, C: 4, R: 5 }, briefDescription: "Partners masturbating together.", detailedDescription: "Two or more partners engaging in simultaneous masturbation, potentially watching or manually stimulating each other to orgasm.", relatedIds: [1, 18, 19, 72], rarity: 'common', canUnlockArt: false },
    { id: 46, name: "Compliments / Praise", cardType: "Practice/Kink", visualHandle: "common_praise", primaryElement: "P", elementScores: { A: 4, I: 5, S: 2, P: 7, C: 4, R: 5 }, briefDescription: "Verbal affirmation during intimacy.", detailedDescription: "Using positive verbal feedback, compliments, or praise related to appearance, performance, or desirability to enhance connection, confidence, and arousal.", relatedIds: [32, 15, 50], rarity: 'common', canUnlockArt: false },
    { id: 47, name: "Eye Contact", cardType: "Practice/Kink", visualHandle: "common_eyecontact", primaryElement: "P", elementScores: { A: 5, I: 6, S: 2, P: 7, C: 3, R: 6 }, briefDescription: "Intense gazing during intimacy.", detailedDescription: "Maintaining direct and often intense eye contact during sexual activity to heighten intimacy, connection, vulnerability, or sometimes power dynamics.", relatedIds: [3, 15], rarity: 'common', canUnlockArt: false },
    { id: 48, name: "Holding Hands", cardType: "Practice/Kink", visualHandle: "common_handholding", primaryElement: "P", elementScores: { A: 3, I: 4, S: 3, P: 5, C: 1, R: 4 }, briefDescription: "Simple physical connection.", detailedDescription: "The simple act of clasping hands, often signifying affection, connection, comfort, or partnership, whether during sexual activity or not.", relatedIds: [2, 31, 77], rarity: 'common', canUnlockArt: false },
    { id: 49, name: "Shared Fantasy Talk", cardType: "Practice/Kink", visualHandle: "common_fantasytalk", primaryElement: "C", elementScores: { A: 5, I: 5, S: 3, P: 6, C: 6, R: 5 }, briefDescription: "Verbally sharing fantasies.", detailedDescription: "Partners verbally describing their sexual fantasies to each other, either as a form of mutual arousal or to build towards potential future play.", relatedIds: [32, 14], rarity: 'common', canUnlockArt: false },
    { id: 50, name: "Validation Seeking", cardType: "Psychological/Goal", visualHandle: "common_validation", primaryElement: "P", elementScores: { A: 5, I: 6, S: 5, P: 7, C: 4, R: 5 }, briefDescription: "Sex motivated by feeling desired.", detailedDescription: "Engaging in sexual activity partly or primarily motivated by the need to feel desired, attractive, skilled, or validated by a partner's reactions or praise.", relatedIds: [18, 46, 91], rarity: 'common', canUnlockArt: false },
    { id: 51, name: "Stress Relief Focus", cardType: "Psychological/Goal", visualHandle: "common_stressrelief", primaryElement: "P", elementScores: { A: 4, I: 4, S: 5, P: 6, C: 3, R: 4 }, briefDescription: "Using sex to unwind/relax.", detailedDescription: "Utilizing sexual activity, including orgasm, primarily as a means to release tension, reduce stress, and achieve a state of relaxation.", relatedIds: [1], rarity: 'common', canUnlockArt: false },
    { id: 52, name: "Heterosexuality", cardType: "Orientation", visualHandle: "common_hetero", primaryElement: "A", elementScores: { A: 7, I: 5, S: 5, P: 5, C: 5, R: 5 }, briefDescription: "Attraction to different gender(s).", detailedDescription: "Sexual and/or romantic attraction primarily to individuals of a different gender identity than one's own.", relatedIds: [53, 54, 55], rarity: 'common', canUnlockArt: false },
    { id: 53, name: "Homosexuality", cardType: "Orientation", visualHandle: "common_homo", primaryElement: "A", elementScores: { A: 7, I: 5, S: 5, P: 5, C: 5, R: 5 }, briefDescription: "Attraction to same gender(s).", detailedDescription: "Sexual and/or romantic attraction primarily to individuals of the same gender identity as one's own.", relatedIds: [52, 54, 55], rarity: 'common', canUnlockArt: false },
    { id: 54, name: "Bisexuality", cardType: "Orientation", visualHandle: "common_bi", primaryElement: "A", elementScores: { A: 6, I: 5, S: 5, P: 5, C: 5, R: 5 }, briefDescription: "Attraction to two or more genders.", detailedDescription: "Sexual and/or romantic attraction to more than one gender identity, potentially including one's own and different genders.", relatedIds: [52, 53, 55], rarity: 'common', canUnlockArt: false },
    { id: 55, name: "Pansexuality", cardType: "Orientation", visualHandle: "common_pan", primaryElement: "A", elementScores: { A: 5, I: 5, S: 5, P: 5, C: 5, R: 5 }, briefDescription: "Attraction regardless of gender.", detailedDescription: "Sexual and/or romantic attraction to individuals regardless of their gender identity or presentation. Attraction may be focused on other qualities.", relatedIds: [52, 53, 54, 103], rarity: 'common', canUnlockArt: false },
    { id: 56, name: "Quickie", cardType: "Practice/Kink", visualHandle: "common_quickie", primaryElement: "I", elementScores: { A: 6, I: 6, S: 6, P: 3, C: 2, R: 4 }, briefDescription: "Brief, often spontaneous sex.", detailedDescription: "A short sexual encounter, often focused on achieving orgasm quickly due to time constraints or a desire for immediate gratification.", relatedIds: [1, 24, 79], rarity: 'common', canUnlockArt: false },
    { id: 66, name: "Foreplay Focus", cardType: "Practice/Kink", visualHandle: "common_foreplay", primaryElement: "I", elementScores: { A: 5, I: 6, S: 5, P: 5, C: 4, R: 5 }, briefDescription: "Emphasis on pre-intercourse intimacy.", detailedDescription: "Placing significant importance on activities leading up to intercourse or the main sexual event, such as kissing, touching, oral sex, or dirty talk, to build arousal and connection.", relatedIds: [1, 2, 3, 32, 67, 83], rarity: 'common', canUnlockArt: false },
    { id: 67, name: "Oral Sex (Giving/Receiving)", cardType: "Practice/Kink", visualHandle: "common_oral", primaryElement: "S", elementScores: { A: 6, I: 6, S: 7, P: 5, C: 3, R: 5 }, briefDescription: "Stimulation with mouth/tongue.", detailedDescription: "Engaging in oral stimulation of a partner's genitals (fellatio, cunnilingus) or other erogenous zones.", relatedIds: [1, 66, 73, 107], rarity: 'common', canUnlockArt: false },
    { id: 68, name: "Romantic Gestures", cardType: "Psychological/Goal", visualHandle: "common_romantic", primaryElement: "P", elementScores: { A: 5, I: 5, S: 3, P: 7, C: 4, R: 6 }, briefDescription: "Expressing love/care non-sexually.", detailedDescription: "Actions taken to express love, affection, or care that are not explicitly sexual but enhance the relationship context, such as gift-giving, date nights, or thoughtful acts.", relatedIds: [15, 22, 31, 76], rarity: 'common', canUnlockArt: false },
    { id: 69, name: "Aftercare (Basic)", cardType: "Practice/Kink", visualHandle: "common_aftercare", primaryElement: "P", elementScores: { A: 4, I: 5, S: 4, P: 6, C: 3, R: 6 }, briefDescription: "Post-sex connection/comfort.", detailedDescription: "Providing comfort, reassurance, and connection immediately following sexual activity, such as cuddling, talking, providing water, or checking in emotionally.", relatedIds: [31, 15, 70, 80], rarity: 'common', canUnlockArt: false },
    { id: 70, name: "Pillow Talk", cardType: "Practice/Kink", visualHandle: "common_pillowtalk", primaryElement: "P", elementScores: { A: 4, I: 4, S: 2, P: 7, C: 4, R: 7 }, briefDescription: "Intimate conversation after sex.", detailedDescription: "Engaging in relaxed, intimate, and often vulnerable conversation with a partner after sexual activity.", relatedIds: [69, 15], rarity: 'common', canUnlockArt: false },
    { id: 71, name: "Shower/Bath Sex", cardType: "Practice/Kink", visualHandle: "common_showersex", primaryElement: "S", elementScores: { A: 5, I: 5, S: 6, P: 4, C: 3, R: 5 }, briefDescription: "Sexual activity in water.", detailedDescription: "Engaging in sexual acts in a shower or bath, often incorporating the sensations of water and steam.", relatedIds: [1], rarity: 'common', canUnlockArt: false },
    { id: 72, name: "Using Sex Toys (Simple)", cardType: "Practice/Kink", visualHandle: "common_toys_simple", primaryElement: "S", elementScores: { A: 5, I: 5, S: 6, P: 4, C: 3, R: 4 }, briefDescription: "Incorporating basic vibrators/dildos.", detailedDescription: "Using common sex toys like simple vibrators or dildos for added stimulation during solo or partnered play.", relatedIds: [1, 33, 73], rarity: 'common', canUnlockArt: false },
    { id: 73, name: "Lubricant Use", cardType: "Practice/Kink", visualHandle: "common_lube", primaryElement: "S", elementScores: { A: 4, I: 4, S: 5, P: 3, C: 2, R: 4 }, briefDescription: "Enhancing comfort/sensation.", detailedDescription: "Using personal lubricants to increase comfort, reduce friction, or enhance sensation during various sexual activities.", relatedIds: [1, 67, 72], rarity: 'common', canUnlockArt: false },
    { id: 74, name: "Flirting / Banter", cardType: "Interaction", visualHandle: "common_flirt", primaryElement: "I", elementScores: { A: 6, I: 7, S: 3, P: 5, C: 6, R: 5 }, briefDescription: "Playful, suggestive communication.", detailedDescription: "Engaging in lighthearted, often witty or suggestive conversation aimed at building attraction and rapport.", relatedIds: [32, 60, 75], rarity: 'common', canUnlockArt: false },
    { id: 75, name: "Shared Humor", cardType: "Psychological/Goal", visualHandle: "common_humor", primaryElement: "P", elementScores: { A: 5, I: 6, S: 2, P: 6, C: 5, R: 6 }, briefDescription: "Finding connection through laughter.", detailedDescription: "Valuing and enjoying shared laughter and humor within intimate interactions as a way to build connection and ease tension.", relatedIds: [74, 15], rarity: 'common', canUnlockArt: false },
    { id: 76, name: "Date Nights", cardType: "Relationship Style", visualHandle: "common_datenight", primaryElement: "R", elementScores: { A: 4, I: 5, S: 4, P: 6, C: 4, R: 5 }, briefDescription: "Dedicated time for connection.", detailedDescription: "Setting aside specific time for shared activities aimed at fostering connection and intimacy within a relationship, which may or may not lead to sex.", relatedIds: [68, 15, 22], rarity: 'common', canUnlockArt: false },
    { id: 77, name: "Public Display Affection (Mild)", cardType: "Practice/Kink", visualHandle: "common_pda", primaryElement: "R", elementScores: { A: 4, I: 5, S: 3, P: 5, C: 2, R: 5 }, briefDescription: "Holding hands, brief kisses in public.", detailedDescription: "Showing affection to a partner in public spaces through generally acceptable gestures like holding hands, brief kisses, or an arm around the shoulder.", relatedIds: [48, 3, 78], rarity: 'common', canUnlockArt: false },
    { id: 79, name: "Spontaneity Seeker", cardType: "Psychological/Goal", visualHandle: "common_spontaneity", primaryElement: "P", elementScores: { A: 6, I: 6, S: 6, P: 5, C: 3, R: 5 }, briefDescription: "Enjoying unplanned encounters.", detailedDescription: "Deriving particular enjoyment from unexpected or spontaneous sexual encounters or expressions of desire.", relatedIds: [56, 24], rarity: 'common', canUnlockArt: false },
    { id: 80, name: "Comfort Seeker", cardType: "Psychological/Goal", visualHandle: "common_comfort", primaryElement: "P", elementScores: { A: 3, I: 3, S: 4, P: 7, C: 2, R: 4 }, briefDescription: "Using intimacy for security/soothing.", detailedDescription: "Primarily seeking physical closeness and intimacy (not necessarily orgasm) for feelings of safety, security, and emotional soothing.", relatedIds: [31, 2, 69], rarity: 'common', canUnlockArt: false },
    { id: 81, name: "Attraction to Confidence", cardType: "Orientation", visualHandle: "common_attr_conf", primaryElement: "A", elementScores: { A: 7, I: 6, S: 4, P: 6, C: 5, R: 5 }, briefDescription: "Finding self-assuredness attractive.", detailedDescription: "Being primarily attracted to individuals who exhibit strong self-confidence, assertiveness, or a commanding presence.", relatedIds: [4, 60], rarity: 'common', canUnlockArt: false },
    { id: 82, name: "Attraction to Kindness", cardType: "Orientation", visualHandle: "common_attr_kind", primaryElement: "A", elementScores: { A: 5, I: 4, S: 4, P: 7, C: 4, R: 6 }, briefDescription: "Finding compassion/empathy attractive.", detailedDescription: "Being primarily attracted to individuals who exhibit kindness, empathy, compassion, and nurturing qualities.", relatedIds: [15, 58], rarity: 'common', canUnlockArt: false },
    { id: 83, name: "Slow Burn", cardType: "Practice/Kink", visualHandle: "common_slowburn", primaryElement: "P", elementScores: { A: 5, I: 5, S: 5, P: 7, C: 5, R: 6 }, briefDescription: "Gradual build-up of intimacy/arousal.", detailedDescription: "Preferring a gradual, extended build-up of emotional intimacy and sexual tension over time or within an encounter, rather than immediate gratification.", relatedIds: [15, 66, 38], rarity: 'common', canUnlockArt: false },
    { id: 85, name: "Make-up Sex", cardType: "Psychological/Goal", visualHandle: "common_makeupsex", primaryElement: "P", elementScores: { A: 6, I: 6, S: 6, P: 7, C: 3, R: 5 }, briefDescription: "Sex after conflict resolution.", detailedDescription: "Engaging in sexual activity following an argument or conflict, often characterized by heightened emotions and a sense of reconciliation.", relatedIds: [3], rarity: 'common', canUnlockArt: false },

    // --- Original Uncommon Concepts --- (~25 + reclassified = ~30)
    { id: 4, name: "Dominance (Psychological)", cardType: "Identity/Role", visualHandle: "uncommon_dom", primaryElement: "I", elementScores: { A: 6, I: 9, S: 5, P: 8, C: 7, R: 6 }, briefDescription: "Taking psychological control.", detailedDescription: "Focuses on the mental and emotional aspects of control within a dynamic, potentially involving commands, tasks, setting rules, or managing a partner's experience.", relatedIds: [5, 6, 11, 30, 38, 81, 89, 90, 100, 104, 109, 123], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_dom_art" },
    { id: 5, name: "Submission (Psychological)", cardType: "Identity/Role", visualHandle: "uncommon_sub", primaryElement: "I", elementScores: { A: 6, I: 1, S: 5, P: 8, C: 5, R: 6 }, briefDescription: "Yielding psychological control.", detailedDescription: "Focuses on the mental and emotional aspects of yielding control, finding pleasure or fulfillment in obedience, service, following directions, or surrendering decisions.", relatedIds: [4, 6, 17, 10, 12, 37, 39, 58, 61, 63, 87, 91, 98, 99, 109, 119, 123], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_sub_art" },
    { id: 6, name: "Switching", cardType: "Identity/Role", visualHandle: "uncommon_switch", primaryElement: "I", elementScores: { A: 6, I: 5, S: 6, P: 7, C: 6, R: 6 }, briefDescription: "Moving between D/s roles.", detailedDescription: "Describes the ability and desire to fluidly shift between dominant and submissive roles or energies within sexual encounters, enjoying aspects of both leading and following.", relatedIds: [4, 5], rarity: 'uncommon', canUnlockArt: false },
    { id: 7, name: "Impact Play (Light)", cardType: "Practice/Kink", visualHandle: "uncommon_impact_light", primaryElement: "S", elementScores: { A: 5, I: 6, S: 6, P: 5, C: 4, R: 5 }, briefDescription: "Spanking, light slapping/flogging.", detailedDescription: "Involves activities like spanking, slapping, or using paddles/floggers lightly, primarily for pleasurable stinging sensations or rhythmic input rather than intense pain.", relatedIds: [8, 9, 4, 5, 40, 57, 93, 96], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_impact_light_art" },
    { id: 10, name: "Service Submission", cardType: "Psychological/Goal", visualHandle: "uncommon_service", primaryElement: "I", elementScores: { A: 5, I: 2, S: 4, P: 7, C: 4, R: 6 }, briefDescription: "Pleasure from serving a partner.", detailedDescription: "A form of submission focused on deriving pleasure and fulfillment from performing acts of service for a partner, which may be sexual or non-sexual within a dynamic.", relatedIds: [5, 4, 11, 58, 61, 98, 109], rarity: 'uncommon', canUnlockArt: false },
    { id: 13, name: "Role-Playing (Scenario)", cardType: "Practice/Kink", visualHandle: "uncommon_roleplay", primaryElement: "C", elementScores: { A: 6, I: 6, S: 5, P: 6, C: 8, R: 6 }, briefDescription: "Adopting characters/personas.", detailedDescription: "Involves adopting specific character archetypes (e.g., doctor/patient, teacher/student, captor/captive) or personas to create a narrative framework for sexual interaction.", relatedIds: [14, 30, 21, 39, 64, 92, 98, 101, 117, 121, 43], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_roleplay_art" },
    { id: 15, name: "Deep Emotional Intimacy", cardType: "Psychological/Goal", visualHandle: "uncommon_intimacy", primaryElement: "P", elementScores: { A: 7, I: 5, S: 4, P: 9, C: 5, R: 7 }, briefDescription: "Seeking profound connection.", detailedDescription: "Places a high value on using sexual expression as a way to build and deepen emotional connection, trust, vulnerability, and mutual understanding.", relatedIds: [2, 3, 22, 29, 47, 58, 68, 70, 75, 76, 82, 83, 123, 59], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_intimacy_art" },
    { id: 18, name: "Exhibitionism", cardType: "Identity/Role", visualHandle: "uncommon_exhibit", primaryElement: "I", elementScores: { A: 6, I: 7, S: 5, P: 7, C: 6, R: 5 }, briefDescription: "Pleasure from being watched.", detailedDescription: "Finding sexual arousal and pleasure in the act of being watched by others during sexual activity, potentially involving performance or revealing oneself.", relatedIds: [19, 12, 34, 50, 78, 90, 91, 105, 33], rarity: 'uncommon', canUnlockArt: false },
    { id: 19, name: "Voyeurism", cardType: "Identity/Role", visualHandle: "uncommon_voyeur", primaryElement: "A", elementScores: { A: 7, I: 2, S: 3, P: 6, C: 5, R: 3 }, briefDescription: "Pleasure from watching others.", detailedDescription: "Finding sexual arousal and pleasure primarily from the act of watching others engage in sexual activity, often without their knowledge (consensual voyeurism involves negotiated watching).", relatedIds: [18, 12, 34, 105, 118, 33], rarity: 'uncommon', canUnlockArt: false },
    { id: 26, name: "Open Relationship", cardType: "Relationship Style", visualHandle: "uncommon_openrel", primaryElement: "R", elementScores: { A: 6, I: 5, S: 6, P: 5, C: 5, R: 7 }, briefDescription: "Primary couple + outside sex.", detailedDescription: "A relationship structure, typically involving a primary couple, where partners agree that one or both may have sexual relationships with other people, often with rules about emotional involvement.", relatedIds: [24, 25, 27, 35], rarity: 'uncommon', canUnlockArt: false },
    { id: 28, name: "Asexuality", cardType: "Orientation", visualHandle: "uncommon_ace", primaryElement: "A", elementScores: { A: 0, I: 3, S: 2, P: 3, C: 3, R: 4 }, briefDescription: "Little or no sexual attraction.", detailedDescription: "Characterized by a persistent lack of sexual attraction towards any gender. Asexual individuals may still experience romantic attraction, desire intimacy, or engage in sexual activity for various reasons.", relatedIds: [29, 36], rarity: 'uncommon', canUnlockArt: false },
    { id: 29, name: "Demisexuality", cardType: "Orientation", visualHandle: "uncommon_demi", primaryElement: "A", elementScores: { A: 3, I: 4, S: 4, P: 8, C: 5, R: 5 }, briefDescription: "Attraction requires emotional bond.", detailedDescription: "A sexual orientation where an individual only develops sexual attraction after forming a strong emotional connection with someone.", relatedIds: [15, 28, 22, 14], rarity: 'uncommon', canUnlockArt: false },
    { id: 34, name: "Group Sex", cardType: "Practice/Kink", visualHandle: "uncommon_group", primaryElement: "R", elementScores: { A: 6, I: 6, S: 7, P: 5, C: 4, R: 8 }, briefDescription: "Sex involving 3+ people.", detailedDescription: "Engaging in sexual acts with three or more people simultaneously. Dynamics can vary widely from casual encounters to structured orgies or polyamorous group play.", relatedIds: [18, 19, 25, 26, 27, 35, 65, 105], rarity: 'uncommon', canUnlockArt: false },
    { id: 35, name: "Swinging", cardType: "Relationship Style", visualHandle: "uncommon_swing", primaryElement: "R", elementScores: { A: 5, I: 5, S: 6, P: 4, C: 4, R: 7 }, briefDescription: "Couples swapping partners for sex.", detailedDescription: "A lifestyle where committed couples consensually engage in sexual activities with other couples or individuals, often at parties or planned events, typically with an emphasis on recreational sex over deep emotional connection with outside partners.", relatedIds: [26, 24, 34], rarity: 'uncommon', canUnlockArt: false },
    { id: 36, name: "Aromanticism", cardType: "Orientation", visualHandle: "uncommon_aro", primaryElement: "A", elementScores: { A: 2, I: 3, S: 3, P: 4, C: 4, R: 3 }, briefDescription: "Little or no romantic attraction.", detailedDescription: "Characterized by a lack of romantic attraction. Aromantic individuals may still experience sexual attraction (allosexual) or not (aro/ace), and may desire platonic partnerships or other relationship structures.", relatedIds: [28, 27, 59], rarity: 'uncommon', canUnlockArt: false },
    { id: 37, name: "Sensory Deprivation (Light)", cardType: "Practice/Kink", visualHandle: "uncommon_sensdep", primaryElement: "S", elementScores: { A: 4, I: 3, S: 7, P: 6, C: 5, R: 5 }, briefDescription: "Reducing sight/sound (blindfolds).", detailedDescription: "Using blindfolds, hoods, earplugs, or other methods to significantly reduce or eliminate one or more senses, often heightening remaining senses, increasing vulnerability, or creating a specific psychological state. Light deprivation focuses on temporary reduction.", relatedIds: [9, 17, 5, 57, 44, 86, 124], rarity: 'uncommon', canUnlockArt: false },
    { id: 38, name: "Teasing & Denial", cardType: "Practice/Kink", visualHandle: "uncommon_denial", primaryElement: "P", elementScores: { A: 6, I: 7, S: 7, P: 8, C: 7, R: 6 }, briefDescription: "Building arousal, withholding orgasm.", detailedDescription: "A form of psychological play and power exchange where one partner intentionally builds the other's arousal close to orgasm but repeatedly denies release, often increasing desperation and reinforcing control dynamics.", relatedIds: [4, 5, 11, 9, 44, 83, 93, 119, 30, 45, 106], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_denial_art" },
    { id: 39, name: "Age Play", cardType: "Practice/Kink", visualHandle: "uncommon_ageplay", primaryElement: "C", elementScores: { A: 5, I: 6, S: 4, P: 7, C: 8, R: 6 }, briefDescription: "Role-playing different ages.", detailedDescription: "Consensual role-playing where participants adopt personas and behaviors associated with ages different from their own (e.g., caregiver/little, teacher/student). Focus is typically on the dynamic and psychological state, not actual age differences.", relatedIds: [13, 4, 5, 10, 58, 92, 98], rarity: 'uncommon', canUnlockArt: false },
    { id: 40, name: "Primal Play", cardType: "Practice/Kink", visualHandle: "uncommon_primal", primaryElement: "I", elementScores: { A: 5, I: 8, S: 7, P: 6, C: 3, R: 5 }, briefDescription: "Instinctive, animalistic interaction.", detailedDescription: "A style of play involving raw, instinctive, and often non-verbal interaction, tapping into animalistic urges like chasing, biting, growling, nuzzling, or struggling. Can range from playful to intense.", relatedIds: [4, 5, 9, 7, 8, 97], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_primal_art"},
    { id: 57, name: "Sensory Enhancement", cardType: "Practice/Kink", visualHandle: "uncommon_sensenh", primaryElement: "S", elementScores: { A: 4, I: 5, S: 7, P: 5, C: 4, R: 5}, briefDescription: "Heightening specific senses.", detailedDescription: "Using techniques or tools (like feathers, ice, vibration, specific sounds/scents) specifically to amplify or focus on particular sensory inputs, often after a period of deprivation or contrast.", relatedIds: [2, 37, 7, 9, 86, 88, 102, 112], rarity: 'uncommon', canUnlockArt: false },
    { id: 58, name: "Caregiver/Little Dynamics", cardType: "Psychological/Goal", visualHandle: "uncommon_cgl", primaryElement: "P", elementScores: { A: 5, I: 7, S: 4, P: 8, C: 6, R: 7 }, briefDescription: "Nurturing/dependent role-play.", detailedDescription: "A dynamic, often linked with Age Play, involving one partner taking on a nurturing, authoritative Caregiver role (DD/lg, MD/lb, etc.) and the other adopting a more dependent, vulnerable Little role.", relatedIds: [39, 4, 5, 10, 15, 82], rarity: 'uncommon', canUnlockArt: false },
    { id: 59, name: "Platonic Partnership / QPR", cardType: "Relationship Style", visualHandle: "uncommon_qpr", primaryElement: "R", elementScores: { A: 3, I: 4, S: 3, P: 7, C: 5, R: 6 }, briefDescription: "Deep non-romantic commitment.", detailedDescription: "Queerplatonic Relationships (QPRs) or other committed platonic partnerships involve a deep bond, commitment, and intimacy that transcends typical friendship norms but is not inherently romantic or sexual.", relatedIds: [22, 36, 15, 27, 25], rarity: 'uncommon', canUnlockArt: false },
    { id: 60, name: "Sapiosexuality", cardType: "Orientation", visualHandle: "uncommon_sapio", primaryElement: "A", elementScores: { A: 7, I: 5, S: 3, P: 6, C: 8, R: 5 }, briefDescription: "Attraction to intelligence.", detailedDescription: "Finding intelligence to be the most sexually attractive feature in a person, potentially outweighing physical appearance or other factors.", relatedIds: [49, 74, 81], rarity: 'uncommon', canUnlockArt: false },
    { id: 61, name: "Body Worship", cardType: "Practice/Kink", visualHandle: "uncommon_bodyworship", primaryElement: "P", elementScores: { A: 6, I: 4, S: 6, P: 8, C: 3, R: 6 }, briefDescription: "Reverential focus on partner's body.", detailedDescription: "Expressing adoration or reverence for a partner's body through acts like kissing, licking, massaging, or simply admiring specific parts, often within a power exchange dynamic.", relatedIds: [5, 10, 12, 62, 102], rarity: 'uncommon', canUnlockArt: false },
    { id: 62, name: "Foot Fetish / Podophilia", cardType: "Orientation", visualHandle: "uncommon_footfetish", primaryElement: "A", elementScores: { A: 8, I: 4, S: 7, P: 5, C: 3, R: 4 }, briefDescription: "Sexual interest focused on feet.", detailedDescription: "A specific paraphilia involving sexual arousal derived from feet. This can include kissing, licking, massaging, or incorporating feet into other sexual acts.", relatedIds: [61, 12, 102], rarity: 'uncommon', canUnlockArt: false },
    { id: 78, name: "Public Display Affection (Moderate)", cardType: "Practice/Kink", visualHandle: "uncommon_pda_mod", primaryElement: "R", elementScores: { A: 5, I: 6, S: 4, P: 6, C: 3, R: 6 }, briefDescription: "Making out, groping in semi-public.", detailedDescription: "Engaging in more overt displays of affection or arousal in public or semi-public spaces, potentially pushing social boundaries.", relatedIds: [77, 18], rarity: 'uncommon', canUnlockArt: false },
    { id: 84, name: "Solo Polyamory", cardType: "Relationship Style", visualHandle: "uncommon_solopoly", primaryElement: "R", elementScores: { A: 5, I: 5, S: 5, P: 6, C: 6, R: 7 }, briefDescription: "Multiple partners, maintains independence.", detailedDescription: "Practicing polyamory while choosing to live independently and prioritize personal autonomy, not necessarily seeking primary-style partnerships or cohabitation.", relatedIds: [25, 27, 24], rarity: 'uncommon', canUnlockArt: false },
    { id: 86, name: "Sensory Overload", cardType: "Practice/Kink", visualHandle: "uncommon_sens_overload", primaryElement: "S", elementScores: { A: 5, I: 6, S: 8, P: 6, C: 4, R: 5 }, briefDescription: "Intentionally overwhelming senses.", detailedDescription: "Simultaneously applying multiple strong sensory inputs (touch, sound, sight, etc.) to overwhelm the senses, potentially leading to altered states or intense reactions.", relatedIds: [37, 57, 8, 124], rarity: 'uncommon', canUnlockArt: false },
    { id: 87, name: "Light Bondage (Cuffs/Silk)", cardType: "Practice/Kink", visualHandle: "uncommon_bond_light", primaryElement: "S", elementScores: { A: 5, I: 5, S: 6, P: 6, C: 4, R: 5 }, briefDescription: "Using simple restraints.", detailedDescription: "Using simple restraints like handcuffs, fuzzy cuffs, or silk scarves for playful restriction or temporary immobilization, emphasizing sensation and light power exchange.", relatedIds: [16, 17, 5, 93], rarity: 'uncommon', canUnlockArt: false },
    { id: 88, name: "Temperature Play (Wax/Ice)", cardType: "Practice/Kink", visualHandle: "uncommon_temp_play", primaryElement: "S", elementScores: { A: 5, I: 6, S: 7, P: 6, C: 3, R: 5 }, briefDescription: "Using heat/cold for sensation.", detailedDescription: "Using safe temperature variations, like low-temperature wax or ice cubes, on the skin to create contrasting and intense sensations.", relatedIds: [9, 57], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_temp_play_art" },
    { id: 89, name: "Power Play (Subtle)", cardType: "Psychological/Goal", visualHandle: "uncommon_power_subtle", primaryElement: "P", elementScores: { A: 6, I: 7, S: 5, P: 7, C: 7, R: 6 }, briefDescription: "Enjoying implicit power dynamics.", detailedDescription: "Finding arousal or satisfaction in the subtle negotiation and expression of power within an interaction, without necessarily adopting explicit D/s roles or commands.", relatedIds: [4, 5, 11, 90], rarity: 'uncommon', canUnlockArt: false },
    { id: 90, name: "Performance Focus (Top)", cardType: "Identity/Role", visualHandle: "uncommon_perf_top", primaryElement: "I", elementScores: { A: 5, I: 8, S: 6, P: 7, C: 6, R: 5 }, briefDescription: "Enjoying orchestrating partner's pleasure.", detailedDescription: "A dominant or topping style focused on skillfully providing pleasure and controlling the sensory experience for the partner, often enjoying the partner's reactions as validation.", relatedIds: [4, 11, 18, 89], rarity: 'uncommon', canUnlockArt: false },
    { id: 91, name: "Performance Focus (Bottom)", cardType: "Identity/Role", visualHandle: "uncommon_perf_bot", primaryElement: "I", elementScores: { A: 5, I: 3, S: 6, P: 7, C: 5, R: 5 }, briefDescription: "Enjoying reacting/expressing pleasure.", detailedDescription: "A submissive or bottoming style focused on expressing reactions and pleasure authentically and visibly, finding satisfaction in showing their response to the partner's actions.", relatedIds: [5, 18, 50], rarity: 'uncommon', canUnlockArt: false },
    { id: 92, name: "Gender Play", cardType: "Practice/Kink", visualHandle: "uncommon_genderplay", primaryElement: "C", elementScores: { A: 6, I: 6, S: 4, P: 6, C: 7, R: 5 }, briefDescription: "Exploring/subverting gender roles.", detailedDescription: "Consensually playing with or subverting traditional gender roles, expressions, or presentations within a sexual context (e.g., cross-dressing, adopting gender-nonconforming personas).", relatedIds: [13, 39, 103], rarity: 'uncommon', canUnlockArt: false },
    { id: 93, name: "Tickling (Erotic)", cardType: "Practice/Kink", visualHandle: "uncommon_tickle", primaryElement: "S", elementScores: { A: 4, I: 6, S: 6, P: 5, C: 3, R: 5 }, briefDescription: "Using tickling for arousal/play.", detailedDescription: "Using tickling as a form of playful torture, teasing, or sensory stimulation within an erotic context, often combined with light restraint.", relatedIds: [7, 38, 87], rarity: 'uncommon', canUnlockArt: false },
    { id: 94, name: "Leather Fetish", cardType: "Orientation", visualHandle: "uncommon_leather", primaryElement: "A", elementScores: { A: 8, I: 6, S: 7, P: 6, C: 5, R: 5 }, briefDescription: "Attraction focused on leather.", detailedDescription: "Specific arousal triggered by the sight, smell, sound, or feel of leather garments or items, often associated with BDSM or specific subcultures.", relatedIds: [20, 21, 4], rarity: 'uncommon', canUnlockArt: false },
    { id: 95, name: "Lingerie Focus", cardType: "Orientation", visualHandle: "uncommon_lingerie", primaryElement: "A", elementScores: { A: 7, I: 5, S: 5, P: 5, C: 4, R: 4 }, briefDescription: "Arousal enhanced by specific underwear.", detailedDescription: "Finding specific types of lingerie or underwear particularly arousing, either on oneself or a partner.", relatedIds: [21], rarity: 'uncommon', canUnlockArt: false },
    { id: 96, name: "Hair Pulling", cardType: "Practice/Kink", visualHandle: "uncommon_hairpull", primaryElement: "S", elementScores: { A: 5, I: 7, S: 6, P: 5, C: 2, R: 5 }, briefDescription: "Using hair pulling for control/sensation.", detailedDescription: "Incorporating pulling a partner's hair during sexual activity for sensation, control, or to guide movement.", relatedIds: [7, 9, 4], rarity: 'uncommon', canUnlockArt: false },
    { id: 97, name: "Biting / Marking", cardType: "Practice/Kink", visualHandle: "uncommon_biting", primaryElement: "S", elementScores: { A: 5, I: 7, S: 7, P: 6, C: 3, R: 5 }, briefDescription: "Using teeth for sensation/possession.", detailedDescription: "Incorporating biting (from gentle nips to harder bites that may leave marks) for intense sensation, primal expression, or as a sign of possession.", relatedIds: [9, 8, 40], rarity: 'uncommon', canUnlockArt: false },
    { id: 98, name: "Pet Play", cardType: "Practice/Kink", visualHandle: "uncommon_petplay", primaryElement: "C", elementScores: { A: 5, I: 6, S: 5, P: 7, C: 7, R: 6 }, briefDescription: "Role-playing as animals/pets.", detailedDescription: "Consensual role-play where one or more participants adopt the persona and behaviors of an animal or pet (e.g., kitten, puppy), often involving specific gear, dynamics, and interactions.", relatedIds: [13, 39, 4, 5, 10, 121], rarity: 'uncommon', canUnlockArt: false },
    { id: 99, name: "Masochism (Psychological)", cardType: "Psychological/Goal", visualHandle: "uncommon_maso_psych", primaryElement: "P", elementScores: { A: 5, I: 3, S: 4, P: 8, C: 6, R: 5 }, briefDescription: "Pleasure from emotional submission/distress.", detailedDescription: "Deriving pleasure or release from experiencing consensually inflicted emotional distress, humiliation, powerlessness, or psychological challenge.", relatedIds: [5, 17, 45, 100, 120], rarity: 'uncommon', canUnlockArt: false },
    { id: 100, name: "Sadism (Psychological)", cardType: "Psychological/Goal", visualHandle: "uncommon_sad_psych", primaryElement: "P", elementScores: { A: 5, I: 7, S: 4, P: 8, C: 7, R: 5 }, briefDescription: "Pleasure from causing emotional distress.", detailedDescription: "Deriving pleasure or satisfaction from consensually inflicting emotional distress, humiliation, or psychological challenge upon a partner.", relatedIds: [4, 11, 45, 99, 120], rarity: 'uncommon', canUnlockArt: false },
    { id: 101, name: "Ritualistic Play", cardType: "Practice/Kink", visualHandle: "uncommon_ritual", primaryElement: "C", elementScores: { A: 6, I: 7, S: 6, P: 7, C: 8, R: 7 }, briefDescription: "Using ceremony/symbolism in scenes.", detailedDescription: "Incorporating elements of ritual, ceremony, symbolism, or formalized structure into sexual scenes or BDSM dynamics to enhance meaning, power exchange, or psychological impact.", relatedIds: [30, 11, 13, 16, 116], rarity: 'uncommon', canUnlockArt: true, visualHandleUnlocked: "uncommon_ritual_art" },
    { id: 102, name: "Sensory Focus (Specific Zone)", cardType: "Practice/Kink", visualHandle: "uncommon_sens_zone", primaryElement: "S", elementScores: { A: 5, I: 6, S: 7, P: 5, C: 4, R: 5 }, briefDescription: "Intense focus on one body part.", detailedDescription: "Concentrating intense sensory stimulation (touch, temperature, vibration, etc.) on a specific erogenous zone or body part for an extended period.", relatedIds: [57, 2, 61, 62], rarity: 'uncommon', canUnlockArt: false },
    { id: 103, name: "Androgyny Attraction", cardType: "Orientation", visualHandle: "uncommon_andro", primaryElement: "A", elementScores: { A: 7, I: 5, S: 5, P: 5, C: 5, R: 5 }, briefDescription: "Attraction to androgynous presentation.", detailedDescription: "Sexual or aesthetic attraction primarily towards individuals whose gender presentation is androgynous, blending traditionally masculine and feminine characteristics.", relatedIds: [55, 92], rarity: 'uncommon', canUnlockArt: false },
    { id: 104, name: "Power Attire", cardType: "Orientation", visualHandle: "uncommon_powerattire", primaryElement: "A", elementScores: { A: 7, I: 6, S: 4, P: 6, C: 5, R: 5 }, briefDescription: "Arousal from authoritative clothing.", detailedDescription: "Finding clothing associated with power, authority, or formality (e.g., business suits, uniforms, formal wear) particularly arousing.", relatedIds: [21, 4], rarity: 'uncommon', canUnlockArt: false },
    { id: 105, name: "Voyeuristic Exhibitionism", cardType: "Identity/Role", visualHandle: "uncommon_voy_exhib", primaryElement: "I", elementScores: { A: 7, I: 7, S: 5, P: 7, C: 6, R: 6 }, briefDescription: "Pleasure from mutual watching/being watched.", detailedDescription: "A dynamic where arousal comes from both watching others and being watched, often in group settings or where partners take turns performing and observing.", relatedIds: [18, 19, 34], rarity: 'uncommon', canUnlockArt: false },
    { id: 106, name: "Fear Play (Mild)", cardType: "Practice/Kink", visualHandle: "uncommon_fear_mild", primaryElement: "P", elementScores: { A: 5, I: 6, S: 6, P: 7, C: 5, R: 5 }, briefDescription: "Using startle/anticipation.", detailedDescription: "Incorporating elements of surprise, startle responses, or anticipation of intense sensation/actions to generate adrenaline and psychological tension within a safe context.", relatedIds: [44, 38, 9, 111, 122], rarity: 'uncommon', canUnlockArt: false },
    { id: 107, name: "Tribadism / Scissoring", cardType: "Practice/Kink", visualHandle: "uncommon_tribadism", primaryElement: "S", elementScores: { A: 5, I: 6, S: 7, P: 5, C: 2, R: 5 }, briefDescription: "Vulva-to-vulva rubbing.", detailedDescription: "A sexual practice involving rubbing vulvas together for mutual stimulation and friction.", relatedIds: [1, 67], rarity: 'uncommon', canUnlockArt: false },
    { id: 108, name: "Intercrural Sex (Frotting)", cardType: "Practice/Kink", visualHandle: "uncommon_frotting", primaryElement: "S", elementScores: { A: 5, I: 6, S: 7, P: 5, C: 2, R: 5 }, briefDescription: "Penis-to-penis rubbing.", detailedDescription: "A sexual practice involving rubbing penises together for mutual stimulation and friction.", relatedIds: [1], rarity: 'uncommon', canUnlockArt: false },
    { id: 110, name: "Figging", cardType: "Practice/Kink", visualHandle: "uncommon_figging", primaryElement: "S", elementScores: { A: 3, I: 6, S: 8, P: 6, C: 3, R: 5 }, briefDescription: "Using ginger root for intense sensation.", detailedDescription: "Inserting a piece of peeled ginger root into the anus or vagina, causing an intense burning sensation. An older BDSM practice requiring caution.", relatedIds: [9, 8], rarity: 'uncommon', canUnlockArt: false },

    // --- Original Rare Concepts --- (~20 + reclassified = ~25)
    { id: 8, name: "Impact Play (Heavy)", cardType: "Practice/Kink", visualHandle: "rare_impact_heavy", primaryElement: "S", elementScores: { A: 5, I: 7, S: 9, P: 7, C: 4, R: 6 }, briefDescription: "Intense impact, pain/marks focus.", detailedDescription: "Utilizes implements like canes, whips, heavy paddles, or fists to deliver strong, often painful sensations. Focus can be on endurance, marking, or the psychological aspects of receiving intense impact.", relatedIds: [7, 9, 4, 5, 44, 97, 110], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_impact_heavy_art" },
    { id: 9, name: "Pain Play (Non-Impact)", cardType: "Practice/Kink", visualHandle: "rare_pain", primaryElement: "S", elementScores: { A: 4, I: 6, S: 8, P: 7, C: 5, R: 6 }, briefDescription: "Pinching, biting, wax, needles.", detailedDescription: "Focuses on creating intense sensations through means other than direct impact, such as pinching, biting, scratching, temperature play (wax, ice), clamps, or potentially needles (use extreme caution).", relatedIds: [7, 8, 16, 17, 37, 44, 63, 88, 96, 97, 110, 111, 112, 106, 124], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_pain_art" },
    { id: 11, name: "Command/Control Dynamics", cardType: "Psychological/Goal", visualHandle: "rare_control", primaryElement: "I", elementScores: { A: 6, I: 9, S: 5, P: 8, C: 8, R: 6 }, briefDescription: "Explicit orders given/obeyed.", detailedDescription: "A power dynamic characterized by one partner giving clear commands or instructions and the other partner deriving pleasure or fulfillment from obeying them precisely.", relatedIds: [4, 5, 10, 30, 38, 45, 41, 89, 90, 100, 101, 109, 119, 120], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_control_art" },
    { id: 12, name: "Objectification Play", cardType: "Psychological/Goal", visualHandle: "rare_object", primaryElement: "P", elementScores: { A: 7, I: 4, S: 6, P: 8, C: 6, R: 5 }, briefDescription: "Consensually treating/being treated as object.", detailedDescription: "Consensual play involving focusing on a person's body or specific body parts as the primary source of pleasure or utility, potentially dehumanizing them temporarily within the agreed scene.", relatedIds: [4, 5, 20, 18, 19, 45, 61, 42, 62, 114], rarity: 'rare', canUnlockArt: false },
    { id: 14, name: "Fantasy Immersion", cardType: "Cognitive", visualHandle: "rare_fantasy", primaryElement: "C", elementScores: { A: 5, I: 3, S: 4, P: 7, C: 9, R: 3 }, briefDescription: "Deep focus on internal narrative.", detailedDescription: "Prioritizes internal mental experience, elaborate fantasy worlds, or complex narratives over external reality during sexual encounters. Arousal is heavily dependent on the mental construct.", relatedIds: [13, 29, 41, 42, 49], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_fantasy_art" },
    { id: 16, name: "Rope Bondage (Shibari/Kinbaku)", cardType: "Practice/Kink", visualHandle: "rare_rope", primaryElement: "S", elementScores: { A: 6, I: 7, S: 8, P: 7, C: 6, R: 6 }, briefDescription: "Aesthetic/restrictive rope tying.", detailedDescription: "An art form and practice involving tying a partner with rope, focusing on aesthetic patterns, nerve pressure, physical restriction, and the psychological state induced by the tie.", relatedIds: [9, 17, 4, 5, 44, 87, 101, 113], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_rope_art" },
    { id: 17, name: "Restriction/Helplessness", cardType: "Psychological/Goal", visualHandle: "rare_restrict", primaryElement: "P", elementScores: { A: 5, I: 3, S: 7, P: 9, C: 5, R: 5 }, briefDescription: "Arousal from restraint/surrender.", detailedDescription: "Deriving significant arousal from the sensation of being physically restrained (via ropes, cuffs, etc.) and the associated psychological state of helplessness or surrender.", relatedIds: [16, 5, 9, 37, 44, 63, 64, 87, 99, 113, 117, 118, 125, 43], rarity: 'rare', canUnlockArt: false },
    { id: 20, name: "Latex/Material Fetish", cardType: "Orientation", visualHandle: "rare_latex", primaryElement: "A", elementScores: { A: 9, I: 5, S: 8, P: 6, C: 5, R: 4 }, briefDescription: "Attraction focused on materials.", detailedDescription: "A specific fetish where sexual arousal is strongly and primarily triggered by the sight, feel, sound, or smell of particular materials like latex, leather, PVC, rubber, silk, etc.", relatedIds: [12, 21, 42, 94], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_latex_art" },
    { id: 21, name: "Uniform/Clothing Fetish", cardType: "Orientation", visualHandle: "rare_uniform", primaryElement: "A", elementScores: { A: 8, I: 6, S: 4, P: 6, C: 6, R: 5 }, briefDescription: "Specific clothing as arousal trigger.", detailedDescription: "A fetish where sexual arousal is significantly and primarily triggered by specific types of clothing, such as uniforms (military, medical, school), costumes, or specific garments (lingerie, suits).", relatedIds: [13, 20, 12, 94, 95, 104], rarity: 'rare', canUnlockArt: false },
    { id: 25, name: "Polyamory", cardType: "Relationship Style", visualHandle: "rare_poly", primaryElement: "R", elementScores: { A: 6, I: 6, S: 5, P: 7, C: 6, R: 8 }, briefDescription: "Multiple loving relationships.", detailedDescription: "The practice of, or desire for, intimate relationships with more than one partner, with the informed consent of all partners involved. Often involves emotional intimacy with multiple people.", relatedIds: [15, 26, 27, 34, 59, 84], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_poly_art" },
    { id: 27, name: "Relationship Anarchy", cardType: "Relationship Style", visualHandle: "rare_ra", primaryElement: "R", elementScores: { A: 6, I: 5, S: 5, P: 6, C: 7, R: 9 }, briefDescription: "Rejects rules/hierarchies.", detailedDescription: "A philosophy and relationship style that rejects societal norms and imposed rules regarding relationships. Each relationship is unique and defined by the individuals involved, without inherent hierarchy.", relatedIds: [25, 26, 36, 59, 84], rarity: 'rare', canUnlockArt: false },
    { id: 30, name: "High Protocol D/s", cardType: "Practice/Kink", visualHandle: "rare_protocol", primaryElement: "I", elementScores: { A: 6, I: 8, S: 6, P: 8, C: 9, R: 7 }, briefDescription: "Highly structured power exchange.", detailedDescription: "A style of Dominance and submission characterized by significant structure, formal rules, rituals, specific forms of address, and often pre-negotiated expectations for behavior within the dynamic.", relatedIds: [4, 5, 11, 13, 38, 101, 109], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_protocol_art" },
    { id: 41, name: "Erotic Hypnosis / Mind Control Play", cardType: "Practice/Kink", visualHandle: "rare_hypno", primaryElement: "C", elementScores: { A: 5, I: 7, S: 3, P: 8, C: 9, R: 6 }, briefDescription: "Using suggestion/perceived control.", detailedDescription: "Consensual play involving altered states of consciousness, hypnotic suggestion, triggers, or the *illusion* of one partner controlling the other's mind or actions for erotic purposes. Safety and consent are paramount.", relatedIds: [14, 4, 5, 11, 45, 42, 120, 44], rarity: 'rare', canUnlockArt: false },
    { id: 42, name: "Transformation Fetish", cardType: "Orientation", visualHandle: "rare_transform", primaryElement: "C", elementScores: { A: 7, I: 4, S: 5, P: 7, C: 8, R: 4 }, briefDescription: "Arousal from transformation themes.", detailedDescription: "A fetish centered on the concept of transformation, which can include physical changes (e.g., into animals, objects, different genders), mental changes (e.g., bimbofication, personality alteration), or forced changes within a power dynamic.", relatedIds: [20, 21, 12, 41, 14, 121], rarity: 'rare', canUnlockArt: false },
    { id: 43, name: "Medical Play", cardType: "Practice/Kink", visualHandle: "rare_medical", primaryElement: "C", elementScores: { A: 5, I: 6, S: 7, P: 7, C: 7, R: 6 }, briefDescription: "Role-playing medical scenarios.", detailedDescription: "Consensual role-playing involving medical themes, settings, or equipment. Can range from simple doctor/patient scenarios to more clinical interactions involving mock examinations, implements (speculums, needles - potentially real/blunt), restraints, or power dynamics inherent in medical settings.", relatedIds: [13, 9, 17, 4, 5], rarity: 'rare', canUnlockArt: false },
    { id: 44, name: "Edge Play", cardType: "Practice/Kink", visualHandle: "rare_edge", primaryElement: "S", elementScores: { A: 5, I: 6, S: 9, P: 8, C: 5, R: 6 }, briefDescription: "Pushing boundaries near limits.", detailedDescription: "Activities that intentionally push physical, psychological, or emotional boundaries close to perceived limits. Often involves negotiation, high trust, and managing real or perceived risk (e.g., breath play, knife play, extreme sensation, fear play). Requires significant caution, expertise, and communication.", relatedIds: [8, 9, 16, 17, 37, 38, 41, 63, 64, 65, 106, 111, 113, 116, 122, 125], rarity: 'rare', canUnlockArt: false },
    { id: 45, name: "Humiliation / Degradation", cardType: "Psychological/Goal", visualHandle: "rare_humiliation", primaryElement: "P", elementScores: { A: 5, I: 7, S: 4, P: 9, C: 6, R: 6 }, briefDescription: "Pleasure from embarrassment/degradation.", detailedDescription: "Consensual play where one partner derives pleasure from performing or receiving acts or words intended to cause embarrassment, shame, or degradation. Can range from light teasing to intense psychological scenarios. Consent and aftercare are critical.", relatedIds: [4, 5, 10, 11, 12, 38, 41, 99, 100, 114, 115, 120], rarity: 'rare', canUnlockArt: false },
    { id: 63, name: "Breath Play", cardType: "Practice/Kink", visualHandle: "rare_breath", primaryElement: "S", elementScores: { A: 4, I: 7, S: 9, P: 8, C: 4, R: 6 }, briefDescription: "Restricting airflow for sensation.", detailedDescription: "Consensual practice involving the restriction of airflow (erotic asphyxiation) to create intense physical sensations and altered mental states. Carries significant risks and requires extreme caution, knowledge, and trust.", relatedIds: [44, 17, 9, 5, 125], rarity: 'rare', canUnlockArt: false },
    { id: 64, name: "CNC (Consensual Non-Consent)", cardType: "Practice/Kink", visualHandle: "rare_cnc", primaryElement: "C", elementScores: { A: 6, I: 7, S: 7, P: 8, C: 9, R: 6 }, briefDescription: "Role-playing lack of consent.", detailedDescription: "Consensual role-playing scenarios where participants act out a scene involving simulated non-consent or coercion (e.g., simulated rape fantasy, abduction). Requires meticulous negotiation, clear boundaries, safewords, and trust.", relatedIds: [13, 4, 5, 17, 44, 117, 118], rarity: 'rare', canUnlockArt: false },
    { id: 65, name: "Chemsex / Party & Play (PnP)", cardType: "Practice/Kink", visualHandle: "rare_chemsex", primaryElement: "S", elementScores: { A: 6, I: 6, S: 8, P: 7, C: 3, R: 7 }, briefDescription: "Using drugs to enhance sex.", detailedDescription: "Intentionally combining sexual activity with the use of psychoactive drugs (like methamphetamine, GHB, mephedrone) to sustain activity, reduce inhibitions, or intensify sensations. Carries health risks and potential for addiction.", relatedIds: [34, 24, 44], rarity: 'rare', canUnlockArt: false },
    { id: 109, name: "Master/slave Dynamic (M/s)", cardType: "Relationship Style", visualHandle: "rare_ms", primaryElement: "I", elementScores: { A: 6, I: 9, S: 6, P: 9, C: 8, R: 7 }, briefDescription: "Total power exchange relationship.", detailedDescription: "A specific, high-intensity form of D/s relationship involving a deep level of commitment and power exchange, often encompassing many aspects of life beyond the bedroom. Uses specific titles.", relatedIds: [4, 5, 11, 30, 10], rarity: 'rare', canUnlockArt: false },
    { id: 111, name: "Knife Play / Edge Play (Sharp)", cardType: "Practice/Kink", visualHandle: "rare_knife", primaryElement: "S", elementScores: { A: 5, I: 7, S: 9, P: 8, C: 6, R: 6 }, briefDescription: "Using blades for sensation/fear.", detailedDescription: "Edge play involving the use of knives or other sharp objects against the skin for sensation, psychological fear, or light marking (drawing blood is extremely risky and requires advanced knowledge). Intense focus on control and trust.", relatedIds: [44, 9, 106, 4, 116], rarity: 'rare', canUnlockArt: false },
    { id: 112, name: "Electrostimulation (E-Stim)", cardType: "Practice/Kink", visualHandle: "rare_estim", primaryElement: "S", elementScores: { A: 4, I: 6, S: 9, P: 6, C: 4, R: 5 }, briefDescription: "Using electrical currents for sensation.", detailedDescription: "Using specialized devices (like TENS units adapted or purpose-built) to pass mild electrical currents through the body for unique tingling, buzzing, or contracting sensations.", relatedIds: [9, 57, 119], rarity: 'rare', canUnlockArt: true, visualHandleUnlocked: "rare_estim_art" },
    { id: 113, name: "Suspension Bondage", cardType: "Practice/Kink", visualHandle: "rare_suspension", primaryElement: "S", elementScores: { A: 5, I: 7, S: 9, P: 8, C: 6, R: 6 }, briefDescription: "Lifting partner off ground with rope/chains.", detailedDescription: "A form of bondage where a person is partially or fully suspended off the ground using ropes, chains, or other equipment. Requires significant technical skill, knowledge of rigging, and safety precautions.", relatedIds: [16, 17, 44], rarity: 'rare', canUnlockArt: false },
    { id: 114, name: "Water Sports / Urolagnia", cardType: "Practice/Kink", visualHandle: "rare_watersports", primaryElement: "S", elementScores: { A: 6, I: 6, S: 7, P: 7, C: 4, R: 5 }, briefDescription: "Incorporating urine into play.", detailedDescription: "Sexual arousal or activity involving urine (also known as golden showers). Can range from watching urination to being urinated on or drinking urine. Consent and hygiene are important.", relatedIds: [45, 12, 115], rarity: 'rare', canUnlockArt: false },
    { id: 115, name: "Scat Play / Coprophilia", cardType: "Practice/Kink", visualHandle: "rare_scat", primaryElement: "S", elementScores: { A: 5, I: 5, S: 6, P: 8, C: 3, R: 4 }, briefDescription: "Incorporating feces into play.", detailedDescription: "Sexual arousal or activity involving feces. Considered an extreme fetish with significant health risks and stigma. Requires extreme caution regarding hygiene and consent.", relatedIds: [114, 45], rarity: 'rare', canUnlockArt: false },
    { id: 116, name: "Blood Play (Intentional)", cardType: "Practice/Kink", visualHandle: "rare_bloodplay", primaryElement: "S", elementScores: { A: 5, I: 7, S: 8, P: 8, C: 5, R: 6 }, briefDescription: "Consensual use of blood in scenes.", detailedDescription: "Consensually incorporating small amounts of blood (drawn safely, e.g., via lancet) into sexual or ritualistic scenes. Carries significant health risks (bloodborne pathogens) and requires stringent safety protocols.", relatedIds: [44, 111, 101], rarity: 'rare', canUnlockArt: false },
    { id: 117, name: "Abduction / Capture Fantasy", cardType: "Practice/Kink", visualHandle: "rare_abduction", primaryElement: "C", elementScores: { A: 6, I: 7, S: 7, P: 8, C: 9, R: 6 }, briefDescription: "Role-playing non-consensual capture.", detailedDescription: "A specific type of CNC role-play focusing on the scenario of being abducted, captured, or held against one's will within a pre-negotiated, safe container.", relatedIds: [64, 13, 17, 44, 122], rarity: 'rare', canUnlockArt: false },
    { id: 118, name: "Somnophilia / Sleep Play", cardType: "Practice/Kink", visualHandle: "rare_somno", primaryElement: "C", elementScores: { A: 7, I: 3, S: 6, P: 7, C: 7, R: 4 }, briefDescription: "Arousal related to sleeping individuals.", detailedDescription: "Sexual arousal derived from interacting with or observing someone who is asleep or feigning sleep. Often involves themes of vulnerability and voyeurism. Consent when awake is paramount for ethical play.", relatedIds: [19, 17, 64], rarity: 'rare', canUnlockArt: false },
    { id: 119, name: "Forced Orgasm / Orgasmo Denied Control", cardType: "Practice/Kink", visualHandle: "rare_forceorgasm", primaryElement: "I", elementScores: { A: 5, I: 8, S: 8, P: 8, C: 7, R: 6 }, briefDescription: "Controlling partner's orgasm.", detailedDescription: "A power dynamic where one partner controls if, when, and how the other partner experiences orgasm, potentially pushing them past limits or denying it completely.", relatedIds: [38, 11, 4, 5, 112], rarity: 'rare', canUnlockArt: false },
    { id: 120, name: "Psychological Torture Play", cardType: "Practice/Kink", visualHandle: "rare_psychtorture", primaryElement: "P", elementScores: { A: 4, I: 7, S: 4, P: 9, C: 8, R: 6 }, briefDescription: "Intense mind games/emotional manipulation.", detailedDescription: "Consensual play involving intense psychological manipulation, mind games, gaslighting (within agreed limits), or emotional challenges designed to push mental boundaries. Requires extreme trust and aftercare.", relatedIds: [45, 41, 100, 99, 11], rarity: 'rare', canUnlockArt: false },
    { id: 121, name: "Furry Fandom Sexuality", cardType: "Identity/Role", visualHandle: "rare_furrysex", primaryElement: "C", elementScores: { A: 6, I: 6, S: 5, P: 6, C: 7, R: 6 }, briefDescription: "Sexual expression within furry context.", detailedDescription: "Expressing sexuality through or within the context of the furry fandom, which may involve anthropomorphic characters (fursonas), costumes (fursuits), role-play, and specific community norms.", relatedIds: [13, 98, 42], rarity: 'rare', canUnlockArt: false },
    { id: 122, name: "Autassassinophilia", cardType: "Orientation", visualHandle: "rare_autassass", primaryElement: "P", elementScores: { A: 5, I: 2, S: 7, P: 8, C: 6, R: 3 }, briefDescription: "Arousal from staged risk of being killed.", detailedDescription: "A paraphilia involving sexual arousal from the fantasy or staged scenario of being hunted or stalked with the risk of being killed.", relatedIds: [44, 106, 117], rarity: 'rare', canUnlockArt: false },
    { id: 123, name: "Exposure Therapy Play", cardType: "Psychological/Goal", visualHandle: "rare_exposure", primaryElement: "P", elementScores: { A: 4, I: 6, S: 5, P: 8, C: 7, R: 7 }, briefDescription: "Using scenes to process trauma/fear.", detailedDescription: "Carefully negotiated and consensual scenes designed to gently re-approach or process past trauma or fears within a supportive BDSM context. Requires immense trust and often therapeutic awareness.", relatedIds: [15, 69, 4, 5], rarity: 'rare', canUnlockArt: false },
    { id: 124, name: "Sensory Overstimulation Torture", cardType: "Practice/Kink", visualHandle: "rare_sens_torture", primaryElement: "S", elementScores: { A: 4, I: 7, S: 9, P: 7, C: 5, R: 6 }, briefDescription: "Using prolonged/intense stimuli.", detailedDescription: "Intentionally using prolonged, inescapable, or intensely unpleasant sensory input (e.g., specific sounds, lights, textures, smells) as a form of consensual 'torture' play.", relatedIds: [86, 37, 9, 44], rarity: 'rare', canUnlockArt: false },
    { id: 125, name: "Breath Control (Advanced)", cardType: "Practice/Kink", visualHandle: "rare_breath_adv", primaryElement: "S", elementScores: { A: 4, I: 7, S: 9, P: 8, C: 4, R: 6 }, briefDescription: "Precise manipulation of breathing.", detailedDescription: "Advanced forms of breath play involving more precise control over inhalation/exhalation, potentially using bags or masks under highly controlled and knowledgeable conditions. Extremely high risk.", relatedIds: [63, 44, 17], rarity: 'rare', canUnlockArt: false },
];

// --- Utility Maps ---
const elementKeyToFullName = { A: "Attraction", I: "Interaction", S: "Sensory", P: "Psychological", C: "Cognitive", R: "Relational" };

// --- Questionnaire Data ---
const questionnaireGuided = {
    "Attraction": [
        { qId: "a1", type: "slider", text: "How specific are the triggers for your sexual attraction? (e.g., Very broad vs. Very specific types/situations)", minValue: 0, maxValue: 10, defaultValue: 5, minLabel: "Very Broad / Few Specifics", maxLabel: "Very Specific / Narrow Focus", scoreWeight: 1.0 },
        { qId: "a2", type: "checkbox", text: "Which factors significantly contribute to your initial attraction? (Select up to 2)", options: [ { value: "Physical Appearance/Body Type", points: 0.5 }, { value: "Gender Identity/Presentation", points: 0.5 }, { value: "Personality/Demeanor", points: 0.0 }, { value: "Intellect/Wit", points: 0.5 }, { value: "Signs of Power/Confidence", points: 1.0 }, { value: "Signs of Vulnerability/Submissiveness", points: 1.0 }, { value: "Emotional Connection (Pre-existing)", points: -1.0 }, { value: "Specific Clothing/Materials", points: 1.5 }, { value: "Context/Situation (e.g., role-play)", points: 1.0 } ], scoreWeight: 1.0, maxChoices: 2 },
        { qId: "a3", type: "radio", text: "How important is an emotional bond BEFORE feeling sexual attraction?", options: [ { value: "Essential", points: -2.0 }, { value: "Helpful, but not required", points: -0.5 }, { value: "Neutral / Varies", points: 0 }, { value: "Generally unimportant", points: 1.0 } ], scoreWeight: 1.0 }
    ],
    "Interaction": [
         { qId: "i1", type: "slider", text: "In sexual interactions, where do you naturally find yourself on the spectrum of leading vs. following?", minValue: 0, maxValue: 10, defaultValue: 5, minLabel: "Strongly Following / Receiving", maxLabel: "Strongly Leading / Directing", scoreWeight: 1.0 },
         { qId: "i2", type: "checkbox", text: "Which interaction styles or roles feel most appealing? (Select up to 2)", options: [ { value: "Taking Charge / Dominating", points: 1.5 }, { value: "Guiding / Being Attentive (Top/Caregiver)", points: 1.0 }, { value: "Collaborating / Switching Roles", points: 0 }, { value: "Following Directions / Submitting", points: -1.5 }, { value: "Serving / Pleasing Partner", points: -1.0 }, { value: "Performing / Being Watched", points: 0.5 }, { value: "Playful / Teasing", points: 0.0 } ], scoreWeight: 1.0, maxChoices: 2 },
         { qId: "i3", type: "radio", text: "Do you prefer clear power dynamics or more equal footing?", options: [ { value: "Clear Power Difference (D/s)", points: 1.5 }, { value: "Subtle Power Dynamics", points: 0.5 }, { value: "Equal Footing / Collaborative", points: -1.0 }, { value: "Varies Greatly / No Preference", points: 0 } ], scoreWeight: 1.0 }
    ],
    "Sensory": [
        { qId: "s1", type: "slider", text: "How important is the intensity and variety of physical sensation to your arousal?", minValue: 0, maxValue: 10, defaultValue: 5, minLabel: "Low Importance / Subtle Preferred", maxLabel: "High Importance / Intensity Craved", scoreWeight: 1.0 },
        { qId: "s2", type: "checkbox", text: "Which types of physical sensations are particularly appealing? (Select up to 2)", options: [ { value: "Gentle Touch / Caressing / Warmth", points: -1.0 }, { value: "Firm Pressure / Massage / Hugging", points: 0.0 }, { value: "Sharp / Stinging (Spanking, Biting)", points: 1.5 }, { value: "Burning / Temperature Play (Wax, Ice)", points: 1.5 }, { value: "Restriction / Binding / Helplessness", points: 1.0 }, { value: "Specific Textures (Latex, Silk, Rope)", points: 1.0 }, { value: "Vibration / Electrostimulation", points: 1.5 } ], scoreWeight: 1.0, maxChoices: 2 },
        { qId: "s3", type: "radio", text: "How do you feel about incorporating pain or extreme sensations?", options: [ { value: "Strongly Drawn To It", points: 2.0 }, { value: "Open To Exploring It", points: 1.0 }, { value: "Neutral / Indifferent", points: 0 }, { value: "Prefer to Avoid It", points: -1.0 }, { value: "Strongly Averse To It", points: -2.0 } ], scoreWeight: 1.0 }
     ],
    "Psychological": [
        { qId: "p1", type: "slider", text: "How much is your sexuality tied to fulfilling deeper emotional or psychological needs (beyond physical pleasure)?", minValue: 0, maxValue: 10, defaultValue: 5, minLabel: "Very Little / Primarily Physical", maxLabel: "Very Much / Primary Driver", scoreWeight: 1.0 },
        { qId: "p2", type: "checkbox", text: "Which psychological needs does sex MOST effectively help you meet? (Select up to 2)", options: [ { value: "Deep Connection / Intimacy / Trust", points: 1.5 }, { value: "Power / Control (Giving or Receiving)", points: 1.5 }, { value: "Validation / Feeling Desired", points: 1.0 }, { value: "Escape / Stress Relief / Forgetting", points: 0.5 }, { value: "Catharsis / Emotional Release", points: 1.0 }, { value: "Self-Exploration / Identity Expression", points: 0.5 }, { value: "Security / Comfort / Nurturing", points: 0.0 }, { value: "Simple Fun / Recreation", points: -1.0 } ], scoreWeight: 1.0, maxChoices: 2 },
        { qId: "p3", type: "radio", text: "Does sex feel incomplete if a specific psychological need isn't addressed?", options: [ { value: "Yes, Often", points: 1.5 }, { value: "Sometimes", points: 0.5 }, { value: "Rarely", points: -0.5 }, { value: "Never", points: -1.5 } ], scoreWeight: 1.0 }
     ],
    "Cognitive": [
        { qId: "c1", type: "slider", text: "How important is mental engagement (fantasy, scenarios, intellect) during sex?", minValue: 0, maxValue: 10, defaultValue: 5, minLabel: "Not Important / Prefer Presence", maxLabel: "Very Important / Mentally Driven", scoreWeight: 1.0 },
        { qId: "c2", type: "checkbox", text: "Which mental aspects significantly enhance your arousal? (Select up to 2)", options: [ { value: "Detailed Internal Fantasies", points: 1.5 }, { value: "Specific Role-Playing Scenarios", points: 1.5 }, { value: "Dirty Talk / Erotic Language", points: 1.0 }, { value: "Intellectual Banter / Mind Games", points: 1.0 }, { value: "Understanding Partner's Psychology", points: 0.5 }, { value: "Anticipation / Pre-Planned Scenes", points: 1.0 }, { value: "Being Fully 'In the Moment'", points: -1.5 } ], scoreWeight: 1.0, maxChoices: 2 },
        { qId: "c3", type: "radio", text: "Do you prefer spontaneous encounters or more planned/scripted ones?", options: [ { value: "Strongly Prefer Planned/Scripted", points: 1.5 }, { value: "Lean Towards Planned", points: 0.5 }, { value: "No Real Preference / Mix", points: 0 }, { value: "Lean Towards Spontaneous", points: -0.5 }, { value: "Strongly Prefer Spontaneous", points: -1.5 } ], scoreWeight: 1.0 }
    ],
    "Relational": [
         { qId: "r1", type: "slider", text: "What is your ideal relationship structure regarding number of partners?", minValue: 0, maxValue: 10, defaultValue: 3, minLabel: "Strictly One (Monogamy) / Solitary", maxLabel: "Multiple Partners / Fluidity", scoreWeight: 1.0 },
         { qId: "r2", type: "checkbox", text: "Which relationship contexts feel most comfortable or desirable? (Select up to 2)", options: [ { value: "Solitary / Self-Exploration", points: -1.5 }, { value: "Deeply Committed Monogamous Pair", points: -1.0 }, { value: "Casual Dating / Friends With Benefits", points: 0.5 }, { value: "Open Relationship (Primary + Others)", points: 1.0 }, { value: "Polyamory (Multiple Equal Relationships)", points: 1.5 }, { value: "Group Sex Scenarios", points: 1.0 }, { value: "Anonymous Encounters", points: 0.5 } ], scoreWeight: 1.0, maxChoices: 2 },
         { qId: "r3", type: "radio", text: "How important is relationship 'hierarchy' (e.g., having a 'primary' partner)?", options: [ { value: "Very Important / Need a Primary", points: -1.0 }, { value: "Somewhat Important / Prefer Hierarchy", points: -0.5 }, { value: "Neutral / Depends on Relationship", points: 0 }, { value: "Prefer Non-Hierarchical", points: 1.0 }, { value: "Strongly Against Hierarchy (Anarchy)", points: 1.5 } ], scoreWeight: 1.0 }
    ]
};

// --- Reflection Prompts (CORRECTED Structure) ---
const reflectionPrompts = {
    // --- Standard Prompts ---
    "Attraction": [
        { id: "pA1", text: "Think about someone or something you found intensely attractive recently. What specific qualities (physical, personality, dynamic) drew you in the most?" },
        { id: "pA2", text: "When has attraction felt confusing or unexpected for you? What did you learn from that experience?" },
        { id: "pA3", text: "Does your level of emotional connection to someone strongly influence your sexual attraction? How so?" },
        { id: "pA4", text: "Consider an attraction that faded. What changed? Was it about them, you, or the context?" },
    ],
    "Interaction": [
        { id: "pI1", text: "Describe a time you felt most comfortable in a sexual interaction. Were you leading, following, or collaborating? What made it comfortable?" },
        { id: "pI2", text: "Imagine an ideal sexual encounter. What kind of energy exchange are you looking for (playful, intense, nurturing, commanding, yielding)?" },
        { id: "pI3", text: "How important is verbal communication vs non-verbal cues in your preferred interaction style?" },
        { id: "pI4", text: "If you enjoy power dynamics, what is the appeal of holding power? What is the appeal of yielding it?" },
    ],
    "Sensory": [
        { id: "pS1", text: "What type of physical touch (light, firm, rough, specific texture) feels most arousing or connecting to you, separate from orgasm?" },
        { id: "pS2", text: "Are there any specific sensations (temperature, pressure, pain, specific sounds/smells) that strongly enhance or detract from your arousal?" },
        { id: "pS3", text: "How does your desire for sensory input change depending on your mood or partner?" },
        { id: "pS4", text: "Think about a purely sensory experience (sexual or not) that felt transcendent or deeply satisfying. What were its key elements?" },
    ],
    "Psychological": [
        { id: "pP1", text: "Beyond physical pleasure, what core emotional need (e.g., connection, validation, control, escape) does sexuality most often fulfill for you?" },
        { id: "pP2", text: "Think about a time sex felt psychologically fulfilling. What underlying needs were met?" },
        { id: "pP3", text: "Conversely, when has sex felt psychologically unfulfilling, even if physically pleasurable? What might have been missing?" },
        { id: "pP4", text: "How does vulnerability play a role in your psychologically satisfying sexual experiences?" },
    ],
    "Cognitive": [
        { id: "pC1", text: "How much do you rely on fantasy or specific scenarios to become aroused? Are you more 'in your head' or 'in the moment'?" },
        { id: "pC2", text: "Describe a fantasy or scenario (even vaguely) that you find particularly potent. What elements make it work for you?" },
        { id: "pC3", text: "Does the intellectual or psychological aspect of a dynamic (e.g., power plays, witty banter, understanding motivations) contribute significantly to your arousal?" },
        { id: "pC4", text: "How does anticipation or memory shape your sexual experiences?" },
    ],
    "Relational": [
        { id: "pR1", text: "In what context do you feel most free to express your sexuality (e.g., alone, committed partner, casual encounter, group setting)?" },
        { id: "pR2", text: "How important are explicit agreements, rules, or boundaries regarding exclusivity or openness in your ideal sexual relationships?" },
        { id: "pR3", text: "What level of emotional intimacy do you typically prefer or require in your sexual connections?" },
        { id: "pR4", text: "How do concepts like jealousy or compersion (finding joy in a partner's joy with others) manifest in your relational landscape?" },
    ],
    // --- Dissonance Prompts ---
    "Dissonance": [
        { id: "pD1", text: "This concept seems quite different from your current profile. What aspect of it intrigues you or makes you curious, even if it feels unfamiliar?" },
        { id: "pD2", text: "Exploring unfamiliar territory can be revealing. What potential does engaging with this concept hold for you, even if it feels challenging or uncomfortable at first glance?" },
        { id: "pD3", text: "Sometimes, what we resist holds a key. Is there an underlying need or desire this concept touches upon, perhaps indirectly, that you haven't fully acknowledged?" },
        { id: "pD4", text: "How might integrating or simply understanding this concept broaden your perspective on your own sexuality or the diverse experiences of others?" }
    ],
    // --- Guided Prompts Section ---
    "Guided": {
        "LowAttunement": [
            { id: "gLA1", text: "You're just beginning your exploration. Which core element feels most intriguing or confusing to you right now, and why?" },
            { id: "gLA2", text: "Consider your initial scores. Was there anything that surprised you? How does it feel to start putting names to these aspects of yourself?" }
        ],
        "HighAttunementElement": [
            { id: "gHE1", text: "You show a strong resonance with [Element Name]. How does this element manifest in your fantasies or experiences? What nuances are emerging?" },
            { id: "gHE2", text: "Where might the 'shadow' or challenge lie within your strong connection to [Element Name]? Are there potential downsides or areas for growth?" }
        ],
        "ConceptSynergy": [
             { id: "gCS1", text: "You're focusing on both [Concept A] and [Concept B], which have potential synergy. How do these concepts interact or influence each other in your mind?" },
             { id: "gCS2", text: "What new possibilities or dynamics emerge when you consider [Concept A] and [Concept B] together? Does their combination create something unique?" }
        ]
        // Add more categories as needed
    }
}; // END of reflectionPrompts object

// --- Element Deep Dive Content ---
const elementDeepDive = {
    "A": [ // Attraction
        { level: 1, title: "Foundations of Attraction", insightCost: 5, content: "<p>Attraction is the spark. It dictates *what* or *who* initially draws your erotic attention. Level 1 explores the difference between primary attraction (often immediate, based on sensory cues like appearance or scent) and secondary attraction (developing after knowing someone, like demisexuality). It also touches on the spectrum from specific focus (fetishistic) to broad acceptance (pansexual).</p><ul><li>Primary vs. Secondary Attraction</li><li>Spectrum of Specificity</li><li>Common Orientations Overview</li></ul>" },
        { level: 2, title: "Beyond Gender: Nuances & Paraphilias", insightCost: 10, content: "<p>Level 2 delves deeper. How do aesthetics, personality archetypes, power dynamics, or even specific concepts become attractive? We introduce the idea of paraphilias (including fetishes) not as disorders, but as specific, intense focuses of attraction that can be integrated into a healthy sexuality. The key is understanding the *why* behind the *what*.</p><ul><li>Attraction to Dynamics (Power, Intellect)</li><li>Aesthetic Attraction</li><li>Understanding Paraphilias & Fetishes</li><li>Consent & Ethics in Niche Attractions</li></ul>" },
        { level: 3, title: "The Attraction-Arousal Link", insightCost: 15, content: "<p>Attraction doesn't always equal arousal, and arousal can occur without classic attraction (responsive desire). Level 3 explores this link. How does your specific Attraction Focus translate into physical or mental arousal? What role does context play? How does your attraction profile interact with other elements like Sensory input or Cognitive fantasy?</p><ul><li>Spontaneous vs. Responsive Desire</li><li>Context-Dependent Attraction</li><li>Interplay with Other Elements</li><li>Managing Unwanted Attractions</li></ul>" }
    ],
    "I": [ // Interaction
        { level: 1, title: "Roles & Energy Exchange", insightCost: 5, content: "<p>Interaction is the dance. Level 1 covers the fundamental roles: leading (Dominant, Top), following (submissive, bottom), and collaborating (Switch, Versatile). It's about the flow of energy – who initiates, who directs, who receives? How do you *prefer* to engage?</p><ul><li>Core Roles: Dom/sub, Top/Bottom</li><li>Switching & Versatility</li><li>Energy Flow: Giving vs. Receiving</li></ul>" },
        { level: 2, title: "Styles of Power Dynamics", insightCost: 10, content: "<p>Power exchange isn't monolithic. Level 2 explores different *styles*. Is it psychological command/control, nurturing caregiving/receiving, service-based, playful teasing, or intense protocol? Understanding your preferred style clarifies the *how* of your interaction.</p><ul><li>Psychological vs. Physical Dominance</li><li>Service & Worship Dynamics</li><li>Caregiver/Nurturing Roles</li><li>Playful vs. Formal Power Exchange</li></ul>" },
        { level: 3, title: "Communication & Negotiation in Interaction", insightCost: 15, content: "<p>Effective interaction, especially involving power dynamics or specific roles, relies heavily on communication. Level 3 focuses on negotiation, setting boundaries, using safewords, and the importance of enthusiastic consent. How do you communicate your needs and limits within your preferred interaction style?</p><ul><li>Negotiation & Scene Setting</li><li>Safewords & Limits</li><li>Consent Models (Enthusiastic, SSC, RACK)</li><li>Aftercare in Power Dynamics</li></ul>" }
    ],
    "S": [ // Sensory
        { level: 1, title: "The Spectrum of Sensation", insightCost: 5, content: "<p>Sensory input is the language of the body. Level 1 introduces the vast spectrum – from the gentlest caress to intense impact. It covers different types of touch (light, firm, sharp, dull), textures, temperatures, and the concept of erogenous zones beyond the obvious.</p><ul><li>Types of Touch</li><li>Temperature & Texture Play (Intro)</li><li>Mapping Your Erogenous Zones</li></ul>" },
        { level: 2, title: "Intensity, Pain & Pleasure", insightCost: 10, content: "<p>Why do some find intense sensation, even pain, arousing? Level 2 explores the pain/pleasure connection, endorphin release, and the psychological aspects of sensation play (BDSM). It covers impact play, restriction, and non-impact intensity like biting or pinching.</p><ul><li>Pain/Pleasure Paradox</li><li>Impact Play Fundamentals (Safety First!)</li><li>Restriction & Bondage Sensations</li><li>Non-Impact Intensity</li></ul>" },
        { level: 3, title: "Beyond Touch: Full Sensory Integration", insightCost: 15, content: "<p>Sexuality engages all senses. Level 3 explores the role of sight (visual cues, aesthetics), sound (music, voice tone, moans), smell (pheromones, scents), and even taste. How can you consciously incorporate or manipulate these other senses? This level also covers sensory deprivation and overload.</p><ul><li>Visual & Auditory Triggers</li><li>Olfactory & Gustatory Elements</li><li>Sensory Deprivation & Overload</li><li>Integrating Multiple Senses</li></ul>" }
    ],
    "P": [ // Psychological
        { level: 1, title: "Core Motivations", insightCost: 5, content: "<p>Why do you engage? Level 1 unpacks the common psychological drivers: connection/intimacy, validation/desirability, stress relief/escape, power/control (giving or receiving), self-expression/exploration, and simple fun/recreation. Identifying your primary drivers is key.</p><ul><li>Identifying Your Primary Drivers</li><li>Connection vs. Validation Needs</li><li>Sex for Escape vs. Expression</li></ul>" },
        { level: 2, title: "Vulnerability, Trust & Catharsis", insightCost: 10, content: "<p>Deeper psychological needs often involve vulnerability. Level 2 explores how trust is built and why surrendering control or sharing deep emotions can be profoundly fulfilling. It also examines how intense experiences or specific dynamics can lead to emotional release (catharsis).</p><ul><li>The Role of Vulnerability</li><li>Building Trust in Intimacy</li><li>Catharsis Through Intensity</li><li>Emotional Safety & Aftercare</li></ul>" },
        { level: 3, title: "Shadow Work & Integration", insightCost: 15, content: "<p>Our psychology has 'shadow' aspects – fears, insecurities, or desires we might repress. Level 3 explores how sexuality can sometimes bring these to the surface. How can understanding your psychological drivers help integrate these aspects? This involves looking at recurring themes, triggers, and potential links to past experiences (use caution, not therapy).</p><ul><li>Recognizing Psychological Themes</li><li>Sexuality and Self-Esteem</li><li>Potential 'Shadow' Manifestations</li><li>Integration vs. Repression</li></ul>" }
    ],
    "C": [ // Cognitive
        { level: 1, title: "Fantasy & Imagination", insightCost: 5, content: "<p>The mind is a powerful erotic engine. Level 1 introduces the role of fantasy – from fleeting thoughts to elaborate internal narratives. How active is your imagination during sex? Do you prefer being 'present' or 'in your head'?</p><ul><li>Spectrum of Mental Engagement</li><li>Common Fantasy Archetypes</li><li>Using Fantasy to Enhance Arousal</li></ul>" },
        { level: 2, title: "Scenarios, Role-Play & Scripting", insightCost: 10, content: "<p>Level 2 focuses on structured mental play. This includes specific role-playing scenarios (doctor/patient, etc.), understanding and playing with psychological dynamics (mind games, teasing), using dirty talk to build narrative, and the appeal of pre-planned or scripted scenes.</p><ul><li>Types of Role-Play</li><li>Psychological Games & Teasing</li><li>Narrative Through Language</li><li>Anticipation & Scripting</li></ul>" },
        { level: 3, title: "Intellect, Meaning & Transcendence", insightCost: 15, content: "<p>For some, the cognitive element goes deeper. Level 3 explores attraction to intelligence (sapiosexuality), finding meaning in symbolic acts or complex protocols, and using mental focus or altered states (like hypnosis play or edge play) to achieve transcendence or intense psychological shifts. How does intellect or conceptual understanding fuel your desire?</p><ul><li>Sapiosexuality & Intellectual Connection</li><li>Symbolism & Ritual in Play</li><li>Mind Games & Psychological Edge Play</li><li>Cognitive Paths to Altered States</li></ul>" }
    ],
    "R": [ // Relational
        { level: 1, title: "Structures & Numbers", insightCost: 5, content: "<p>How do you structure your intimate life? Level 1 covers the basics: solitary practice, monogamy (serial or lifelong), and the various forms of consensual non-monogamy (CNM) like open relationships and polyamory. What structure feels most natural or desirable?</p><ul><li>Solitary Sexuality</li><li>Monogamy vs. CNM Overview</li><li>Common CNM Structures (Open, Poly)</li></ul>" },
        { level: 2, title: "Commitment, Intimacy & Anonymity", insightCost: 10, content: "<p>Relationships exist on a spectrum of emotional depth. Level 2 explores the desired level of commitment and emotional intimacy within your preferred structure(s). Do you prefer deep bonds with few, shallower connections with many, or something else? What role does familiarity vs. anonymity play?</p><ul><li>Defining Commitment</li><li>Emotional Intimacy Levels</li><li>Familiarity vs. Anonymity</li><li>Friends With Benefits Dynamics</li></ul>" },
        { level: 3, title: "Hierarchy, Rules & Communication", insightCost: 15, content: "<p>How are multiple relationships managed (if applicable)? Level 3 discusses hierarchy (primary/secondary partners), the role of rules and agreements, and the crucial importance of communication, managing jealousy, and potentially experiencing compersion (joy in a partner's joy with others). It also touches on Relationship Anarchy's rejection of imposed structure.</p><ul><li>Hierarchy in Polyamory</li><li>Rules vs. Agreements</li><li>Communication Strategies in CNM</li><li>Jealousy & Compersion</li><li>Relationship Anarchy Principles</li></ul>" }
    ]
};

// --- Rituals & Milestones Data ---
const dailyRituals = [
    { id: "dr01", description: "Perform your Daily Meditation (Free Research).", reward: { type: "insight", amount: 2 }, track: { action: "freeResearch", count: 1, period: "daily" } },
    { id: "dr02", description: "Add 1 Concept to your Grimoire.", reward: { type: "insight", amount: 3 }, track: { action: "addToGrimoire", count: 1, period: "daily" } },
    { id: "dr03", description: "Complete a Reflection Prompt.", reward: { type: "insight", amount: 5 }, track: { action: "completeReflection", count: 1, period: "daily" } },
    { id: "dr04", description: "Focus on a new Concept.", reward: { type: "insight", amount: 4 }, track: { action: "markFocus", count: 1, period: "daily" } },
    { id: "dr05", description: "Conduct paid Research in any Element.", reward: { type: "attunement", element: "All", amount: 0.2 }, track: { action: "conductResearch", count: 1, period: "daily" } },
    { id: "dr06", description: "Unlock an Element Library level.", reward: { type: "attunement", element: "All", amount: 0.5 }, track: { action: "unlockLibrary", count: 1, period: "daily"} }
];

const milestones = [
    // Early Game & Discovery
    { id: "ms01", description: "First Concept Added!", reward: { type: "insight", amount: 5 }, track: { state: "discoveredConcepts.size", threshold: 1 } },
    { id: "ms02", description: "Curator I: Added 5 Concepts", reward: { type: "insight", amount: 10 }, track: { state: "discoveredConcepts.size", threshold: 5 } },
    { id: "ms15", description: "Curator II: Added 15 Concepts", reward: { type: "insight", amount: 15 }, track: { state: "discoveredConcepts.size", threshold: 15 } },
    { id: "ms25", description: "Curator III: Added 25 Concepts", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "discoveredConcepts.size", threshold: 25 } },
    { id: "ms40", description: "Curator IV: Added 40 Concepts", reward: { type: "insight", amount: 25 }, track: { state: "discoveredConcepts.size", threshold: 40 } },
    { id: "ms55", description: "Curator V: Added 55 Concepts", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "discoveredConcepts.size", threshold: 55 } },
    { id: "ms75", description: "Grand Curator: Added 75 Concepts", reward: { type: "insight", amount: 40 }, track: { state: "discoveredConcepts.size", threshold: 75 } },
    // Focus & Tapestry
    { id: "ms03", description: "First Focus Concept Marked", reward: { type: "insight", amount: 8 }, track: { state: "focusedConcepts.size", threshold: 1 } },
    { id: "ms04", description: "Tapestry Weaver I: Marked 3 Focus Concepts", reward: { type: "attunement", element: "All", amount: 1 }, track: { state: "focusedConcepts.size", threshold: 3 } },
    { id: "ms08", description: "Tapestry Weaver II: Marked 5 Focus Concepts", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "focusedConcepts.size", threshold: 5 } },
    { id: "ms18", description: "Tapestry Weaver III: Filled 7 Focus Slots", reward: { type: "insight", amount: 25 }, track: { state: "focusedConcepts.size", threshold: 7 } },
    { id: "ms35", description: "Tapestry Weaver IV: Filled 9 Focus Slots", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "focusedConcepts.size", threshold: 9 } },
    { id: "ms48", description: "Tapestry Master: Filled 12 Focus Slots", reward: { type: "insight", amount: 50 }, track: { state: "focusedConcepts.size", threshold: 12 } },
    // Research & Attunement
    { id: "ms05", description: "First Research Conducted", reward: { type: "insight", amount: 5 }, track: { action: "conductResearch", count: 1 } },
    { id: "ms06", description: "Elementalist I: Reached Attunement 10 in one Element", reward: { type: "insight", amount: 15 }, track: { state: "elementAttunement", threshold: 10, condition: "any" } },
    { id: "ms13", description: "Well Rounded I: Attunement 5+ in all Elements", reward: { type: "insight", amount: 20 }, track: { state: "elementAttunement", threshold: 5, condition: "all" } },
    { id: "ms20", description: "Elementalist II: Reached Attunement 50 in one Element", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "elementAttunement", threshold: 50, condition: "any" } },
    { id: "ms30", description: "Elementalist III: Reached Attunement 90 in one Element", reward: { type: "insight", amount: 40 }, track: { state: "elementAttunement", threshold: 90, condition: "any" } },
    { id: "ms45", description: "Well Rounded II: Attunement 25+ in all Elements", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "elementAttunement", threshold: 25, condition: "all" } },
    // Reflection & Growth
    { id: "ms07", description: "First Reflection Completed", reward: { type: "insight", amount: 5 }, track: { action: "completeReflection", count: 1 } },
    { id: "ms12", description: "Dissonance Embraced: Completed a Dissonance Reflection", reward: { type: "attunement", element: "All", amount: 1.5 }, track: { action: "completeReflectionDissonance", count: 1 } },
    { id: "ms22", description: "Self-Awareness: Completed 5 Reflections", reward: { type: "insight", amount: 20 }, track: { action: "completeReflection", count: 5 } },
    { id: "ms23", description: "Growth Mindset: Allowed Score Nudge after Reflection", reward: { type: "insight", amount: 10 }, track: { action: "scoreNudgeApplied", count: 1 } },
    { id: "ms38", description: "Deep Reflection: Completed 10 Reflections", reward: { type: "increaseFocusSlots", amount: 1 }, track: { action: "completeReflection", count: 10 } },
    // Specific Discoveries & Evolution
    { id: "ms09", description: "Attuned to Interaction: Reached Attunement 20 in Interaction", reward: { type: "discoverCard", cardId: 6 }, track: { state: "elementAttunement", element: "I", threshold: 20 } },
    { id: "ms10", description: "Deep Thinker: Reached Attunement 20 in Cognitive", reward: { type: "discoverCard", cardId: 14 }, track: { state: "elementAttunement", element: "C", threshold: 20 } },
    { id: "ms11", description: "First Art Evolution", reward: { type: "insight", amount: 20 }, track: { action: "evolveArt", count: 1 } },
    { id: "ms21", description: "Rare Find: Discovered a Rare Concept Card", reward: { type: "insight", amount: 15 }, track: { action: "discoverRareCard", count: 1 } },
    { id: "ms33", description: "Sensory Seeker: Reached Attunement 30 in Sensory", reward: { type: "discoverCard", cardId: 88 }, track: { state: "elementAttunement", element: "S", threshold: 30 } },
    { id: "ms42", description: "Art Appreciator: Evolved Art for 3 Concepts", reward: { type: "insight", amount: 30 }, track: { action: "evolveArt", count: 3 } },
    // Questionnaire Completion
    { id: "ms50", description: "Initial Experiment Complete", reward: { type: "insight", amount: 10 }, track: { action: "completeQuestionnaire", count: 1 } },
    // Library Milestones
    { id: "ms60", description: "Budding Scholar: Unlocked First Library Level", reward: { type: "insight", amount: 5 }, track: { action: "unlockLibrary", count: 1} },
    { id: "ms61", description: "Elemental Scholar: Unlocked Level 2 in one Element", reward: { type: "insight", amount: 10 }, track: { state: "unlockedDeepDiveLevels", threshold: 2, condition: "any"} },
    { id: "ms62", description: "Dedicated Scholar: Unlocked Level 3 in one Element", reward: { type: "insight", amount: 15 }, track: { state: "unlockedDeepDiveLevels", threshold: 3, condition: "any"} },
    { id: "ms63", description: "Omniscient Scholar: Unlocked Level 1 in all Elements", reward: { type: "increaseFocusSlots", amount: 1 }, track: { state: "unlockedDeepDiveLevels", threshold: 1, condition: "all"} }
];

console.log("data.js finished."); // Log for debugging load order
```

--- END OF FILE `data.js` (v11.2 - Verified Complete) ---

--- START OF FILE `script.js` (v11.2 - Verified Complete) ---

```javascript
// script.js - COMPLETE VERSION v11.2 (Added Data Availability Checks)
console.log("script.js starting..."); // Log for debugging load order

// --- Global State ---
let currentElementIndex = 0;
let userScores = { A: 5, I: 5, S: 5, P: 5, C: 5, R: 5 };
let userAnswers = {};
const elementNames = ["Attraction", "Interaction", "Sensory", "Psychological", "Cognitive", "Relational"];
const cardTypeKeys = ["Orientation", "Identity/Role", "Practice/Kink", "Psychological/Goal", "Relationship Style"];
let currentElementAnswers = {};
let currentlyDisplayedConceptId = null;
let discoveredConcepts = new Map(); // ID -> { concept, discoveredTime, artUnlocked: boolean, notes: string }
let focusedConcepts = new Set();
let focusSlotsTotal = 5;
const MAX_FOCUS_SLOTS = 12;
let userInsight = 10;
let elementAttunement = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 };
let unlockedDeepDiveLevels = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 };
const MAX_ATTUNEMENT = 100;
const BASE_RESEARCH_COST = 15;
const ART_EVOLVE_COST = 20;
const GUIDED_REFLECTION_COST = 3;
const DISSONANCE_THRESHOLD = 6.5;
const SCORE_NUDGE_AMOUNT = 0.15;
let freeResearchAvailableToday = false;
let currentReflectionContext = null;
let reflectionTargetConceptId = null;
let seenPrompts = new Set();
let completedRituals = { daily: {}, weekly: {} };
let achievedMilestones = new Set();
let lastLoginDate = null;
let cardsAddedSinceLastPrompt = 0;
let promptCooldownActive = false;
let currentReflectionElement = null;
let currentPromptId = null;
let toastTimeout = null;
let saveIndicatorTimeout = null;

// --- Persistence Key ---
const SAVE_KEY = 'personaAlchemyLabSaveData';

// --- DOM Elements (v11) ---
const saveIndicator = document.getElementById('saveIndicator');
const screens = document.querySelectorAll('.screen');
const startButton = document.getElementById('startGuidedButton');
const loadButton = document.getElementById('loadButton');
const questionnaireScreen = document.getElementById('questionnaireScreen');
const elementProgressHeader = document.getElementById('elementProgressHeader');
const questionContent = document.getElementById('questionContent');
const progressText = document.getElementById('progressText');
const dynamicScoreFeedback = document.getElementById('dynamicScoreFeedback');
const feedbackElementSpan = document.getElementById('feedbackElement');
const feedbackScoreSpan = document.getElementById('feedbackScore');
const feedbackScoreBar = document.getElementById('feedbackScoreBar');
const prevElementButton = document.getElementById('prevElementButton');
const nextElementButton = document.getElementById('nextElementButton');
const mainNavBar = document.getElementById('mainNavBar');
const navButtons = document.querySelectorAll('.nav-button');
const settingsButton = document.getElementById('settingsButton');
const personaScreen = document.getElementById('personaScreen');
const personaDetailedView = document.getElementById('personaDetailedView');
const personaSummaryView = document.getElementById('personaSummaryView');
const showDetailedViewBtn = document.getElementById('showDetailedViewBtn');
const showSummaryViewBtn = document.getElementById('showSummaryViewBtn');
const personaElementDetailsDiv = document.getElementById('personaElementDetails');
const userInsightDisplayPersona = document.getElementById('userInsightDisplayPersona');
const focusedConceptsDisplay = document.getElementById('focusedConceptsDisplay');
const focusedConceptsHeader = document.getElementById('focusedConceptsHeader');
const focusResonanceBarsContainer = document.getElementById('focusResonanceBars');
const tapestryNarrativeP = document.getElementById('tapestryNarrative');
const personaThemesList = document.getElementById('personaThemesList');
const summaryContentDiv = document.getElementById('summaryContent');
const studyScreen = document.getElementById('studyScreen');
const userInsightDisplayStudy = document.getElementById('userInsightDisplayStudy');
const researchButtonContainer = document.getElementById('researchButtonContainer');
const freeResearchButton = document.getElementById('freeResearchButton');
const seekGuidanceButton = document.getElementById('seekGuidanceButton');
const researchStatus = document.getElementById('researchStatus');
const researchOutput = document.getElementById('researchOutput');
const elementLibraryDiv = document.getElementById('elementLibrary');
const elementLibraryButtonsDiv = document.getElementById('elementLibraryButtons');
const elementLibraryContentDiv = document.getElementById('elementLibraryContent');
const grimoireScreen = document.getElementById('grimoireScreen');
const grimoireCountSpan = document.getElementById('grimoireCount');
const grimoireTypeFilter = document.getElementById('grimoireTypeFilter');
const grimoireElementFilter = document.getElementById('grimoireElementFilter');
const grimoireRarityFilter = document.getElementById('grimoireRarityFilter');
const grimoireSortOrder = document.getElementById('grimoireSortOrder');
const grimoireContentDiv = document.getElementById('grimoireContent');
const conceptDetailPopup = document.getElementById('conceptDetailPopup');
const popupOverlay = document.getElementById('popupOverlay');
const popupCardTypeIcon = document.getElementById('popupCardTypeIcon');
const popupConceptName = document.getElementById('popupConceptName');
const popupConceptType = document.getElementById('popupConceptType');
const popupVisualContainer = document.getElementById('popupVisualContainer');
const popupDetailedDescription = document.getElementById('popupDetailedDescription');
const popupResonanceSummary = document.getElementById('popupResonanceSummary');
const popupComparisonHighlights = document.getElementById('popupComparisonHighlights');
const popupConceptProfile = document.getElementById('popupConceptProfile');
const popupUserComparisonProfile = document.getElementById('popupUserComparisonProfile');
const popupRelatedConceptsList = document.getElementById('relatedConceptsList');
const myNotesSection = document.getElementById('myNotesSection');
const myNotesTextarea = document.getElementById('myNotesTextarea');
const saveMyNoteButton = document.getElementById('saveMyNoteButton');
const noteSaveStatusSpan = document.getElementById('noteSaveStatus');
const closePopupButton = document.getElementById('closePopupButton');
const addToGrimoireButton = document.getElementById('addToGrimoireButton');
const markAsFocusButton = document.getElementById('markAsFocusButton');
const elementAttunementDisplay = document.getElementById('elementAttunementDisplay');
const dailyRitualsDisplay = document.getElementById('dailyRitualsDisplay');
const milestonesDisplay = document.getElementById('milestonesDisplay');
const popupEvolutionSection = document.getElementById('popupEvolutionSection');
const evolveArtButton = document.getElementById('evolveArtButton');
const evolveCostSpan = document.getElementById('evolveCost');
const evolveEligibility = document.getElementById('evolveEligibility');
const reflectionModal = document.getElementById('reflectionModal');
const reflectionModalTitle = document.getElementById('reflectionModalTitle');
const closeReflectionModalButton = document.getElementById('closeReflectionModalButton');
const reflectionElement = document.getElementById('reflectionElement');
const reflectionPromptText = document.getElementById('reflectionPromptText');
const reflectionCheckbox = document.getElementById('reflectionCheckbox');
const scoreNudgeCheckbox = document.getElementById('scoreNudgeCheckbox');
const scoreNudgeLabel = document.getElementById('scoreNudgeLabel');
const confirmReflectionButton = document.getElementById('confirmReflectionButton');
const reflectionRewardAmount = document.getElementById('reflectionRewardAmount');
const settingsPopup = document.getElementById('settingsPopup');
const closeSettingsPopupButton = document.getElementById('closeSettingsPopupButton');
const forceSaveButton = document.getElementById('forceSaveButton');
const resetAppButton = document.getElementById('resetAppButton');
const milestoneAlert = document.getElementById('milestoneAlert');
const milestoneAlertText = document.getElementById('milestoneAlertText');
const closeMilestoneAlertButton = document.getElementById('closeMilestoneAlertButton');
const toastElement = document.getElementById('toastNotification');
const toastMessageElement = document.getElementById('toastMessage');

// --- Persistence Functions ---
function showSaveIndicator() {
    if (!saveIndicator) return;
    saveIndicator.classList.remove('hidden');
    if (saveIndicatorTimeout) clearTimeout(saveIndicatorTimeout);
    saveIndicatorTimeout = setTimeout(() => {
        saveIndicator.classList.add('hidden');
        saveIndicatorTimeout = null;
    }, 750);
}

function saveGameState() {
    showSaveIndicator();
    try {
        const stateToSave = {
            userScores,
            discoveredConcepts: Array.from(discoveredConcepts.entries()),
            focusedConcepts: Array.from(focusedConcepts),
            userInsight,
            elementAttunement,
            unlockedDeepDiveLevels,
            achievedMilestones: Array.from(achievedMilestones),
            completedRituals,
            lastLoginDate,
            focusSlotsTotal,
            seenPrompts: Array.from(seenPrompts),
            freeResearchAvailableToday,
            questionnaireCompleted: currentElementIndex >= elementNames.length,
            userAnswers,
        };
        localStorage.setItem(SAVE_KEY, JSON.stringify(stateToSave));
    } catch (error) {
        console.error("Error saving game state:", error);
        showTemporaryMessage("Error: Could not save progress!", 4000);
    }
}

function loadGameState() {
    console.log("Attempting to load game state...");
    const savedData = localStorage.getItem(SAVE_KEY);
    if (savedData) {
        try {
            const loadedState = JSON.parse(savedData);
            console.log("Saved data found:", loadedState);

            userScores = loadedState.userScores || { A: 5, I: 5, S: 5, P: 5, C: 5, R: 5 };
            discoveredConcepts = new Map(loadedState.discoveredConcepts || []);
            focusedConcepts = new Set(loadedState.focusedConcepts || []);
            userInsight = typeof loadedState.userInsight === 'number' ? loadedState.userInsight : 10;
            elementAttunement = loadedState.elementAttunement || { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 };
            unlockedDeepDiveLevels = loadedState.unlockedDeepDiveLevels || { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 };
            achievedMilestones = new Set(loadedState.achievedMilestones || []);
            completedRituals = loadedState.completedRituals || { daily: {}, weekly: {} };
            lastLoginDate = loadedState.lastLoginDate || null;
            focusSlotsTotal = typeof loadedState.focusSlotsTotal === 'number' ? loadedState.focusSlotsTotal : 5;
            seenPrompts = new Set(loadedState.seenPrompts || []);
            freeResearchAvailableToday = typeof loadedState.freeResearchAvailableToday === 'boolean' ? loadedState.freeResearchAvailableToday : false;
            userAnswers = loadedState.userAnswers || {};
            currentElementIndex = loadedState.questionnaireCompleted ? elementNames.length : 0;

            console.log("Game state loaded successfully.");
            showTemporaryMessage("Session Restored", 2000);
            return true;
        } catch (error) {
            console.error("Error loading or parsing game state:", error);
            localStorage.removeItem(SAVE_KEY);
            showTemporaryMessage("Error loading session. Starting fresh.", 4000);
            return false;
        }
    } else {
        console.log("No saved game state found.");
        if(loadButton) loadButton.classList.add('hidden');
        return false;
    }
}

function clearGameState() {
    console.log("Clearing saved game state...");
    localStorage.removeItem(SAVE_KEY);
    showTemporaryMessage("Progress Reset!", 3000);
    if(loadButton) loadButton.classList.add('hidden');
}

// --- Data Availability Check ---
let dataLoaded = false;
function checkDataLoaded() {
    if (!dataLoaded) {
        // Check if all expected global constants from data.js are defined
        dataLoaded = typeof elementDetails !== 'undefined' &&
                     typeof concepts !== 'undefined' &&
                     typeof questionnaireGuided !== 'undefined' &&
                     typeof reflectionPrompts !== 'undefined' &&
                     typeof elementDeepDive !== 'undefined' &&
                     typeof dailyRituals !== 'undefined' &&
                     typeof milestones !== 'undefined' &&
                     typeof elementKeyToFullName !== 'undefined';
        if (!dataLoaded) {
            console.error("CRITICAL: Data from data.js not loaded!");
            // Displaying an alert might be too disruptive if it's a temporary flicker,
            // but logging is essential. The functions calling this will return early.
            // alert("Error initializing application data. Please refresh.");
        }
    }
    return dataLoaded;
}

// --- Utility Maps (Defined AFTER data.js is expected to load) ---
const elementNameToKey = { "Attraction": "A", "Interaction": "I", "Sensory": "S", "Psychological": "P", "Cognitive": "C", "Relational": "R" };

// --- Utility & Setup Functions ---
function gainInsight(amount, source = "Unknown") {
    if (typeof amount !== 'number' || isNaN(amount)) return;
    if (amount === 0) return;
    const previousInsight = userInsight;
    userInsight = Math.max(0, userInsight + amount);
    const actualChange = userInsight - previousInsight;
    if (actualChange !== 0) {
        const action = actualChange > 0 ? "Gained" : "Spent";
        console.log(`${action} ${Math.abs(actualChange).toFixed(1)} Insight from ${source}. New total: ${userInsight.toFixed(1)}`);
        updateInsightDisplays();
        if(studyScreen && !studyScreen.classList.contains('hidden')) {
             displayElementLibrary();
        }
        saveGameState();
    }
}
function spendInsight(amount, source = "Unknown") {
    if (typeof amount !== 'number' || isNaN(amount) || amount <= 0) return false;
    if (userInsight >= amount) {
        gainInsight(-amount, source);
        return true;
    } else {
        showTemporaryMessage(`Not enough Insight! Need ${amount}.`, 3000);
        return false;
    }
}
function updateInsightDisplays() {
    const formattedInsight = userInsight.toFixed(1);
    if (userInsightDisplayPersona) userInsightDisplayPersona.textContent = formattedInsight;
    if (userInsightDisplayStudy) userInsightDisplayStudy.textContent = formattedInsight;
    displayResearchButtons();
    if (seekGuidanceButton) seekGuidanceButton.disabled = userInsight < GUIDED_REFLECTION_COST;
}
function getScoreLabel(score) { if (typeof score !== 'number' || isNaN(score)) return "N/A"; if (score >= 9) return "Very High"; if (score >= 7) return "High"; if (score >= 5) return "Moderate"; if (score >= 3) return "Low"; return "Very Low"; }
function getAffinityLevel(score) { if (typeof score !== 'number' || isNaN(score)) return null; if (score >= 8) return "High"; if (score >= 5) return "Moderate"; return null; }
function getElementColor(elementName) { const colors = { Attraction: '#FF6347', Interaction: '#4682B4', Sensory: '#32CD32', Psychological: '#FFD700', Cognitive: '#8A2BE2', Relational: '#FF8C00' }; return colors[elementName] || '#CCCCCC'; }
function hexToRgba(hex, alpha = 1) { if (!hex || typeof hex !== 'string') return `rgba(128,128,128, ${alpha})`; hex = hex.replace('#', ''); if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]; const bigint = parseInt(hex, 16); if (isNaN(bigint)) return `rgba(128,128,128, ${alpha})`; const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r},${g},${b},${alpha})`; }
function getCardTypeIcon(cardType) { switch (cardType) { case "Orientation": return "fa-solid fa-compass"; case "Identity/Role": return "fa-solid fa-mask"; case "Practice/Kink": return "fa-solid fa-gear"; case "Psychological/Goal": return "fa-solid fa-brain"; case "Relationship Style": return "fa-solid fa-heart"; default: return "fa-solid fa-question-circle"; } }
function getElementIcon(elementName) { switch (elementName) { case "Attraction": return "fa-solid fa-magnet"; case "Interaction": return "fa-solid fa-users"; case "Sensory": return "fa-solid fa-hand-sparkles"; case "Psychological": return "fa-solid fa-comment-dots"; case "Cognitive": return "fa-solid fa-lightbulb"; case "Relational": return "fa-solid fa-link"; default: return "fa-solid fa-atom"; } }
function euclideanDistance(userScoresObj, conceptScoresObj) {
    let sumOfSquares = 0; let validDimensions = 0;
    if (!userScoresObj || typeof userScoresObj !== 'object') { return Infinity; }
    if (!conceptScoresObj || typeof conceptScoresObj !== 'object') { return Infinity; }
    const expectedKeys = Object.keys(userScoresObj); if (expectedKeys.length === 0) { return Infinity; }
    for (const key of expectedKeys) {
        const s1 = userScoresObj[key]; const s2 = conceptScoresObj[key];
        const s1Valid = typeof s1 === 'number' && !isNaN(s1);
        const s2Valid = conceptScoresObj.hasOwnProperty(key) && typeof s2 === 'number' && !isNaN(s2);
        if (s1Valid && s2Valid) { sumOfSquares += Math.pow(s1 - s2, 2); validDimensions++; }
    }
    if (validDimensions === 0) return Infinity;
    return Math.sqrt(sumOfSquares);
}

// --- Screen Management ---
function showScreen(screenId) {
    console.log("Showing screen:", screenId);
    let targetIsMain = ['personaScreen', 'studyScreen', 'grimoireScreen'].includes(screenId);
    screens.forEach(screen => { screen.classList.toggle('current', screen.id === screenId); screen.classList.toggle('hidden', screen.id !== screenId); });
    if (mainNavBar) mainNavBar.classList.toggle('hidden', !targetIsMain);
    navButtons.forEach(button => { button.classList.toggle('active', button.dataset.target === screenId); });
    if (['questionnaireScreen', 'grimoireScreen', 'personaScreen', 'studyScreen'].includes(screenId)) { window.scrollTo(0, 0); }
}
function hidePopups() {
    if (conceptDetailPopup) conceptDetailPopup.classList.add('hidden');
    if (reflectionModal) reflectionModal.classList.add('hidden');
    if (settingsPopup) settingsPopup.classList.add('hidden');
    if (popupOverlay) popupOverlay.classList.add('hidden');
    currentlyDisplayedConceptId = null; currentReflectionElement = null; currentPromptId = null; currentReflectionContext = null; reflectionTargetConceptId = null;
}

// --- Initialization and Questionnaire Logic ---
function initializeQuestionnaire(forceReset = false) {
    if (!checkDataLoaded()) return;
    console.log(`[initializeQuestionnaire] Called. Force Reset: ${forceReset}`);
    const isResuming = !forceReset && localStorage.getItem(SAVE_KEY);
    if (!isResuming) {
        console.log("[initializeQuestionnaire] Resetting core state variables.");
        currentElementIndex = 0; userScores = { A: 5, I: 5, S: 5, P: 5, C: 5, R: 5 }; userAnswers = {}; elementNames.forEach(elName => { userAnswers[elName] = {}; });
        discoveredConcepts = new Map(); focusedConcepts = new Set(); userInsight = 10; focusSlotsTotal = 5;
        elementAttunement = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 }; unlockedDeepDiveLevels = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 };
        seenPrompts = new Set(); completedRituals = { daily: {}, weekly: {} }; achievedMilestones = new Set();
        lastLoginDate = null; cardsAddedSinceLastPrompt = 0; promptCooldownActive = false; freeResearchAvailableToday = false;
    } else {
        console.log("[initializeQuestionnaire] Skipping core state reset (resuming or loaded).");
        if (currentElementIndex < elementNames.length) { currentElementIndex = 0; userAnswers = {}; elementNames.forEach(elName => { userAnswers[elName] = {}; }); console.log("[initializeQuestionnaire] Restarting questionnaire from element 0."); }
    }
    updateElementProgressHeader(-1); displayElementQuestions(currentElementIndex); showScreen('questionnaireScreen');
    if (mainNavBar) mainNavBar.classList.add('hidden'); if(dailyRitualsDisplay) dailyRitualsDisplay.innerHTML = '<li>Loading...</li>'; if(milestonesDisplay) milestonesDisplay.innerHTML = '<li>None yet</li>'; if(elementAttunementDisplay) elementAttunementDisplay.innerHTML = ''; if(grimoireContentDiv) grimoireContentDiv.innerHTML = '<p>Grimoire empty.</p>'; if(focusedConceptsDisplay) focusedConceptsDisplay.innerHTML = '<li>Mark concepts as "Focus"...</li>'; if(researchButtonContainer) researchButtonContainer.innerHTML = ''; if(freeResearchButton) freeResearchButton.classList.add('hidden'); updateInsightDisplays(); updateFocusSlotsDisplay(); updateGrimoireCounter();
    if(personaDetailedView) personaDetailedView.classList.add('current'); if(personaDetailedView) personaDetailedView.classList.remove('hidden'); if(personaSummaryView) personaSummaryView.classList.add('hidden'); if(personaSummaryView) personaSummaryView.classList.remove('current'); if(showDetailedViewBtn) showDetailedViewBtn.classList.add('active'); if(showSummaryViewBtn) showSummaryViewBtn.classList.remove('active');
}
function updateElementProgressHeader(activeIndex) {
    if (!checkDataLoaded() || !elementProgressHeader) return;
    elementProgressHeader.innerHTML = ''; elementNames.forEach((name, index) => { const tab = document.createElement('div'); tab.classList.add('element-tab'); const elementData = elementDetails[name] || {}; tab.textContent = elementData.name || name; tab.title = elementData.name || name; tab.classList.toggle('completed', index < activeIndex); tab.classList.toggle('active', index === activeIndex); elementProgressHeader.appendChild(tab); });
}
function displayElementQuestions(index) {
    if (!checkDataLoaded()) return;
    if (index >= elementNames.length) { finalizeScoresAndShowPersona(); return; } const elementName = elementNames[index]; const elementData = elementDetails[elementName] || {}; const questions = questionnaireGuided[elementName] || []; const questionContentElement = document.getElementById('questionContent'); if (!questionContentElement) { console.error("!!! questionContent element not found !!!"); return; }
    let introHTML = `<div class="element-intro"><h2>${elementData.name || elementName}</h2><p><em>${elementData.coreQuestion || ''}</em></p><p>${elementData.coreConcept || 'Loading...'}</p><p><small><strong>Persona Connection:</strong> ${elementData.personaConnection || ''}</small></p></div>`; questionContentElement.innerHTML = introHTML; currentElementAnswers = { ...(userAnswers[elementName] || {}) }; let questionsHTML = '';
    if (questions && questions.length > 0) { questions.forEach(q => { let inputHTML = `<div class="question-block" id="block_${q.qId}"><h3 class="question-title">${q.text}</h3><div class="input-container">`; const savedAnswer = currentElementAnswers[q.qId]; if (q.type === "slider") { const val = savedAnswer !== undefined ? savedAnswer : q.defaultValue; inputHTML += ` <div class="slider-container"> <input type="range" id="${q.qId}" class="slider q-input" min="${q.minValue}" max="${q.maxValue}" step="${q.step || 0.5}" value="${val}" data-question-id="${q.qId}" data-type="slider"> <div class="label-container"> <span class="label-text">${q.minLabel}</span><span class="label-text">${q.maxLabel}</span> </div> <p class="value-text">Selected: <span id="display_${q.qId}">${parseFloat(val).toFixed(1)}</span></p> <p class="slider-feedback" id="feedback_${q.qId}"></p> </div>`; } else if (q.type === "radio") { inputHTML += `<div class="radio-options">`; q.options.forEach(opt => { const checked = savedAnswer === opt.value ? 'checked' : ''; inputHTML += `<div><input type="radio" id="${q.qId}_${opt.value}" class="q-input" name="${q.qId}" value="${opt.value}" ${checked} data-question-id="${q.qId}" data-type="radio"><label for="${q.qId}_${opt.value}">${opt.value}</label></div>`; }); inputHTML += `</div>`; } else if (q.type === "checkbox") { inputHTML += `<div class="checkbox-options">`; q.options.forEach(opt => { const checked = Array.isArray(savedAnswer) && savedAnswer.includes(opt.value) ? 'checked' : ''; inputHTML += `<div><input type="checkbox" id="${q.qId}_${opt.value}" class="q-input" name="${q.qId}" value="${opt.value}" ${checked} data-question-id="${q.qId}" data-max-choices="${q.maxChoices || 2}" data-type="checkbox"><label for="${q.qId}_${opt.value}">${opt.value}</label></div>`; }); inputHTML += `</div>`; } inputHTML += `</div></div>`; questionsHTML += inputHTML; }); } else { questionsHTML = '<p><em>(No questions defined)</em></p>'; }
    const introDiv = questionContentElement.querySelector('.element-intro'); if (introDiv) { introDiv.insertAdjacentHTML('afterend', questionsHTML); } else { questionContentElement.innerHTML += questionsHTML; }
    questionContentElement.querySelectorAll('.q-input').forEach(input => { const eventType = (input.type === 'range') ? 'input' : 'change'; input.addEventListener(eventType, handleQuestionnaireInputChange); }); questionContentElement.querySelectorAll('input[type="checkbox"].q-input').forEach(checkbox => { checkbox.addEventListener('change', (event) => enforceMaxChoices(checkbox.name, parseInt(checkbox.dataset.maxChoices || 2), event)); }); questionContentElement.querySelectorAll('.slider.q-input').forEach(slider => { updateSliderFeedbackText(slider); });
    updateElementProgressHeader(index); if (progressText) progressText.textContent = `Element ${index + 1} / ${elementNames.length}: ${elementData.name || elementName}`; updateDynamicFeedback(elementName); if (dynamicScoreFeedback) dynamicScoreFeedback.style.display = 'block'; if (prevElementButton) prevElementButton.style.visibility = (index > 0) ? 'visible' : 'hidden'; if (nextElementButton) nextElementButton.textContent = (index === elementNames.length - 1) ? "View My Persona" : "Next Element";
}
function updateSliderFeedbackText(sliderElement) {
    if (!checkDataLoaded()) return;
    if (!sliderElement || sliderElement.type !== 'range') return; const qId = sliderElement.dataset.questionId; const feedbackElement = document.getElementById(`feedback_${qId}`); if (!feedbackElement) return; const currentValue = parseFloat(sliderElement.value); const elementName = elementNames[currentElementIndex]; const interpretations = elementDetails?.[elementName]?.scoreInterpretations; if (!interpretations) { feedbackElement.textContent = `(Score: ${currentValue.toFixed(1)})`; return; } const scoreLabel = getScoreLabel(currentValue); const interpretationText = interpretations[scoreLabel] || `Interpretation for "${scoreLabel}" not found.`; feedbackElement.textContent = interpretationText; feedbackElement.title = `Meaning of score ${currentValue.toFixed(1)} (${scoreLabel})`;
}
function handleQuestionnaireInputChange(event) { const input = event.target; const type = input.dataset.type; const elementName = elementNames[currentElementIndex]; if (type === 'slider') { const qId = input.dataset.questionId; const display = document.getElementById(`display_${qId}`); if (display) display.textContent = parseFloat(input.value).toFixed(1); updateSliderFeedbackText(input); } collectCurrentElementAnswers(); updateDynamicFeedback(elementName); }
function enforceMaxChoices(name, max, event) { const checkboxes = questionContent?.querySelectorAll(`input[name="${name}"]:checked`); if (!checkboxes) return; if (checkboxes.length > max) { showTemporaryMessage(`Max ${max} options allowed.`, 2500); if (event?.target?.checked) { event.target.checked = false; collectCurrentElementAnswers(); updateDynamicFeedback(elementNames[currentElementIndex]); } } }
function collectCurrentElementAnswers() { const elementName = elementNames[currentElementIndex]; const questions = questionnaireGuided[elementName] || []; currentElementAnswers = {}; questions.forEach(q => { const qId = q.qId; const container = questionContent || document; if (q.type === 'slider') { const input = container.querySelector(`#${qId}.q-input`); if (input) currentElementAnswers[qId] = parseFloat(input.value); } else if (q.type === 'radio') { const checked = container.querySelector(`input[name="${qId}"]:checked`); if (checked) currentElementAnswers[qId] = checked.value; } else if (q.type === 'checkbox') { const checked = container.querySelectorAll(`input[name="${qId}"]:checked`); currentElementAnswers[qId] = Array.from(checked).map(cb => cb.value); } }); userAnswers[elementName] = { ...currentElementAnswers }; }
function updateDynamicFeedback(elementName) {
    if (!checkDataLoaded()) return;
    const elementData = elementDetails?.[elementName]; if (!elementData) return; if (!dynamicScoreFeedback || !feedbackElementSpan || !feedbackScoreSpan || !feedbackScoreBar) return; const tempScore = calculateElementScore(elementName, currentElementAnswers); const scoreLabel = getScoreLabel(tempScore); feedbackElementSpan.textContent = elementData.name || elementName; feedbackScoreSpan.textContent = tempScore.toFixed(1); let labelSpan = dynamicScoreFeedback.querySelector('.score-label'); if (labelSpan) { labelSpan.textContent = `(${scoreLabel})`; } feedbackScoreBar.style.width = `${tempScore * 10}%`;
}
function calculateElementScore(elementName, answersForElement) { const questions = questionnaireGuided[elementName] || []; let score = 5.0; questions.forEach(q => { const answer = answersForElement[q.qId]; let pointsToAdd = 0; if (q.type === 'slider') { const value = (answer !== undefined) ? answer : q.defaultValue; pointsToAdd = (value - q.defaultValue) * (q.scoreWeight || 1.0); } else if (q.type === 'radio') { const opt = q.options.find(o => o.value === answer); pointsToAdd = opt ? (opt.points || 0) * (q.scoreWeight || 1.0) : 0; } else if (q.type === 'checkbox' && Array.isArray(answer)) { answer.forEach(val => { const opt = q.options.find(o => o.value === val); pointsToAdd += opt ? (opt.points || 0) * (q.scoreWeight || 1.0) : 0; }); } score += pointsToAdd; }); return Math.max(0, Math.min(10, score)); }
function nextElement() { collectCurrentElementAnswers(); currentElementIndex++; displayElementQuestions(currentElementIndex); }
function prevElement() { collectCurrentElementAnswers(); currentElementIndex--; displayElementQuestions(currentElementIndex); }
function finalizeScoresAndShowPersona() {
    if (!checkDataLoaded()) return;
    console.log("Finalizing scores..."); const finalScores = {}; try { elementNames.forEach(elementName => { const score = calculateElementScore(elementName, userAnswers[elementName] || {}); const key = elementNameToKey[elementName]; if (key) { finalScores[key] = score; } else { console.warn(`Could not find key for element name: ${elementName}`); } }); userScores = finalScores; console.log("Final User Scores:", userScores); determineStarterHandAndEssence(); updateMilestoneProgress('completeQuestionnaire', 1); checkForDailyLogin(); displayPersonaScreen(); displayStudyScreenContent(); displayDailyRituals(); displayMilestones(); populateGrimoireFilters(); updateGrimoireCounter(); displayGrimoire(); saveGameState(); showScreen('personaScreen'); showTemporaryMessage("Experiment Complete! Explore your results.", 4000); } catch (error) { console.error("Error during finalizeScoresAndShowPersona sequence:", error); try { showScreen('welcomeScreen'); alert("An error occurred during setup. Please check console and try restarting."); } catch (fallbackError) { console.error("Error during fallback sequence:", fallbackError); document.body.innerHTML = "<h1>Critical Error</h1><p>Setup failed. Check console (F12) and refresh.</p>"; } }
}

// --- Starter Hand & Resource Granting ---
function determineStarterHandAndEssence() {
    if (!checkDataLoaded()) return;
    console.log("[determineStarterHand] Function called."); discoveredConcepts = new Map(); if (!concepts || !Array.isArray(concepts) || concepts.length === 0) { console.error("[determineStarterHand] 'concepts' array is missing!"); return; } if (typeof elementKeyToFullName === 'undefined' || !elementKeyToFullName) { console.error("[determineStarterHand] 'elementKeyToFullName' map missing!"); return; } let conceptsWithDistance = []; concepts.forEach((c, index) => { if (!c || typeof c !== 'object' || !c.id || !c.elementScores) { return; } const distance = euclideanDistance(userScores, c.elementScores); if (distance !== Infinity && typeof distance === 'number' && !isNaN(distance)) { conceptsWithDistance.push({ ...c, distance: distance }); } }); if (conceptsWithDistance.length === 0) { console.error("[determineStarterHand] No concepts comparable!"); return; } conceptsWithDistance.sort((a, b) => a.distance - b.distance); const candidates = conceptsWithDistance.slice(0, 20); const starterHand = []; const representedElements = new Set(); const starterHandIds = new Set(); const targetHandSize = 7; for (const c of candidates) { if (starterHand.length >= 4) break; if (!starterHandIds.has(c.id)) { starterHand.push(c); starterHandIds.add(c.id); if (c.primaryElement) representedElements.add(c.primaryElement); } } for (const c of candidates) { if (starterHand.length >= targetHandSize) break; if (starterHandIds.has(c.id)) continue; const needsRepresentation = c.primaryElement && !representedElements.has(c.primaryElement); if (needsRepresentation || representedElements.size < 4 || starterHand.length < 5) { starterHand.push(c); starterHandIds.add(c.id); if (c.primaryElement) representedElements.add(c.primaryElement); } } for (const c of candidates) { if (starterHand.length >= targetHandSize) break; if (!starterHandIds.has(c.id)) { starterHand.push(c); starterHandIds.add(c.id); } } console.log("[determineStarterHand] Starter Hand Selected:", starterHand.map(c => c.name)); if (starterHand.length === 0) { console.error("[determineStarterHand] Failed to select starter hand!"); return; } starterHand.forEach(concept => { if (!discoveredConcepts.has(concept.id)) { discoveredConcepts.set(concept.id, { concept: concept, discoveredTime: Date.now(), artUnlocked: false, notes: "" }); gainAttunementForAction('discover', concept.primaryElement); } }); console.log(`[determineStarterHand] Discovered Concepts Count: ${discoveredConcepts.size}`);
}

// --- Attunement ---
function gainAttunementForAction(actionType, elementKey = null, amount = 0.5) {
    if (!checkDataLoaded()) return;
    let targetKeys = []; const gainAmount = amount; if (elementKey && elementAttunement.hasOwnProperty(elementKey)) { targetKeys.push(elementKey); } else if (actionType === 'completeReflection' && currentReflectionElement) { const key = elementNameToKey[currentReflectionElement]; if (key && elementAttunement.hasOwnProperty(key)) { targetKeys.push(key); } } else if (['generic', 'completeReflectionGeneric', 'scoreNudge', 'ritual', 'milestone'].includes(actionType) || elementKey === 'All') { targetKeys = Object.keys(elementAttunement); amount = (actionType === 'generic') ? 0.1 : (actionType === 'completeReflectionGeneric') ? 0.2 : (actionType === 'scoreNudge') ? 0.5 / targetKeys.length : amount; } else { return; } let changed = false; targetKeys.forEach(key => { const currentAttunement = elementAttunement[key] || 0; const newAttunement = Math.min(MAX_ATTUNEMENT, currentAttunement + gainAmount); if (newAttunement > currentAttunement) { elementAttunement[key] = newAttunement; changed = true; updateMilestoneProgress('elementAttunement', { [key]: newAttunement }); updateMilestoneProgress('elementAttunement', elementAttunement); } }); if (changed) { console.log(`Attunement updated (${actionType}, Key: ${elementKey || 'Multi'}) by ${gainAmount.toFixed(1)}`); displayElementAttunement(); saveGameState(); }
}
function displayElementAttunement() {
    if (!checkDataLoaded() || !elementAttunementDisplay) return;
    elementAttunementDisplay.innerHTML = ''; elementNames.forEach(elName => { const key = elementNameToKey[elName]; const attunementValue = elementAttunement[key] || 0; const percentage = (attunementValue / MAX_ATTUNEMENT) * 100; elementAttunementDisplay.innerHTML += `<div class="attunement-item"><span class="attunement-name">${elementDetails[elName]?.name || elName}:</span><div class="attunement-bar-container" title="${attunementValue.toFixed(1)} / ${MAX_ATTUNEMENT}"><div class="attunement-bar" style="width: ${percentage}%; background-color: ${getElementColor(elName)};"></div></div></div>`; });
}

// --- Persona Screen Functions ---
function updateFocusSlotsDisplay() { if (focusedConceptsHeader) { focusedConceptsHeader.textContent = `Focused Concepts (${focusedConcepts.size} / ${focusSlotsTotal})`; } }
function displayPersonaScreen() {
    if (!checkDataLoaded()) return;
    if (!personaElementDetailsDiv) return; personaElementDetailsDiv.innerHTML = '';
    elementNames.forEach(elementName => { const key = elementNameToKey[elementName]; const score = userScores[key]; const scoreLabel = getScoreLabel(score); const elementData = elementDetails[elementName] || {}; const interpretation = elementData.scoreInterpretations?.[scoreLabel] || "N/A"; const barWidth = score ? (score / 10) * 100 : 0; const color = getElementColor(elementName); const details = document.createElement('details'); details.classList.add('element-detail-entry'); details.style.setProperty('--element-color', color); details.innerHTML = `<summary class="element-detail-header"><div><strong>${elementData.name || elementName}:</strong><span>${score?.toFixed(1) ?? '?'}</span> <span class="score-label">(${scoreLabel})</span></div><div class="score-bar-container"><div style="width: ${barWidth}%; background-color: ${color};"></div></div></summary><div class="element-description"><p><strong>Core Concept:</strong> ${elementData.coreConcept || ''}</p><p><strong>Elaboration:</strong> ${elementData.elaboration || ''}</p><hr><p><strong>Your Score (${scoreLabel}):</strong> ${interpretation}</p><p><small><strong>Examples:</strong> ${elementData.examples || ''}</small></p></div>`; personaElementDetailsDiv.appendChild(details); });
    updateInsightDisplays(); displayElementAttunement(); displayFocusedConceptsPersona(); updateFocusElementalResonance(); generateTapestryNarrative(); synthesizeAndDisplayThemesPersona(); displayMilestones(); displayPersonaSummary();
}
function displayFocusedConceptsPersona() { if (!checkDataLoaded() || !focusedConceptsDisplay) return; focusedConceptsDisplay.innerHTML = ''; updateFocusSlotsDisplay(); if (focusedConcepts.size === 0) { focusedConceptsDisplay.innerHTML = `<li>Mark concepts as "Focus" to weave your active Tapestry (Max ${focusSlotsTotal}).</li>`; return; } focusedConcepts.forEach(conceptId => { const conceptData = discoveredConcepts.get(conceptId); if (conceptData?.concept) { const concept = conceptData.concept; const item = document.createElement('div'); item.classList.add('focus-concept-item'); item.dataset.conceptId = concept.id; item.title = `View ${concept.name}`; item.innerHTML = `<i class="${getCardTypeIcon(concept.cardType)}"></i><span class="name">${concept.name}</span><span class="type">(${concept.cardType})</span>`; item.addEventListener('click', () => showConceptDetailPopup(concept.id)); focusedConceptsDisplay.appendChild(item); } else { console.warn(`Focused concept ID ${conceptId} not found in discoveredConcepts.`); } }); }
function synthesizeAndDisplayThemesPersona() {
    if (!checkDataLoaded()) return;
    if (!personaThemesList) return; personaThemesList.innerHTML = ''; if (focusedConcepts.size === 0) { personaThemesList.innerHTML = '<li>Mark Focused Concepts to reveal dominant themes.</li>'; return; } if (typeof elementKeyToFullName === 'undefined') { return; } const elementCountsByKey = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 }; const themeThreshold = 7.0; focusedConcepts.forEach(id => { const discoveredData = discoveredConcepts.get(id); const concept = discoveredData?.concept; if (concept?.elementScores) { for (const key in concept.elementScores) { if (elementKeyToFullName.hasOwnProperty(key) && concept.elementScores[key] >= themeThreshold) { elementCountsByKey[key]++; } } } }); const sortedThemes = Object.entries(elementCountsByKey).filter(([key, count]) => count > 0 && elementDetails[elementKeyToFullName[key]]).sort(([, a], [, b]) => b - a).map(([key, count]) => ({ name: elementDetails[elementKeyToFullName[key]]?.name || key, count })); if (sortedThemes.length === 0) { personaThemesList.innerHTML = `<li>No strong themes (element score >= ${themeThreshold.toFixed(1)}) detected.</li>`; return; } sortedThemes.slice(0, 3).forEach(theme => { const li = document.createElement('li'); li.textContent = `${theme.name} Focus (${theme.count} concept${theme.count > 1 ? 's' : ''})`; personaThemesList.appendChild(li); });
}
function updateFocusElementalResonance() {
    if (!checkDataLoaded() || !focusResonanceBarsContainer) return;
    focusResonanceBarsContainer.innerHTML = ''; const focusScores = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 }; let focusCount = focusedConcepts.size; if (focusCount > 0) { focusedConcepts.forEach(id => { const data = discoveredConcepts.get(id); if (data?.concept?.elementScores) { for (const key in focusScores) { if (data.concept.elementScores.hasOwnProperty(key)) { focusScores[key] += data.concept.elementScores[key]; } } } }); for (const key in focusScores) { focusScores[key] /= focusCount; } } elementNames.forEach(elName => { const key = elementNameToKey[elName]; const avgScore = focusScores[key] || 0; const percentage = Math.max(0, Math.min(100, (avgScore / 10) * 100)); const color = getElementColor(elName); const name = elementDetails[elName]?.name || elName; const item = document.createElement('div'); item.classList.add('focus-resonance-item'); item.innerHTML = ` <span class="focus-resonance-name">${name}:</span> <div class="focus-resonance-bar-container" title="${avgScore.toFixed(1)} Avg Score"> <div class="focus-resonance-bar" style="width: ${percentage}%; background-color: ${color};"></div> </div>`; focusResonanceBarsContainer.appendChild(item); });
}
function generateTapestryNarrative() {
    if (!checkDataLoaded() || !tapestryNarrativeP) return;
    const focusCount = focusedConcepts.size; if (focusCount === 0) { tapestryNarrativeP.textContent = 'Mark concepts as "Focus" to weave your narrative...'; return; } const focusScores = { A: 0, I: 0, S: 0, P: 0, C: 0, R: 0 }; focusedConcepts.forEach(id => { const data = discoveredConcepts.get(id); if (data?.concept?.elementScores) { for (const key in focusScores) { if (data.concept.elementScores.hasOwnProperty(key)) { focusScores[key] += data.concept.elementScores[key]; } } } }); for (const key in focusScores) { focusScores[key] /= focusCount; } const sortedElements = Object.entries(focusScores).filter(([key, score]) => score > 0).sort(([, a], [, b]) => b - a); if (sortedElements.length === 0) { tapestryNarrativeP.textContent = 'Your focused concepts show a balanced, subtle essence.'; return; } const [topKey, topScore] = sortedElements[0]; const topElementName = elementDetails[elementKeyToFullName[topKey]]?.name || topKey; let topConceptName = ""; for (const id of focusedConcepts) { const data = discoveredConcepts.get(id); if (data?.concept?.primaryElement === topKey || (data?.concept?.elementScores[topKey] || 0) >= 7) { topConceptName = data.concept.name; break; } } if (!topConceptName && focusedConcepts.size > 0) { topConceptName = discoveredConcepts.get(focusedConcepts.values().next().value)?.concept?.name || "?"; } let narrative = `Your current tapestry resonates strongly with **${topElementName}**`; if (topConceptName) narrative += `, reflected in your focus on **${topConceptName}**. `; else narrative += ". "; if (sortedElements.length > 1) { const [secondKey, secondScore] = sortedElements[1]; if (secondScore > 3.5) { const secondElementName = elementDetails[elementKeyToFullName[secondKey]]?.name || secondKey; let secondConceptName = ""; for (const id of focusedConcepts) { const data = discoveredConcepts.get(id); if(data?.concept?.name === topConceptName) continue; if (data?.concept?.primaryElement === secondKey || (data?.concept?.elementScores[secondKey] || 0) >= 6) { secondConceptName = data.concept.name; break; } } narrative += `Undercurrents of **${secondElementName}** add complexity`; if(secondConceptName) narrative += ` through **${secondConceptName}**.`; else narrative += "."; } } const topLabel = getScoreLabel(topScore); if (topLabel === "Very High" || topLabel === "High") narrative += ` This suggests a persona currently emphasizing ${topElementName.toLowerCase()}-driven expression.`; else if (topLabel === "Moderate") narrative += ` This indicates a balanced approach with a notable ${topElementName.toLowerCase()} facet.`; tapestryNarrativeP.innerHTML = narrative.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}
function displayPersonaSummary() {
    if (!checkDataLoaded() || !summaryContentDiv) return;
    summaryContentDiv.innerHTML = ''; let html = '<h3>Core Essence</h3><p>'; elementNames.forEach(elName => { const key = elementNameToKey[elName]; const score = userScores[key]; const label = getScoreLabel(score); const interpretation = elementDetails[elName]?.scoreInterpretations?.[label] || "N/A"; html += `<strong>${elementDetails[elName]?.name || elName} (${score.toFixed(1)} - ${label}):</strong> ${interpretation}<br>`; }); html += '</p><hr>'; html += '<h3>Focused Tapestry</h3>'; if (focusedConcepts.size > 0) { const narrativeText = tapestryNarrativeP.innerHTML; html += `<p><em>${narrativeText || "No narrative generated."}</em></p>`; html += '<strong>Focused Concepts:</strong><ul>'; focusedConcepts.forEach(id => { const name = discoveredConcepts.get(id)?.concept?.name || `Concept ID ${id}`; html += `<li>${name}</li>`; }); html += '</ul>'; const themeItems = personaThemesList.innerHTML; if (themeItems && !themeItems.includes("<li>")) { html += '<strong>Dominant Themes:</strong><ul>' + themeItems + '</ul>'; } else if (themeItems) { html += '<strong>Dominant Themes:</strong><p>' + themeItems + '</p>'; } } else { html += '<p>No concepts are currently focused.</p>'; } html += '<hr>'; html += '<h3>Key Milestones</h3>'; const milestoneItems = milestonesDisplay.innerHTML; if (milestoneItems && !milestoneItems.includes("None yet")) { html += '<ul>' + milestoneItems + '</ul>'; } else { html += '<p>No milestones achieved yet.</p>'; } summaryContentDiv.innerHTML = html;
}

// --- Study Screen Functions ---
function displayStudyScreenContent() { if (!checkDataLoaded()) return; updateInsightDisplays(); displayResearchButtons(); displayDailyRituals(); displayElementLibrary(); }
function displayResearchButtons() {
    if (!checkDataLoaded() || !researchButtonContainer) return;
    researchButtonContainer.innerHTML = ''; if (freeResearchAvailableToday && freeResearchButton) { freeResearchButton.classList.remove('hidden'); freeResearchButton.disabled = false; freeResearchButton.textContent = "Perform Daily Meditation (Free Research)"; freeResearchButton.onclick = handleFreeResearchClick; } else if (freeResearchButton) { freeResearchButton.disabled = true; freeResearchButton.textContent = freeResearchAvailableToday === false ? "Daily Meditation Performed" : "Perform Daily Meditation"; } elementNames.forEach(elName => { const key = elementNameToKey[elName]; const currentAttunement = elementAttunement[key] || 0; let currentCost = BASE_RESEARCH_COST; if (currentAttunement > 80) currentCost = Math.max(5, BASE_RESEARCH_COST - 5); else if (currentAttunement > 50) currentCost = Math.max(5, BASE_RESEARCH_COST - 3); const canAfford = userInsight >= currentCost; const fullName = elementDetails[elName]?.name || elName; const button = document.createElement('button'); button.classList.add('button', 'research-button'); button.dataset.elementKey = key; button.dataset.cost = currentCost; button.disabled = !canAfford; button.title = `Focus on ${fullName} (Cost: ${currentCost} Insight)`; button.innerHTML = ` <span class="research-el-icon" style="color: ${getElementColor(elName)};"><i class="${getElementIcon(fullName)}"></i></span> <span class="research-el-name">${fullName}</span> <span class="research-el-cost">${currentCost} <i class="fas fa-brain insight-icon"></i></span> `; button.addEventListener('click', handleResearchClick); researchButtonContainer.appendChild(button); }); if (seekGuidanceButton) seekGuidanceButton.disabled = userInsight < GUIDED_REFLECTION_COST;
}
function handleResearchClick(event) { const button = event.currentTarget; const elementKey = button.dataset.elementKey; const currentCost = parseFloat(button.dataset.cost); if (!elementKey || isNaN(currentCost) || button.disabled) return; if (spendInsight(currentCost, `Research: ${elementKeyToFullName[elementKey]}`)) { console.log(`Spent ${currentCost} Insight researching ${elementKey}.`); conductResearch(elementKey); updateMilestoneProgress('conductResearch', 1); checkAndUpdateRituals('conductResearch'); } }
function handleFreeResearchClick() { if (!freeResearchAvailableToday) { showTemporaryMessage("Daily meditation already performed today.", 3000); return; } const keys = Object.keys(elementAttunement); let targetKey = keys[0]; let minAttunement = MAX_ATTUNEMENT + 1; keys.forEach(key => { if (elementAttunement[key] < minAttunement) { minAttunement = elementAttunement[key]; targetKey = key; } }); console.log(`Performing free daily meditation on ${targetKey} (${elementKeyToFullName[targetKey]})`); freeResearchAvailableToday = false; if (freeResearchButton) { freeResearchButton.disabled = true; freeResearchButton.textContent = "Daily Meditation Performed"; } conductResearch(targetKey); updateMilestoneProgress('freeResearch', 1); checkAndUpdateRituals('freeResearch'); saveGameState(); }
function conductResearch(elementKeyToResearch) {
    if (!checkDataLoaded()) return;
    if (typeof elementKeyToFullName === 'undefined') return; const elementFullName = elementKeyToFullName[elementKeyToResearch]; if (!elementFullName) return; console.log(`Researching: ${elementFullName} (Key: ${elementKeyToResearch})`); if (researchStatus) researchStatus.textContent = `Reviewing notes on ${elementDetails[elementFullName]?.name || elementFullName}...`; if (researchOutput) researchOutput.innerHTML = ''; const discoveredIds = new Set(discoveredConcepts.keys()); const undiscoveredPool = concepts.filter(c => !discoveredIds.has(c.id)); if (undiscoveredPool.length === 0) { if (researchStatus) researchStatus.textContent = "Research complete. No more concepts to discover."; if (researchOutput) researchOutput.innerHTML = '<p><i>The library holds all known concepts.</i></p>'; gainInsight(5.0, "All Concepts Discovered Bonus"); return; } const currentAttunement = elementAttunement[elementKeyToResearch] || 0; const priorityPool = []; const secondaryPool = []; const tertiaryPool = []; undiscoveredPool.forEach(c => { const score = c.elementScores?.[elementKeyToResearch] || 0; const isPrimary = c.primaryElement === elementKeyToResearch; if (isPrimary || score >= 7.5) { priorityPool.push(c); } else if (score >= 4.5) { secondaryPool.push(c); } else { tertiaryPool.push(c); } }); const selectedForOutput = []; let duplicateInsightGain = 0; const numberOfResults = 3; const selectWeightedRandomFromPools = () => { const pools = [ { pool: priorityPool, weightMultiplier: 3.0 }, { pool: secondaryPool, weightMultiplier: 1.5 }, { pool: tertiaryPool, weightMultiplier: 1.0 } ]; let combinedWeightedPool = []; let totalWeight = 0; pools.forEach(({ pool, weightMultiplier }) => { pool.forEach(card => { let weight = 1.0 * weightMultiplier; const rarityBonus = 1 + (currentAttunement / MAX_ATTUNEMENT); if (card.rarity === 'uncommon') weight *= (1.5 * rarityBonus); if (card.rarity === 'rare') weight *= (2.0 * rarityBonus); totalWeight += weight; combinedWeightedPool.push({ card, weight }); }); }); if (combinedWeightedPool.length === 0) return null; let randomPick = Math.random() * totalWeight; let chosenItem = null; for (let i = 0; i < combinedWeightedPool.length; i++) { chosenItem = combinedWeightedPool[i]; if (randomPick < chosenItem.weight) { [priorityPool, secondaryPool, tertiaryPool].forEach(p => { const index = p.findIndex(c => c.id === chosenItem.card.id); if (index > -1) p.splice(index, 1); }); return chosenItem.card; } randomPick -= chosenItem.weight; } const flatPool = [...priorityPool, ...secondaryPool, ...tertiaryPool]; if (flatPool.length > 0) { const fallbackIndex = Math.floor(Math.random() * flatPool.length); const chosenCard = flatPool[fallbackIndex]; [priorityPool, secondaryPool, tertiaryPool].forEach(p => { const index = p.findIndex(c => c.id === chosenCard.id); if (index > -1) p.splice(index, 1); }); return chosenCard; } return null; }; let attempts = 0; const maxAttempts = numberOfResults * 3; while (selectedForOutput.length < numberOfResults && attempts < maxAttempts && (priorityPool.length > 0 || secondaryPool.length > 0 || tertiaryPool.length > 0)) { attempts++; let potentialCard = selectWeightedRandomFromPools(); if (potentialCard) { if (discoveredConcepts.has(potentialCard.id)) { gainInsight(1.0, `Duplicate Research (${potentialCard.name})`); duplicateInsightGain += 1.0; } else { selectedForOutput.push(potentialCard); } } else { break; } } let resultMessage = ""; if (selectedForOutput.length > 0) { resultMessage = `Discovered ${selectedForOutput.length} new potential concept(s)! `; selectedForOutput.forEach(concept => { const resultItemDiv = document.createElement('div'); resultItemDiv.classList.add('research-result-item'); const cardElement = renderCard(concept, 'research-output'); resultItemDiv.appendChild(cardElement); const addButton = document.createElement('button'); addButton.textContent = "Add to Grimoire"; addButton.classList.add('button', 'small-button', 'research-action-button'); addButton.dataset.conceptId = concept.id; addButton.onclick = (e) => { const btn = e.target; const id = parseInt(btn.dataset.conceptId); if (!isNaN(id)) { addConceptToGrimoireById(id, btn); } }; resultItemDiv.appendChild(addButton); if (researchOutput) researchOutput.appendChild(resultItemDiv); }); gainAttunementForAction('researchSuccess', elementKeyToResearch, 0.8); if (selectedForOutput.some(c => c.rarity === 'rare')) { updateMilestoneProgress('discoverRareCard', 1); } } else { resultMessage = "No new concepts discovered this time. "; if (researchOutput) researchOutput.innerHTML = '<p><i>Familiar thoughts echo... Perhaps try a different focus or deepen existing knowledge?</i></p>'; gainAttunementForAction('researchFail', elementKeyToResearch, 0.2); } if (duplicateInsightGain > 0) { resultMessage += ` Gained ${duplicateInsightGain.toFixed(0)} Insight from echoes.`; if (researchOutput && selectedForOutput.length > 0) { const dupeMsg = document.createElement('p'); dupeMsg.classList.add('duplicate-message'); dupeMsg.innerHTML = `<i class="fas fa-info-circle"></i> Gained ${duplicateInsightGain.toFixed(0)} Insight from duplicate research echoes.`; researchOutput.prepend(dupeMsg); } } if (researchStatus) researchStatus.textContent = resultMessage.trim();
}

// --- Grimoire Functions ---
function displayGrimoire(filterType = "All", filterElement = "All", sortBy = "discovered", filterRarity = "All") { if (!checkDataLoaded() || !grimoireContentDiv) return; grimoireContentDiv.innerHTML = ''; if (discoveredConcepts.size === 0) { grimoireContentDiv.innerHTML = '<p>Your Grimoire is empty. Conduct Research to discover Concepts!</p>'; return; } let discoveredArray = Array.from(discoveredConcepts.values()); const conceptsToDisplay = discoveredArray.filter(data => { if (!data || !data.concept) return false; const concept = data.concept; const typeMatch = (filterType === "All") || (concept.cardType === filterType); const elementKey = filterElement !== "All" ? elementNameToKey[filterElement] : "All"; const elementMatch = (elementKey === "All") || (concept.primaryElement === elementKey); const rarityMatch = (filterRarity === "All") || (concept.rarity === filterRarity); return typeMatch && elementMatch && rarityMatch; }); const rarityOrder = { 'common': 1, 'uncommon': 2, 'rare': 3 }; conceptsToDisplay.sort((a, b) => { if (!a.concept || !b.concept) return 0; switch (sortBy) { case 'name': return a.concept.name.localeCompare(b.concept.name); case 'type': return a.concept.cardType.localeCompare(b.concept.cardType) || a.concept.name.localeCompare(b.concept.name); case 'rarity': return (rarityOrder[a.concept.rarity] || 0) - (rarityOrder[b.concept.rarity] || 0) || a.concept.name.localeCompare(b.concept.name); default: return a.discoveredTime - b.discoveredTime; } }); if (conceptsToDisplay.length === 0) { grimoireContentDiv.innerHTML = `<p>No discovered concepts match the current filters.</p>`; } else { conceptsToDisplay.forEach(data => { const cardElement = renderCard(data.concept, 'grimoire'); grimoireContentDiv.appendChild(cardElement); }); } }
function populateGrimoireFilters() {
    if (!checkDataLoaded()) return;
    if (grimoireTypeFilter) { grimoireTypeFilter.innerHTML = '<option value="All">All Types</option>'; cardTypeKeys.forEach(type => { const option = document.createElement('option'); option.value = type; option.textContent = type; grimoireTypeFilter.appendChild(option); }); } if (grimoireElementFilter) { grimoireElementFilter.innerHTML = '<option value="All">All Elements</option>'; elementNames.forEach(fullName => { const name = elementDetails[fullName]?.name || fullName; const option = document.createElement('option'); option.value = fullName; option.textContent = name; grimoireElementFilter.appendChild(option); }); }
}
function updateGrimoireCounter() { if (grimoireCountSpan) grimoireCountSpan.textContent = discoveredConcepts.size; }

// --- Card Rendering Function ---
function renderCard(concept, context = 'grimoire') {
    if (!checkDataLoaded()) return document.createElement('div');
    if (!concept || !concept.id) { return document.createElement('div'); } if (typeof elementKeyToFullName === 'undefined') { return document.createElement('div');} const cardDiv = document.createElement('div'); cardDiv.classList.add('concept-card'); cardDiv.classList.add(`rarity-${concept.rarity || 'common'}`); cardDiv.dataset.conceptId = concept.id; cardDiv.title = `View ${concept.name}`; const discoveredData = discoveredConcepts.get(concept.id); const isDiscovered = !!discoveredData; const isFocused = focusedConcepts.has(concept.id); const artUnlocked = discoveredData?.artUnlocked || false; const grimoireStampHTML = isDiscovered ? '<span class="grimoire-stamp" title="In Grimoire"><i class="fas fa-book-open"></i></span>' : ''; const focusStampHTML = isFocused ? '<span class="focus-indicator" title="Focused Concept">★</span>' : ''; const cardTypeIcon = getCardTypeIcon(concept.cardType); let affinitiesHTML = ''; if (concept.elementScores && typeof elementKeyToFullName !== 'undefined') { Object.entries(concept.elementScores).forEach(([key, score]) => { const level = getAffinityLevel(score); if (level && elementKeyToFullName[key]) { const fullName = elementKeyToFullName[key]; const color = getElementColor(fullName); const levelClass = level === "High" ? "affinity-high" : ""; const iconClass = getElementIcon(fullName); affinitiesHTML += `<span class="affinity ${levelClass}" style="border-color: ${color}; color: ${color}; background-color: ${hexToRgba(color, 0.1)};" title="${elementDetails[fullName]?.name || fullName} Affinity: ${level} (${score.toFixed(1)})"><i class="${iconClass}"></i> ${level.substring(0,1)}</span> `; } }); } const currentVisualHandle = artUnlocked ? (concept.visualHandleUnlocked || concept.visualHandle) : concept.visualHandle; const visualContent = artUnlocked && concept.visualHandleUnlocked ? `<img src="placeholder_art/${concept.visualHandleUnlocked}.png" alt="${concept.name} Art" class="card-art-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"> <i class="fas fa-image card-visual-placeholder" style="display: none;" title="Art Placeholder"></i>` : `<i class="fas fa-${artUnlocked ? 'star' : 'question'} card-visual-placeholder ${artUnlocked ? 'card-art-unlocked' : ''}" title="${currentVisualHandle || 'Visual Placeholder'}"></i>`; cardDiv.innerHTML = ` <div class="card-header"> <i class="${cardTypeIcon} card-type-icon" title="${concept.cardType}"></i> <span class="card-name">${concept.name}</span> <span class="card-stamps">${focusStampHTML}${grimoireStampHTML}</span> </div> <div class="card-visual"> ${visualContent} </div> <div class="card-footer"> <div class="card-affinities">${affinitiesHTML || '<small style="color:#888; font-style: italic;">Basic Affinity</small>'}</div> <p class="card-brief-desc">${concept.briefDescription || '...'}</p> </div>`; if (context !== 'no-click') { cardDiv.addEventListener('click', () => showConceptDetailPopup(concept.id)); } if (context === 'research-output') { cardDiv.title = `Click to view details for ${concept.name} (Not yet in Grimoire)`; } return cardDiv;
}

// --- Concept Detail Pop-up Logic ---
function showConceptDetailPopup(conceptId) {
    if (!checkDataLoaded()) return;
    const conceptData = concepts.find(c => c.id === conceptId); const discoveredData = discoveredConcepts.get(conceptId); if (!conceptData) { return; } currentlyDisplayedConceptId = conceptId; if (popupConceptName) popupConceptName.textContent = conceptData.name; if (popupConceptType) popupConceptType.textContent = conceptData.cardType; if (popupCardTypeIcon) popupCardTypeIcon.className = `${getCardTypeIcon(conceptData.cardType)} card-type-icon`; if (popupDetailedDescription) popupDetailedDescription.textContent = conceptData.detailedDescription || "No description."; const artUnlocked = discoveredData?.artUnlocked || false; const currentVisualHandle = artUnlocked ? (conceptData.visualHandleUnlocked || concept.visualHandle) : concept.visualHandle; if (popupVisualContainer) { popupVisualContainer.innerHTML = ''; if (artUnlocked && conceptData.visualHandleUnlocked) { const img = document.createElement('img'); img.src = `placeholder_art/${conceptData.visualHandleUnlocked}.png`; img.alt = `${conceptData.name} Art`; img.classList.add('card-art-image'); img.onerror = function() { this.style.display='none'; const icon = document.createElement('i'); icon.className = `fas fa-image card-visual-placeholder`; icon.title = "Art Placeholder (Load Failed)"; popupVisualContainer.appendChild(icon); }; popupVisualContainer.appendChild(img); } else { const icon = document.createElement('i'); icon.className = `fas fa-${artUnlocked ? 'star card-art-unlocked' : 'question'} card-visual-placeholder`; icon.title = currentVisualHandle || "Visual Placeholder"; if (artUnlocked) icon.classList.add('card-art-unlocked'); popupVisualContainer.appendChild(icon); } } const distance = euclideanDistance(userScores, conceptData.elementScores); displayPopupResonance(distance); displayPopupRecipeComparison(conceptData); displayPopupRelatedConcepts(conceptData); if (myNotesSection && myNotesTextarea && saveMyNoteButton) { if (discoveredData) { myNotesTextarea.value = discoveredData.notes || ""; myNotesSection.classList.remove('hidden'); noteSaveStatusSpan.textContent = ""; saveMyNoteButton.onclick = () => saveMyNote(conceptId); } else { myNotesSection.classList.add('hidden'); } } displayEvolutionSection(conceptData, discoveredData); updateGrimoireButtonStatus(conceptId); updateFocusButtonStatus(conceptId); if (conceptDetailPopup) conceptDetailPopup.classList.remove('hidden'); if (popupOverlay) popupOverlay.classList.remove('hidden');
}
function displayPopupResonance(distance) { if (!popupResonanceSummary) return; let resonanceLabel = "Low"; let resonanceClass = "resonance-low"; let message = ""; if (distance === Infinity || isNaN(distance)) { resonanceLabel = "N/A"; resonanceClass = ""; message = "(Cannot compare profiles)"; } else if (distance < 2.5) { resonanceLabel = "Very High"; resonanceClass = "resonance-high"; message = "Strongly aligns with your core profile."; } else if (distance < 4.0) { resonanceLabel = "High"; resonanceClass = "resonance-high"; message = "Shares significant common ground."; } else if (distance < 6.0) { resonanceLabel = "Moderate"; resonanceClass = "resonance-medium"; message = "Some similarities and differences noted."; } else if (distance <= DISSONANCE_THRESHOLD) { resonanceLabel = "Low"; resonanceClass = "resonance-low"; message = "Notable divergence from your profile."; } else { resonanceLabel = "Dissonant"; resonanceClass = "resonance-low"; message = "Significantly diverges. Reflection suggested if added."; } popupResonanceSummary.innerHTML = `Resonance with You: <span class="resonance-indicator ${resonanceClass}">${resonanceLabel}</span> (Dist: ${distance.toFixed(1)})<br><small>${message}</small>`; }
function displayPopupRecipeComparison(conceptData) {
    if (!checkDataLoaded()) return;
    if (!popupConceptProfile || !popupUserComparisonProfile || !popupComparisonHighlights) return; if (typeof elementKeyToFullName === 'undefined') return; popupConceptProfile.innerHTML = ''; popupUserComparisonProfile.innerHTML = ''; popupComparisonHighlights.innerHTML = ''; let highlightsHTML = '<p><strong>Key Alignments & Differences:</strong></p>'; let hasHighlights = false; const conceptScores = conceptData.elementScores || {}; const userCompScores = userScores || {}; elementNames.forEach(elName => { const key = elementNameToKey[elName]; const fullName = elementKeyToFullName[key]; if (!fullName) return; const conceptScore = conceptScores[key]; const userScore = userCompScores[key]; const conceptScoreValid = typeof conceptScore === 'number' && !isNaN(conceptScore); const userScoreValid = typeof userScore === 'number' && !isNaN(userScore); const conceptDisplay = conceptScoreValid ? conceptScore.toFixed(1) : '?'; const userDisplay = userScoreValid ? userScore.toFixed(1) : '?'; const conceptLabel = conceptScoreValid ? getScoreLabel(conceptScore) : 'N/A'; const userLabel = userScoreValid ? getScoreLabel(userScore) : 'N/A'; const conceptBarWidth = conceptScoreValid ? (conceptScore / 10) * 100 : 0; const userBarWidth = userScoreValid ? (userScore / 10) * 100 : 0; const color = getElementColor(fullName); const elementNameShort = elementDetails[fullName]?.name.substring(0, 11) || elName; popupConceptProfile.innerHTML += `<div><strong>${elementNameShort}:</strong> <span>${conceptDisplay}</span> <div class="score-bar-container" title="${conceptLabel}"><div style="width: ${conceptBarWidth}%; background-color: ${color};"></div></div></div>`; popupUserComparisonProfile.innerHTML += `<div><strong>${elementNameShort}:</strong> <span>${userDisplay}</span> <div class="score-bar-container" title="${userLabel}"><div style="width: ${userBarWidth}%; background-color: ${color};"></div></div></div>`; if (conceptScoreValid && userScoreValid) { const diff = Math.abs(conceptScore - userScore); const elementNameDisplay = elementDetails[fullName]?.name || elName; if (conceptScore >= 7 && userScore >= 7) { highlightsHTML += `<p>• <strong class="match">Strong Alignment</strong> in ${elementNameDisplay} (Both ${conceptLabel} / ${userLabel})</p>`; hasHighlights = true; } else if (conceptScore <= 3 && userScore <= 3) { highlightsHTML += `<p>• <strong class="match">Shared Low Emphasis</strong> in ${elementNameDisplay} (Both ${conceptLabel} / ${userLabel})</p>`; hasHighlights = true; } else if (diff >= 4) { highlightsHTML += `<p>• <strong class="mismatch">Notable Difference</strong> in ${elementNameDisplay} (Concept is ${conceptLabel}, You are ${userLabel})</p>`; hasHighlights = true; } } }); if (!hasHighlights) highlightsHTML += '<p><em>No strong alignments or major differences identified.</em></p>'; popupComparisonHighlights.innerHTML = highlightsHTML;
}
function displayPopupRelatedConcepts(conceptData) {
    if (!checkDataLoaded()) return;
    if (!popupRelatedConceptsList) return; popupRelatedConceptsList.innerHTML = ''; if (conceptData.relatedIds && conceptData.relatedIds.length > 0) { conceptData.relatedIds.forEach(relatedId => { const relatedConcept = concepts.find(c => c.id === relatedId); if (relatedConcept) { const li = document.createElement('li'); li.textContent = relatedConcept.name; li.dataset.conceptId = relatedId; li.title = `View ${relatedConcept.name}`; li.addEventListener('click', handleRelatedConceptClick); popupRelatedConceptsList.appendChild(li); } }); } else { popupRelatedConceptsList.innerHTML = '<li>None specified</li>'; }
}
function handleRelatedConceptClick(event) { const conceptId = event.target.dataset.conceptId; if (!conceptId) return; const numericId = parseInt(conceptId); if (!isNaN(numericId)) { showConceptDetailPopup(numericId); } }
function displayEvolutionSection(conceptData, discoveredData) {
    if (!checkDataLoaded()) return;
    if (!popupEvolutionSection || !evolveArtButton || !evolveEligibility || !evolveCostSpan) return; if (typeof elementKeyToFullName === 'undefined') return; const isDiscovered = !!discoveredData; const canUnlock = conceptData.canUnlockArt; const alreadyUnlocked = discoveredData?.artUnlocked || false; const isFocused = focusedConcepts.has(conceptData.id); const requiredElement = conceptData.primaryElement; const fullName = elementKeyToFullName[requiredElement]; if (!fullName) { popupEvolutionSection.classList.add('hidden'); return; } const cost = ART_EVOLVE_COST; const hasEnoughInsight = userInsight >= cost; const hasReflected = seenPrompts.size > 0; evolveCostSpan.textContent = `${cost} Insight`; if (isDiscovered && canUnlock && !alreadyUnlocked) { popupEvolutionSection.classList.remove('hidden'); let eligibilityText = ''; let canEvolve = true; if (!isFocused) { eligibilityText += '<li>Requires: Mark as Focus Concept</li>'; canEvolve = false; } else { eligibilityText += '<li><i class="fas fa-check"></i> Focused Concept</li>'; } if (!hasReflected) { eligibilityText += '<li>Requires: Engage in Reflection (any)</li>'; canEvolve = false; } else { eligibilityText += '<li><i class="fas fa-check"></i> Reflection Engaged</li>'; } if (!hasEnoughInsight) { eligibilityText += `<li>Requires: ${cost} Insight (Have ${userInsight.toFixed(1)})</li>`; canEvolve = false;} else { eligibilityText += `<li><i class="fas fa-check"></i> Sufficient Insight</li>`; } evolveEligibility.innerHTML = `<ul>${eligibilityText}</ul>`; evolveEligibility.classList.remove('hidden'); evolveArtButton.disabled = !canEvolve; evolveArtButton.onclick = canEvolve ? () => attemptArtEvolution(conceptData.id, cost) : null; } else { popupEvolutionSection.classList.add('hidden'); evolveArtButton.disabled = true; evolveEligibility.classList.add('hidden'); evolveArtButton.onclick = null; }
}
function attemptArtEvolution(conceptId, cost) {
    if (!checkDataLoaded()) return;
    const discoveredData = discoveredConcepts.get(conceptId); if (!discoveredData || !discoveredData.concept || discoveredData.artUnlocked) { showTemporaryMessage("Evolution failed: Concept state error.", 3000); return; } const concept = discoveredData.concept; if (!concept.canUnlockArt) { return; } const isFocused = focusedConcepts.has(conceptId); const hasReflected = seenPrompts.size > 0; if (isFocused && hasReflected && spendInsight(cost, `Evolve Art: ${concept.name}`)) { discoveredData.artUnlocked = true; discoveredConcepts.set(conceptId, discoveredData); console.log(`Art unlocked for ${concept.name}!`); showTemporaryMessage(`Enhanced Art Unlocked for ${concept.name}!`, 3500); if (currentlyDisplayedConceptId === conceptId) { displayEvolutionSection(concept, discoveredData); if (popupVisualContainer) { popupVisualContainer.innerHTML = ''; if (discoveredData.artUnlocked && concept.visualHandleUnlocked) { const img = document.createElement('img'); img.src = `placeholder_art/${concept.visualHandleUnlocked}.png`; img.alt = `${concept.name} Art`; img.classList.add('card-art-image'); img.onerror = function() { this.style.display='none'; const icon = document.createElement('i'); icon.className = `fas fa-image card-visual-placeholder`; icon.title = "Art Placeholder (Load Failed)"; popupVisualContainer.appendChild(icon); }; popupVisualContainer.appendChild(img); } else { const icon = document.createElement('i'); icon.className = `fas fa-star card-visual-placeholder card-art-unlocked`; icon.title = concept.visualHandleUnlocked || concept.visualHandle || "Unlocked Visual"; popupVisualContainer.appendChild(icon); } } } if (grimoireScreen.classList.contains('current')) { displayGrimoire(grimoireTypeFilter.value, grimoireElementFilter.value, grimoireSortOrder.value, grimoireRarityFilter.value); } gainAttunementForAction('artEvolve', concept.primaryElement, 1.5); updateMilestoneProgress('evolveArt', 1); checkAndUpdateRituals('evolveArt'); saveGameState(); } else if (!isFocused || !hasReflected) { showTemporaryMessage("Cannot unlock art yet. Check requirements.", 3000); }
}

// --- Grimoire/Focus Button & State Logic ---
function addConceptToGrimoireById(conceptId, buttonElement) {
    if (!checkDataLoaded()) return;
    if (discoveredConcepts.has(conceptId)) { showTemporaryMessage("Already in Grimoire.", 2500); if(buttonElement) { buttonElement.textContent = "In Grimoire"; buttonElement.disabled = true; } return; } const concept = concepts.find(c => c.id === conceptId); if (!concept) { return; } const distance = euclideanDistance(userScores, concept.elementScores); if (distance > DISSONANCE_THRESHOLD) { console.log(`Dissonance detected for ${concept.name}. Triggering reflection.`); reflectionTargetConceptId = conceptId; displayReflectionPrompt('Dissonance', concept.id); } else { addConceptToGrimoireInternal(conceptId); if(buttonElement) { buttonElement.textContent = "In Grimoire"; buttonElement.disabled = true; } }
}
function addToGrimoire() { if (currentlyDisplayedConceptId === null) return; addConceptToGrimoireById(currentlyDisplayedConceptId, addToGrimoireButton); }
function addConceptToGrimoireInternal(conceptId) {
    if (!checkDataLoaded()) return;
    const concept = concepts.find(c => c.id === conceptId); if (!concept) { return; } if (discoveredConcepts.has(conceptId)) { return; } console.log(`Adding ${concept.name} to Grimoire (Internal).`); discoveredConcepts.set(conceptId, { concept: concept, discoveredTime: Date.now(), artUnlocked: false, notes: "" }); gainInsight(2.0, `Discovered ${concept.name}`); gainAttunementForAction('addToGrimoire', concept.primaryElement, 0.6); updateGrimoireCounter(); if (currentlyDisplayedConceptId === conceptId) { updateGrimoireButtonStatus(concept.id); updateFocusButtonStatus(concept.id); if(myNotesSection) myNotesSection.classList.remove('hidden'); } checkTriggerReflectionPrompt('add'); updateMilestoneProgress('addToGrimoire', 1); updateMilestoneProgress('discoveredConcepts.size', discoveredConcepts.size); checkAndUpdateRituals('addToGrimoire'); if (grimoireScreen.classList.contains('current')) { displayGrimoire(grimoireTypeFilter.value, grimoireElementFilter.value, grimoireSortOrder.value, grimoireRarityFilter.value); } if (currentReflectionContext === 'Dissonance' && researchOutput && !researchOutput.classList.contains('hidden')) { const researchButton = researchOutput.querySelector(`.research-action-button[data-concept-id="${conceptId}"]`); if (researchButton) { researchButton.textContent = "In Grimoire"; researchButton.disabled = true; } } showTemporaryMessage(`${concept.name} added to Grimoire!`, 3000); saveGameState();
}
function toggleFocusConcept() {
    if (!checkDataLoaded()) return;
    if (currentlyDisplayedConceptId === null) return; const discoveredData = discoveredConcepts.get(currentlyDisplayedConceptId); if (!discoveredData || !discoveredData.concept) { showTemporaryMessage("Cannot focus undiscovered concept.", 3000); return; } const concept = discoveredData.concept; if (focusedConcepts.has(concept.id)) { focusedConcepts.delete(concept.id); console.log(`Removed ${concept.name} from Focus.`); showTemporaryMessage(`${concept.name} removed from Focus.`, 2500); checkAndUpdateRituals('removeFocus'); } else { if (focusedConcepts.size >= focusSlotsTotal) { showTemporaryMessage(`Focus slots full (${focusedConcepts.size}/${focusSlotsTotal}).`, 3000); return; } focusedConcepts.add(concept.id); console.log(`Marked ${concept.name} as Focus.`); showTemporaryMessage(`${concept.name} marked as Focus!`, 2500); gainInsight(1.0, `Focused on ${concept.name}`); gainAttunementForAction('markFocus', concept.primaryElement, 1.0); updateMilestoneProgress('markFocus', 1); updateMilestoneProgress('focusedConcepts.size', focusedConcepts.size); checkAndUpdateRituals('markFocus'); } updateFocusButtonStatus(concept.id); displayFocusedConceptsPersona(); updateFocusElementalResonance(); generateTapestryNarrative(); synthesizeAndDisplayThemesPersona(); if (grimoireScreen.classList.contains('current')) { displayGrimoire(grimoireTypeFilter.value, grimoireElementFilter.value, grimoireSortOrder.value, grimoireRarityFilter.value); } saveGameState();
}
function updateGrimoireButtonStatus(conceptId) { if (!addToGrimoireButton) return; const isDiscovered = discoveredConcepts.has(conceptId); addToGrimoireButton.disabled = isDiscovered; addToGrimoireButton.textContent = isDiscovered ? "In Grimoire" : "Add to Grimoire"; addToGrimoireButton.classList.toggle('added', isDiscovered); }
function updateFocusButtonStatus(conceptId) { if (!markAsFocusButton) return; const isDiscovered = discoveredConcepts.has(conceptId); const isFocused = focusedConcepts.has(conceptId); markAsFocusButton.classList.toggle('hidden', !isDiscovered); if (isDiscovered) { markAsFocusButton.textContent = isFocused ? "Remove Focus" : "Mark as Focus"; markAsFocusButton.disabled = !isDiscovered || (focusedConcepts.size >= focusSlotsTotal && !isFocused); markAsFocusButton.classList.toggle('marked', isFocused); if(markAsFocusButton.disabled && !isFocused && isDiscovered) { markAsFocusButton.title = `Focus slots full (${focusSlotsTotal})`; } else if (isDiscovered) { markAsFocusButton.title = isFocused ? "Remove from Focused Concepts" : "Add to Focused Concepts"; } else { markAsFocusButton.title = ""; } } }

// --- My Notes ---
function saveMyNote(conceptId) {
    if (!myNotesTextarea || !noteSaveStatusSpan) return; const noteText = myNotesTextarea.value.trim(); const discoveredData = discoveredConcepts.get(conceptId);
    if (discoveredData) { discoveredData.notes = noteText; discoveredConcepts.set(conceptId, discoveredData); saveGameState(); noteSaveStatusSpan.textContent = "Note Saved!"; noteSaveStatusSpan.classList.remove('error'); setTimeout(() => { noteSaveStatusSpan.textContent = ""; }, 2000); }
    else { noteSaveStatusSpan.textContent = "Error: Concept not found."; noteSaveStatusSpan.classList.add('error'); }
}

// --- Reflection Prompts ---
function checkTriggerReflectionPrompt(triggerAction = 'other') { if (promptCooldownActive) return; if (triggerAction === 'add') cardsAddedSinceLastPrompt++; if (triggerAction === 'completeQuestionnaire') cardsAddedSinceLastPrompt = 99; const triggerThreshold = 3; if (cardsAddedSinceLastPrompt >= triggerThreshold) { displayReflectionPrompt('Standard'); cardsAddedSinceLastPrompt = 0; promptCooldownActive = true; setTimeout(() => { promptCooldownActive = false; console.log("Reflection cooldown ended."); }, 1000 * 60 * 5); } }
function displayReflectionPrompt(context = 'Standard', targetId = null, promptCategory = null) {
    if (!checkDataLoaded()) return;
    currentReflectionContext = context; reflectionTargetConceptId = (context === 'Dissonance') ? targetId : null; let promptPool = []; let titleElement = "Reflection Topic"; let selectedPrompt = null; const nudgeElements = [scoreNudgeCheckbox, scoreNudgeLabel]; if(context === 'Guided') { titleElement = "Guided Reflection"; const categoryPrompts = reflectionPrompts.Guided[promptCategory] || []; const available = categoryPrompts.filter(p => !seenPrompts.has(p.id)); selectedPrompt = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : null; currentReflectionElement = promptCategory; nudgeElements.forEach(el => el?.classList.add('hidden')); if(!selectedPrompt) { console.warn(`No unseen guided prompts for ${promptCategory}`); gainInsight(GUIDED_REFLECTION_COST, "Refund: No guided prompts"); showTemporaryMessage("No new guided reflections available for that topic now.", 3000); return; } } else if (context === 'Dissonance') { promptPool = reflectionPrompts["Dissonance"] || []; const targetConcept = concepts.find(c => c.id === targetId); titleElement = targetConcept ? `${targetConcept.name} (Dissonant)` : "a Challenging Concept"; nudgeElements.forEach(el => el?.classList.remove('hidden')); } else { titleElement = "Standard Reflection"; let possibleElements = elementNames.filter(elName => reflectionPrompts[elName] && reflectionPrompts[elName].length > 0); if (possibleElements.length > 0) { const targetElementName = possibleElements[Math.floor(Math.random() * possibleElements.length)]; promptPool = reflectionPrompts[targetElementName] || []; currentReflectionElement = targetElementName; titleElement = elementDetails[targetElementName]?.name || targetElementName; } nudgeElements.forEach(el => el?.classList.add('hidden')); } if (!selectedPrompt && promptPool.length > 0) { const availablePrompts = promptPool.filter(p => !seenPrompts.has(p.id)); selectedPrompt = availablePrompts.length > 0 ? availablePrompts[Math.floor(Math.random() * availablePrompts.length)] : promptPool[Math.floor(Math.random() * promptPool.length)]; } if (!selectedPrompt) { console.error(`Could not select prompt for context: ${context}`); return; } currentPromptId = selectedPrompt.id; if(reflectionModalTitle) reflectionModalTitle.textContent = titleElement; if (reflectionElement) reflectionElement.textContent = (context === 'Dissonance' || context === 'Guided') ? titleElement : currentReflectionElement; if (reflectionPromptText) reflectionPromptText.textContent = selectedPrompt.text; if (reflectionCheckbox) reflectionCheckbox.checked = false; if (scoreNudgeCheckbox) scoreNudgeCheckbox.checked = false; if (confirmReflectionButton) confirmReflectionButton.disabled = true; const rewardAmount = (context === 'Guided') ? GUIDED_REFLECTION_COST + 2 : 5.0; if (reflectionRewardAmount) reflectionRewardAmount.textContent = `${rewardAmount} Insight`; if (reflectionModal) reflectionModal.classList.remove('hidden'); if (popupOverlay) popupOverlay.classList.remove('hidden');
}
function handleConfirmReflection() {
    if (!checkDataLoaded()) return;
    if (!currentPromptId || !reflectionCheckbox || !reflectionCheckbox.checked) return; console.log(`Reflection confirmed: ${currentReflectionContext}, prompt: ${currentPromptId}`); seenPrompts.add(currentPromptId); const insightReward = (currentReflectionContext === 'Guided') ? GUIDED_REFLECTION_COST + 2 : 5.0; let attunementKey = null; let attunementAmount = 1.0; let milestoneAction = 'completeReflection'; let scoreNudged = false; if (currentReflectionContext === 'Dissonance' && scoreNudgeCheckbox && scoreNudgeCheckbox.checked) { console.log("Score nudge requested."); const concept = concepts.find(c => c.id === reflectionTargetConceptId); if (concept?.elementScores) { for (const key in userScores) { if (userScores.hasOwnProperty(key) && concept.elementScores.hasOwnProperty(key)) { const userScore = userScores[key]; const conceptScore = concept.elementScores[key]; const diff = conceptScore - userScore; if (Math.abs(diff) > 2.0) { const nudge = Math.sign(diff) * SCORE_NUDGE_AMOUNT; userScores[key] = Math.max(0, Math.min(10, userScore + nudge)); scoreNudged = true; } } } if (scoreNudged) { console.log("Updated User Scores:", userScores); displayPersonaScreen(); showTemporaryMessage("Core understanding shifted slightly.", 3500); gainAttunementForAction('scoreNudge', 'All', 0.5); updateMilestoneProgress('scoreNudgeApplied', 1); } } } if (currentReflectionContext === 'Dissonance' && reflectionTargetConceptId !== null) { addConceptToGrimoireInternal(reflectionTargetConceptId); milestoneAction = 'completeReflectionDissonance'; attunementAmount = 0.5; } gainInsight(insightReward, `Reflection (${currentReflectionContext})`); if (currentReflectionContext === 'Standard' && currentReflectionElement) { attunementKey = elementNameToKey[currentReflectionElement]; } else if (currentReflectionContext === 'Guided') { attunementKey = elementNameToKey[currentReflectionElement] || null; } else { attunementKey = null; } if (attunementKey) { gainAttunementForAction('completeReflection', attunementKey, attunementAmount); } else { gainAttunementForAction('completeReflectionGeneric', 'All', 0.2); } updateMilestoneProgress(milestoneAction, 1); checkAndUpdateRituals('completeReflection'); hidePopups(); showTemporaryMessage("Reflection complete! Insight gained.", 3000); currentReflectionContext = null; reflectionTargetConceptId = null; saveGameState();
}
function triggerGuidedReflection() {
    if (!checkDataLoaded()) return;
    if (spendInsight(GUIDED_REFLECTION_COST, "Guided Reflection")) { const availableCategories = Object.keys(reflectionPrompts.Guided || {}); if (availableCategories.length > 0) { const category = availableCategories[Math.floor(Math.random() * availableCategories.length)]; console.log(`Triggering guided reflection for category: ${category}`); displayReflectionPrompt('Guided', null, category); } else { console.warn("No guided reflection categories defined."); gainInsight(GUIDED_REFLECTION_COST, "Refund: No guided reflections"); } }
}

// --- Rituals & Milestones ---
function displayDailyRituals() { if (!checkDataLoaded() || !dailyRitualsDisplay) return; dailyRitualsDisplay.innerHTML = ''; if (!dailyRituals || dailyRituals.length === 0) { dailyRitualsDisplay.innerHTML = '<li>No daily rituals defined.</li>'; return; } dailyRituals.forEach(ritual => { const completedData = completedRituals.daily[ritual.id] || {completed: false, progress: 0}; const isCompleted = completedData.completed; const li = document.createElement('li'); li.classList.toggle('completed', isCompleted); let rewardText = ''; if (ritual.reward) { if (ritual.reward.type === 'insight') rewardText = `(+${ritual.reward.amount} <i class="fas fa-brain insight-icon"></i>)`; else if (ritual.reward.type === 'attunement') rewardText = `(+${ritual.reward.amount} Attun.)`; else if (ritual.reward.type === 'token') rewardText = `(+1 ${ritual.reward.tokenType || 'Token'})`; } li.innerHTML = `${ritual.description} <span class="ritual-reward">${rewardText}</span>`; dailyRitualsDisplay.appendChild(li); }); }
function checkAndUpdateRituals(action, details = {}) {
    if (!checkDataLoaded()) return;
    let ritualUpdated = false; dailyRituals.forEach(ritual => { let completedData = completedRituals.daily[ritual.id] || {completed: false, progress: 0}; if (!completedData.completed && ritual.track.action === action) { completedData.progress++; if (completedData.progress >= ritual.track.count) { console.log(`Ritual Completed: ${ritual.description}`); completedData.completed = true; ritualUpdated = true; if (ritual.reward) { if (ritual.reward.type === 'insight') { gainInsight(ritual.reward.amount || 0, `Ritual: ${ritual.description}`); } else if (ritual.reward.type === 'attunement') { gainAttunementForAction('ritual', ritual.reward.element || 'All', ritual.reward.amount || 0); } else if (ritual.reward.type === 'token') { console.log(`TODO: Grant ${ritual.reward.tokenType || 'Research'} token`); } } } completedRituals.daily[ritual.id] = completedData; } }); if (ritualUpdated) { displayDailyRituals(); saveGameState(); }
}
function displayMilestones() {
    if (!checkDataLoaded() || !milestonesDisplay) return;
    milestonesDisplay.innerHTML = ''; if (achievedMilestones.size === 0) { milestonesDisplay.innerHTML = '<li>No milestones achieved yet.</li>'; return; } const sortedMilestoneIds = Array.from(achievedMilestones).sort((a, b) => { const ma = milestones.find(m => m.id === a); const mb = milestones.find(m => m.id === b); return (ma?.id || '').localeCompare(mb?.id || ''); }); sortedMilestoneIds.forEach(milestoneId => { const milestone = milestones.find(m => m.id === milestoneId); if (milestone) { const li = document.createElement('li'); li.textContent = `✓ ${milestone.description}`; milestonesDisplay.appendChild(li); } });
}
function updateMilestoneProgress(trackType, currentValue) {
    if (!checkDataLoaded()) return;
    let milestoneAchieved = false; milestones.forEach(m => { if (!achievedMilestones.has(m.id)) { let achieved = false; if (m.track.action === trackType) { if (typeof currentValue === 'number' && currentValue >= (m.track.count || 1)) { achieved = true; } else if (m.track.count === 1 && currentValue) { achieved = true; } } else if (m.track.state === trackType) { const threshold = m.track.threshold; if (m.track.condition === "any") { if (typeof currentValue === 'object' && currentValue !== null) { for (const key in currentValue) { if ((elementAttunement.hasOwnProperty(key) || unlockedDeepDiveLevels.hasOwnProperty(key)) && currentValue[key] >= threshold) { achieved = true; break; } } } } else if (m.track.condition === "all") { if (typeof currentValue === 'object' && currentValue !== null) { let allMet = true; let targetObject = (trackType === 'elementAttunement' ? elementAttunement : unlockedDeepDiveLevels); for (const key in targetObject) { if (!(currentValue.hasOwnProperty(key) && currentValue[key] >= threshold)) { allMet = false; break; } } if (allMet) achieved = true; } } else { if (typeof currentValue === 'number' && currentValue >= threshold) { achieved = true; } } } if (achieved) { console.log("Milestone Achieved!", m.description); achievedMilestones.add(m.id); milestoneAchieved = true; displayMilestones(); showMilestoneAlert(m.description); if (m.reward) { if (m.reward.type === 'insight') { gainInsight(m.reward.amount || 0, `Milestone: ${m.description}`); } else if (m.reward.type === 'attunement') { gainAttunementForAction('milestone', m.reward.element || 'All', m.reward.amount || 0); } else if (m.reward.type === 'increaseFocusSlots') { const increaseAmount = m.reward.amount || 1; if (focusSlotsTotal < MAX_FOCUS_SLOTS) { focusSlotsTotal = Math.min(MAX_FOCUS_SLOTS, focusSlotsTotal + increaseAmount); console.log(`Focus Slots increased by ${increaseAmount}. New: ${focusSlotsTotal}`); updateFocusSlotsDisplay(); } } else if (m.reward.type === 'discoverCard') { const cardIdToDiscover = m.reward.cardId; if (cardIdToDiscover && !discoveredConcepts.has(cardIdToDiscover)) { const conceptToDiscover = concepts.find(c => c.id === cardIdToDiscover); if (conceptToDiscover) { addConceptToGrimoireInternal(cardIdToDiscover); showTemporaryMessage(`Milestone Reward: Discovered ${conceptToDiscover.name}!`, 3500); } } } } } } }); if (['focusedConcepts.size', 'increaseFocusSlots', 'unlockedDeepDiveLevels'].includes(trackType)) { updateMilestoneProgress('focusSlotsTotal', focusSlotsTotal); } if (milestoneAchieved) { saveGameState(); }
}
function showMilestoneAlert(text) { if (!milestoneAlert || !milestoneAlertText) return; milestoneAlertText.textContent = `Milestone: ${text}`; milestoneAlert.classList.remove('hidden'); setTimeout(hideMilestoneAlert, 5000); }
function hideMilestoneAlert() { if (milestoneAlert) milestoneAlert.classList.add('hidden'); }

// --- Element Deep Dive Library ---
function displayElementLibrary() {
    if (!checkDataLoaded() || !elementLibraryButtonsDiv || !elementLibraryContentDiv) return;
    elementLibraryButtonsDiv.innerHTML = ''; elementNames.forEach(elName => { const key = elementNameToKey[elName]; const button = document.createElement('button'); button.classList.add('button', 'small-button'); button.textContent = elementDetails[elName]?.name || elName; button.style.borderColor = getElementColor(elName); button.onclick = () => displayElementDeepDive(key); elementLibraryButtonsDiv.appendChild(button); });
    // Check if content already exists, if not, show default message
    if (!elementLibraryContentDiv.querySelector('.library-level') && !elementLibraryContentDiv.querySelector('.library-unlock')) {
        elementLibraryContentDiv.innerHTML = '<p>Select an Element above to view its deep dive content.</p>';
    }
}
function displayElementDeepDive(elementKey) {
    if (!checkDataLoaded() || !elementLibraryContentDiv) return;
    const deepDiveData = elementDeepDive[elementKey] || []; const currentLevel = unlockedDeepDiveLevels[elementKey] || 0; const elementName = elementKeyToFullName[elementKey] || elementKey; elementLibraryContentDiv.innerHTML = `<h4>${elementDetails[elementName]?.name || elementName} - Insights</h4>`; if (deepDiveData.length === 0) { elementLibraryContentDiv.innerHTML += '<p>No deep dive content available.</p>'; return; } let displayedContent = false; deepDiveData.forEach(levelData => { if (levelData.level <= currentLevel) { elementLibraryContentDiv.innerHTML += `<div class="library-level"><h5 class="level-title">${levelData.title} (Level ${levelData.level})</h5><div class="level-content">${levelData.content}</div></div><hr class="popup-hr">`; displayedContent = true; } }); if (!displayedContent) { elementLibraryContentDiv.innerHTML += '<p>Unlock the first level to begin exploring.</p>'; } const nextLevel = currentLevel + 1; const nextLevelData = deepDiveData.find(l => l.level === nextLevel); if (nextLevelData) { const cost = nextLevelData.insightCost || 0; const canAfford = userInsight >= cost; const requirementsMet = true; elementLibraryContentDiv.innerHTML += `<div class="library-unlock"><h5>Next: ${nextLevelData.title} (Level ${nextLevelData.level})</h5><button class="button small-button unlock-button" onclick="unlockDeepDiveLevel('${elementKey}', ${nextLevelData.level})" ${!canAfford || !requirementsMet ? 'disabled' : ''} title="${!canAfford ? `Requires ${cost} Insight` : !requirementsMet ? 'Requirements not met' : `Unlock for ${cost} Insight`}"><Unlock (Cost: ${cost} <i class="fas fa-brain insight-icon"></i>)</button>${!canAfford ? `<p class='unlock-error'>Insufficient Insight (${userInsight.toFixed(1)}/${cost})</p>` : ''}${!requirementsMet && canAfford ? `<p class='unlock-error'>Other requirements not met.</p>` : ''}</div>`; } else if (displayedContent) { elementLibraryContentDiv.innerHTML += '<p><i>You have unlocked all available insights for this element.</i></p>'; }
}
function unlockDeepDiveLevel(elementKey, levelToUnlock) {
    if (!checkDataLoaded()) return;
    const deepDiveData = elementDeepDive[elementKey] || []; const levelData = deepDiveData.find(l => l.level === levelToUnlock); const currentLevel = unlockedDeepDiveLevels[elementKey] || 0; if (!levelData || levelToUnlock !== currentLevel + 1) { return; } const cost = levelData.insightCost || 0; if (spendInsight(cost, `Unlock Library: ${elementKeyToFullName[elementKey]} Lv ${levelToUnlock}`)) { unlockedDeepDiveLevels[elementKey] = levelToUnlock; console.log(`Unlocked ${elementKeyToFullName[elementKey]} deep dive level ${levelToUnlock}`); displayElementDeepDive(elementKey); saveGameState(); showTemporaryMessage(`${elementKeyToFullName[elementKey]} Insight Level ${levelToUnlock} Unlocked!`, 3000); updateMilestoneProgress('unlockLibrary', levelToUnlock); updateMilestoneProgress('unlockedDeepDiveLevels', unlockedDeepDiveLevels); checkAndUpdateRituals('unlockLibrary'); }
}

// --- Toast Message Function ---
function showTemporaryMessage(message, duration = 3000) { if (!toastElement || !toastMessageElement) { console.warn("Toast elements not found, logging message to console:", message); return; } console.info(`Toast: ${message}`); toastMessageElement.textContent = message; if (toastTimeout) { clearTimeout(toastTimeout); } toastElement.classList.remove('hidden'); toastElement.classList.add('visible'); toastTimeout = setTimeout(() => { toastElement.classList.remove('visible'); toastElement.classList.add('hidden'); toastTimeout = null; }, duration); }

// --- Reset App ---
function resetApp() { if (confirm("Reset ALL progress, including scores, Grimoire, and unlocked content? This cannot be undone.")) { console.log("Resetting application..."); clearGameState(); initializeQuestionnaire(true); } }

// --- Daily Login Check ---
function checkForDailyLogin() { const today = new Date().toDateString(); let updatedState = false; if (lastLoginDate !== today) { console.log("First login of the day detected."); completedRituals.daily = {}; lastLoginDate = today; freeResearchAvailableToday = true; updatedState = true; console.log("Daily rituals reset. Free daily research granted."); gainInsight(5.0, "Daily Login Bonus"); showTemporaryMessage("Daily Rituals Reset. Free Research Available!", 3500); displayDailyRituals(); } else { console.log("Already logged in today."); if (!freeResearchAvailableToday && freeResearchButton) { freeResearchButton.disabled = true; freeResearchButton.textContent = "Daily Meditation Performed"; } } displayResearchButtons(); if (updatedState) { saveGameState(); } }

// --- Show Settings Popup ---
function showSettings() { if(settingsPopup) settingsPopup.classList.remove('hidden'); if(popupOverlay) popupOverlay.classList.remove('hidden'); }

// --- Event Listeners (v11.2) ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Fully Loaded. Initializing Persona Alchemy Lab v11.2...");
    if (!checkDataLoaded()) { return; } // Essential check

    // --- Navigation & Core Actions ---
    navButtons.forEach(button => { button.addEventListener('click', () => { const targetScreenId = button.dataset.target; if (!document.getElementById(targetScreenId)) { return; } if (targetScreenId === 'personaScreen') { displayPersonaScreen(); } if (targetScreenId === 'studyScreen') { displayStudyScreenContent(); } if (targetScreenId === 'grimoireScreen') { displayGrimoire(grimoireTypeFilter.value, grimoireElementFilter.value, grimoireSortOrder.value, grimoireRarityFilter.value); } showScreen(targetScreenId); }); });
    if (startButton) { startButton.addEventListener('click', () => { initializeQuestionnaire(true); if(loadButton) loadButton.classList.add('hidden'); }); } else { console.error("Start button not found!"); }
    if (loadButton) { loadButton.onclick = () => { if(loadGameState()){ if (currentElementIndex >= elementNames.length) { console.log("Resuming existing session after load button click."); checkForDailyLogin(); updateInsightDisplays(); updateFocusSlotsDisplay(); updateGrimoireCounter(); populateGrimoireFilters(); displayPersonaScreen(); displayStudyScreenContent(); displayDailyRituals(); displayMilestones(); showScreen('personaScreen'); } else { console.log("Saved state incomplete. Restarting setup after load."); initializeQuestionnaire(true); } loadButton.classList.add('hidden'); } }; }
    if (nextElementButton) nextElementButton.addEventListener('click', nextElement); else console.error("Next button not found!");
    if (prevElementButton) prevElementButton.addEventListener('click', prevElement); else console.error("Prev button not found!");
    if (settingsButton) settingsButton.addEventListener('click', showSettings); else console.error("Settings button not found!");

    // --- Popups & Modals ---
    if (closePopupButton) closePopupButton.addEventListener('click', hidePopups); else console.error("Close Popup button not found!");
    if (popupOverlay) popupOverlay.addEventListener('click', hidePopups); else console.error("Popup Overlay not found!");
    if (closeReflectionModalButton) closeReflectionModalButton.addEventListener('click', hidePopups); else console.error("Close Reflection Modal button not found!");
    if (closeSettingsPopupButton) closeSettingsPopupButton.addEventListener('click', hidePopups); else console.error("Close Settings Popup button not found!");
    if (closeMilestoneAlertButton) closeMilestoneAlertButton.addEventListener('click', hideMilestoneAlert); else console.error("Close Milestone Alert button not found!");

    // --- Concept Interaction & Notes ---
    if (addToGrimoireButton) addToGrimoireButton.addEventListener('click', addToGrimoire); else console.error("Add to Grimoire button not found!");
    if (markAsFocusButton) markAsFocusButton.addEventListener('click', toggleFocusConcept); else console.error("Mark as Focus button not found!");
    // Note save listener added dynamically in showConceptDetailPopup

    // --- Grimoire Filters ---
    const grimoireRefresh = () => { if (!grimoireScreen.classList.contains('hidden')) { displayGrimoire(grimoireTypeFilter.value, grimoireElementFilter.value, grimoireSortOrder.value, grimoireRarityFilter.value); } };
    if (grimoireTypeFilter) grimoireTypeFilter.addEventListener('change', grimoireRefresh); else console.error("Grimoire Type filter not found!");
    if (grimoireElementFilter) grimoireElementFilter.addEventListener('change', grimoireRefresh); else console.error("Grimoire Element filter not found!");
    if (grimoireRarityFilter) grimoireRarityFilter.addEventListener('change', grimoireRefresh); else console.error("Grimoire Rarity filter not found!");
    if (grimoireSortOrder) grimoireSortOrder.addEventListener('change', grimoireRefresh); else console.error("Grimoire Sort order not found!");

    // --- Reflection & Guidance ---
    if (reflectionCheckbox) reflectionCheckbox.addEventListener('change', () => { if(confirmReflectionButton) confirmReflectionButton.disabled = !reflectionCheckbox.checked; }); else console.error("Reflection checkbox not found!");
    if (confirmReflectionButton) confirmReflectionButton.addEventListener('click', handleConfirmReflection); else console.error("Confirm Reflection button not found!");
    if (seekGuidanceButton) seekGuidanceButton.addEventListener('click', triggerGuidedReflection); else console.error("Seek Guidance button not found!");

    // --- Settings Popup Actions ---
    if (forceSaveButton) forceSaveButton.addEventListener('click', () => { saveGameState(); showTemporaryMessage("Game Saved!", 1500); }); else console.error("Force Save button not found!");
    if (resetAppButton) resetAppButton.addEventListener('click', resetApp); else console.error("Reset App button not found!");

    // --- Persona View Toggle ---
    if(showDetailedViewBtn) showDetailedViewBtn.addEventListener('click', () => { personaDetailedView?.classList.add('current'); personaDetailedView?.classList.remove('hidden'); personaSummaryView?.classList.add('hidden'); personaSummaryView?.classList.remove('current'); showDetailedViewBtn.classList.add('active'); showSummaryViewBtn?.classList.remove('active'); });
    if(showSummaryViewBtn) showSummaryViewBtn.addEventListener('click', () => { personaSummaryView?.classList.add('current'); personaSummaryView?.classList.remove('hidden'); personaDetailedView?.classList.add('hidden'); personaDetailedView?.classList.remove('current'); showSummaryViewBtn.classList.add('active'); showDetailedViewBtn?.classList.remove('active'); displayPersonaSummary(); });

    // --- INITIAL LOAD LOGIC ---
    if (localStorage.getItem(SAVE_KEY)) { if(loadButton) loadButton.classList.remove('hidden'); showScreen('welcomeScreen'); }
    else { if(loadButton) loadButton.classList.add('hidden'); showScreen('welcomeScreen'); }
    console.log("Initialization complete. Ready.");

}); // --- END OF DOMContentLoaded ---
